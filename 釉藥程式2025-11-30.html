<!DOCTYPE html>
<!-- saved from url=(0069)https://blog-imgs-98.fc2.com/y/u/y/yuyinghuang/2025110417074181e.html -->
<html lang="zh-TW">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>é‡‰è—¥è¨­è¨ˆç¨‹å¼2025.11.30 </title>

</head><body link="#000000" vlink="#008080">

<script>

// Client-side License Protectionï¼ˆå®¢æˆ¶ç«¯æˆæ¬Šä¿è­·ï¼‰: æœ‰äº†core_refer.jså°±å¯ä»¥æŠŠ refer()åˆªé™¤
// Client-side License Protectionï¼ˆå®¢æˆ¶ç«¯æˆæ¬Šä¿è­·ï¼‰: æŠŠå³é‚Š<script>ç§»åˆ°ä¸Šä¸Šä¸Šè¡Œï¼Œä¸¦åˆªé™¤å‡½æ•¸function refer(form)  ï¼Œ  <script src="https://blog-imgs-170.fc2.com/y/u/y/yuyinghuang/core_refer.js"><æ–œç·šscript>




// å…¨åŸŸè®Šæ•¸
segar_mole_noise = new Array(13)
min_mole_noise = new Array(13)
t_noise = new Array(13)
composition_mole_noise = new Array(16)
molecular_weight_noise = new Array(16)
composition_weight_noise = new Array(16)
composition_in_percentage_noise = new Array(16)
composition_in_percentage_int_noise = new Array(16) 
ca_min_noise = 0
mg_min_noise = 0
al_min_noise = 0
si_min_noise = 0 
v1_noise = 0
v2_noise = 0
v3_noise = 0
v4_noise = 0

f = 0
f2 = 0
mg = 0
zr = 1 
kna_f = 0
mg_f = 0
ca_f = 0
al_f = 0
si_f = 0 
mg_f2 = 0
ca_f2 = 0
al_f2 = 0
si_f2 = 0
vv = 0
i = 0
j = 0
car = 0
total = 0
correct = 0
segar_mole = new Array(13)
min_mole = new Array(13)
t = new Array(13)
composition_mole = new Array(16)
molecular_weight = new Array(16)
composition_weight = new Array(16)
composition_in_percentage = new Array(16)
composition_in_percentage_int = new Array(16) 
ca_min = 0
mg_min = 0
al_min = 0
si_min = 0 
v1 = 0
v2 = 0
v3 = 0
v4 = 0
v5 = 0
v6 = 0
v7 = 0
v8 = 0
v9 = 0
v10 = 0
v11 = 0 
w1 = 0
w2 = 0
w3 = 0 
jen = 0
jen2 = 0   
ex_ave = 0
ex_si = 0.05
ex_al = 0.17
ex_kna = 4.11
ex_zn = 0.07
ex_ca = 1.63
ex_mg = 0.45
ex_ba = 1.73
ex_sr = 1.73

let savedData = [];
let TempData  =  [];
let savedData2 = [];
let ABCD = [];



    let expression = '';
    let currentNumber = '';
    let justCalculated = false;

window.savedData = window.savedData ?? Array(5).fill(null);


//  æª¢æŸ¥æŒ‡å®šçš„æš«å­˜æ§½ï¼ˆ0~4ï¼‰æ˜¯å¦æœ‰å­˜æ”¾è³‡æ–™
function slotHasData(slot) {
  return Array.isArray(window.savedData) && window.savedData[slot] && Array.isArray(window.savedData[slot]) && window.savedData[slot].length > 0;
}















// âœ… ä¿®æ”¹ç‰ˆæœ¬ï¼šè‡ªåŠ¨å¾ªç¯æ‰§è¡Œ1000000æ¬¡ï¼Œæ¯æ¬¡è°ƒç”¨éœ‡åŠ¨
// ğŸ†• å…¨å±€åˆ‡æ›ç‹€æ…‹
// ğŸ†• å…¨å±€åˆ‡æ›ç‹€æ…‹
let isLooping = false;
let loopTimer = null;
let recipeCount = 0;

function set_default_values(form) {
    const MAX_LOOPS = 10000000000;
    const loopButton = document.getElementById('loopButton');

    // â˜…â˜…â˜… æ¸…ç©ºç™¾åˆ†æ¯”æ¬„ä½å’Œä¸­é…¸æ¯” â˜…â˜…â˜…
    for (var i = 0; i <= 14; i++) {
        form.p[i].value = "";
    }
    form.r.value = "";

    
    function buttonFeedback() {
        if (navigator.vibrate) {
            navigator.vibrate(100);
        }
    }
    
    if (!isLooping) {
        // âœ… é–‹å§‹å¾ªç’°
        isLooping = true;
        loopButton.style.background = '#a070ff';
        loopButton.style.borderColor = '#8c5ae0';
        loopButton.style.animation = 'blink 0.8s ease-in-out infinite';
        
        // æ·»åŠ é–ƒçˆå‹•ç•«
        if (!document.getElementById('blinkStyle')) {
            const style = document.createElement('style');
            style.id = 'blinkStyle';
            style.textContent = `
                @keyframes blink {
                    0%, 100% { background: #a070ff; }
                    50% { background: #b08fff; }
                }
            `;
            document.head.appendChild(style);
        }
        
        let loopCount = 0;
        
        function executeOneLoop() {
            if (loopCount < MAX_LOOPS && isLooping) {
                loopCount++;
                
                const flowType = document.getElementById('glazeType1').value;
                const surfaceType = document.getElementById('glazeType2').value;
                
                // âœ… ä¿®æ”¹å¾Œçš„ Si ç¯„åœé…ç½®
                let siRangeConfig = {
                    min: 1.2,
                    max: 5.0
                };
                
                if (flowType === 'highTemp') {
                    siRangeConfig.min = 2.3;
                    siRangeConfig.max = 5.0;
                } else if (flowType === 'medTemp') {
                    siRangeConfig.min = 1.8;
                    siRangeConfig.max = 2.29;
                } else if (flowType === 'lowTemp') {
                    siRangeConfig.min = 1.2;
                    siRangeConfig.max = 1.79;
                }
                
                let mainAttempts = 0;
                const MAX_MAIN_ATTEMPTS = 20;

                document.getElementById("ca").style.color = "black"
                document.getElementById("mg").style.color = "black"
                document.getElementById("al").style.color = "black"
                document.getElementById("si").style.color = "black"  

                let isValid = false;
                
                while (mainAttempts < MAX_MAIN_ATTEMPTS) {
                    mainAttempts++;
                    
                    isValid = false;
                    let knaAdjustmentCount = 0;
                    let isReducing = true;
                    const MAX_REDUCTIONS = 5;
                    const MAX_INCREASES = 6;
                    let subAttempts = 0;
                    const MAX_SUB_ATTEMPTS = 100;
                    
                    while (!isValid && subAttempts < MAX_SUB_ATTEMPTS) {
                        subAttempts++;
                        
                        let baseKna = (Math.floor(Math.random() * 21) * 0.01 + 0.08);
                        let adjustedKna;
                        
                        if (isReducing) {
                            adjustedKna = baseKna - (knaAdjustmentCount * 0.05);
                            if (adjustedKna < 0.08) {
                                adjustedKna = 0.08;
                            }
                        } else {
                            adjustedKna = baseKna + (knaAdjustmentCount * 0.05);
                            if (adjustedKna > 0.4) {
                                adjustedKna = 0.4;
                            }
                        }
                        
                        form.kna.value = adjustedKna.toFixed(2);

                        refer(form);

                        if (Math.random() < 0.5) {
                            form.ba.value = "";
                        } else {
                            form.ba.value = (Math.floor(Math.random() * 24) * 0.01).toFixed(2);
                        }

                        if (Math.random() < 0.5) {
                            form.zn.value = "";
                        } else {
                            form.zn.value = (Math.floor(Math.random() * 24) * 0.01).toFixed(2);
                        }

                        // Zr è¨­å®š (5% æ©Ÿç‡)
                        if (Math.random() < 0.05) {
                            const zrValues = [0.1, 0.13, 0.15, 0.18, 0.2, 0.22];
                            const randomIndex = Math.floor(Math.random() * zrValues.length);
                            form.zr.value = zrValues[randomIndex].toFixed(2);
                        } else {
                            form.zr.value = "";
                        }

                        // Sn è¨­å®š (5% æ©Ÿç‡)
                        if (Math.random() < 0.05) {
                            const snValues = [0.1, 0.13, 0.15, 0.18, 0.2, 0.22, 0.25, 0.27];
                            const randomIndex = Math.floor(Math.random() * snValues.length);
                            form.sn.value = snValues[randomIndex].toFixed(2);
                        } else {
                            form.sn.value = "";
                        }

                        // Mg å€¼è¨­å®šï¼ˆä¸è®Šï¼‰
                        if (surfaceType === 'matte_Mg') {
                            var mgValue = 0.2 + (Math.floor(Math.random() * 81) * 0.001);
                            form.mg.value = mgValue.toFixed(4);
                        } else if (surfaceType === 'glossy') {
                            var mgMaxGlossy = Math.min(0.1, 0.25);
                            var mgRangeGlossy = mgMaxGlossy - mg_min;
                            if (mgRangeGlossy > 0) {
                                var randomMg = mg_min + (Math.floor(Math.random() * (mgRangeGlossy * 10000 + 1)) * 0.0001);
                                form.mg.value = (Math.ceil(randomMg * 10000) / 10000).toFixed(4);
                            } else {
                                form.mg.value = (Math.ceil(mg_min * 10000) / 10000).toFixed(4);
                            }
                        } else {
                            if (Math.random() < 0.5) {
                                form.mg.value = (Math.ceil(mg_min * 10000) / 10000).toFixed(4);
                            } else {
                                var mgMax = 0.25;
                                var mgRange = mgMax - mg_min;
                                if (mgRange > 0) {
                                    var randomValue = mg_min + (Math.floor(Math.random() * (mgRange * 10000 + 1)) * 0.0001);
                                    form.mg.value = (Math.ceil(randomValue * 10000) / 10000).toFixed(4);
                                } else {
                                    form.mg.value = (Math.ceil(mg_min * 10000) / 10000).toFixed(4);
                                }
                            }
                        }

                        if (Math.random() < 0.6) {
                            form.sr.value = "";
                        } else {
                            form.sr.value = (Math.floor(Math.random() * 24) * 0.01).toFixed(2);
                        }
                        
                        form.ca.value = "0";
                        check_jen(form);
                        
                        if (jen2 < ca_min || jen2 > 0.75) {
                            continue;
                        }
                        
                        form.ca.value = "0";
                        ADD_Ca(form);
                        
                        var caValue = parseFloat(form.ca.value) || 0;
                        if (caValue < ca_min || caValue > 0.75) {
                            continue;
                        }
                        
                        let alSiValid = false;
                        let innerAttempts = 0;
                        const MAX_INNER_ATTEMPTS = 100;
                        
                        while (!alSiValid && innerAttempts < MAX_INNER_ATTEMPTS) {
                            innerAttempts++;
                            
                            var targetSiRange = Math.random();
                            var randomAl, alValue, alRounded;
                            
                            if (targetSiRange < 0.4) {
                                var alMax = Math.min(2.0 / 5.0, al_min + 0.3);
                                var alRange = alMax - al_min;
                                
                                if (alRange > 0) {
                                    randomAl = Math.random() * alRange;
                                    alValue = al_min + randomAl;
                                } else {
                                    alValue = al_min;
                                }
                            } else {
                                var minAlFor2 = Math.max(2.0 / 12.0, al_min);
                                var alMax = al_min + 0.3;
                                var alRange = alMax - minAlFor2;
                                
                                if (alRange > 0) {
                                    randomAl = Math.random() * alRange;
                                    alValue = minAlFor2 + randomAl;
                                } else {
                                    alValue = al_min + Math.floor(Math.random() * 31) * 0.01;
                                }
                            }
                            
                            alRounded = parseFloat(alValue.toFixed(2));
                            
                            if (alRounded < al_min) {
                                alRounded = Math.ceil(al_min * 100) / 100;
                            }
                            
                            form.al.value = alRounded.toFixed(2);
                            var alVal = parseFloat(form.al.value);
                            
                            var multiplier;
                            
                            // âœ… ä¿®æ”¹å¾Œçš„ multiplier è¨­å®š
                            if (surfaceType === 'matte') {
                                // ä¸€èˆ¬ç„¡å…‰: 4.5 ~ 5.79
                                multiplier = parseFloat((Math.random() * 1.29 + 4.5).toFixed(1));
                            } else if (surfaceType === 'matte_Mg') {
                                // é‚ç„¡å…‰: 7.0 ~ 12.0ï¼ˆä¸è®Šï¼‰
                                multiplier = parseFloat((Math.random() * 5 + 7).toFixed(1));
                            } else if (surfaceType === 'glossy') {
                                // äº®å…‰: 5.8 ~ 15.0
                                multiplier = parseFloat((Math.random() * 9.2 + 5.8).toFixed(1));
                            } else {
                                // éš¨æ©Ÿ: 5.0ï¼ˆ25%æ©Ÿç‡ï¼‰æˆ– 4.5 ~ 15.0
                                if (Math.random() < 0.25) {
                                    multiplier = 5.0;
                                } else {
                                    multiplier = parseFloat((Math.random() * 10.5 + 4.5).toFixed(1));
                                }
                            }

                            var siVal = parseFloat((alVal * multiplier).toFixed(4));

                            if (siVal >= siRangeConfig.min && 
                                siVal <= siRangeConfig.max && 
                                siVal >= si_min) {
                                form.si.value = parseFloat(siVal.toFixed(4));
                                alSiValid = true;
                            }
                        }
                        
                        if (!alSiValid) {
                            knaAdjustmentCount++;
                            
                            if (isReducing) {
                                if (knaAdjustmentCount > MAX_REDUCTIONS) {
                                    isReducing = false;
                                    knaAdjustmentCount = 1;
                                }
                            } else {
                                if (knaAdjustmentCount > MAX_INCREASES) {
                                    break;
                                }
                            }
                            
                            continue;
                        }
                        
                        if (Math.random() < 1/3) {
                            var tiValue = (0.12 + Math.floor(Math.random() * 17) * 0.02).toFixed(2);
                            form.ti.value = tiValue;
                        } else {
                            form.ti.value = "";
                        }            
                        
                        isValid = true;
                    }
                    
                    if (isValid) {
                        break;
                    }
                }
                
                if (isValid) {
                   //  calculate_segar(form);
 
                    recipeCount++;
                    loopButton.value = `ğŸ§ª ç¯„ä¾‹ (${recipeCount})`;

                    const calcBtn = document.getElementById('calculateBtn');
                    if (calcBtn) {
                        calcBtn.value = 'âœ“ è¨ˆç®— â•â•â•â¤';
                    }

                    const calcBtn2 = document.getElementById('calculateBtn2');
                    if (calcBtn2) {
                        calcBtn2.value = 'è¨ˆç®— â—€â•â•â•';
                    }
                }
                
                buttonFeedback();
                
                loopTimer = setTimeout(executeOneLoop, 60);
            } else {
                // å¾ªç’°å®Œæˆ
                isLooping = false;
                loopButton.style.animation = 'none';
                loopButton.style.background = '#f5e0ff';
                loopButton.style.borderColor = '#c45cff';
                loopButton.style.color = '#5d3fd3';
            }
        }
        
        executeOneLoop();
        
    } else {
        // âŒ ä¸­æ­¢å¾ªç’°
        isLooping = false;
        clearTimeout(loopTimer);
        loopButton.style.animation = 'none';
        loopButton.style.background = '#f5e0ff';
        loopButton.style.borderColor = '#c45cff';
        loopButton.style.color = '#5d3fd3';
    }
}










//    ç”±KNaåŠé•·çŸ³ç¨®é¡ æ±ºå®šCa Mg Al Si çš„æœ€å°å€¼ 
//    2025/11/25èµ· æ”¹ç”¨é‡‰è—¥å ‚æä¾›é•·çŸ³æˆåˆ†è³‡æ–™æ”¹å¯«!

function refer(form) {
    check_jen(form)
    if (form.f[0].checked) f = 1   // éœæ­£
    if (form.f[1].checked) f = 2   // æ—¥åŒ–
    if (form.f[2].checked) f = 3   // å°åº¦
    if (form.f[3].checked) f = 4   // æ¾³æ´²
    if (form.f[4].checked) f = 5   // é‡œæˆ¶
    if (form.f[5].checked) f = 6   // SH-1
    if (form.f[6].checked) f = 7   // ç¦å³¶
    if (form.f[7].checked) f = 8   // æ–°å¹³æ´¥
    if (form.f[8].checked) f = 9   // å¡æ–¯ç‰¹
    
    if (f == 1) { kna_f = 0.9420; ca_f = 0.0568; mg_f = 0.0011; al_f = 1.0401; si_f = 4.5997; };   // éœæ­£
    if (f == 2) { kna_f = 0.9432; ca_f = 0.0549; mg_f = 0.0018; al_f = 1.1672; si_f = 11.2996; };  // æ—¥åŒ–
    if (f == 3) { kna_f = 0.9828; ca_f = 0.0161; mg_f = 0.0012; al_f = 1.0519; si_f = 6.6741; };   // å°åº¦
    if (f == 4) { kna_f = 0.9588; ca_f = 0.0287; mg_f = 0.0126; al_f = 0.9732; si_f = 6.4918; };   // æ¾³æ´²
    if (f == 5) { kna_f = 0.9035; ca_f = 0.0959; mg_f = 0.0006; al_f = 0.8964; si_f = 8.1056; };   // é‡œæˆ¶
    if (f == 6) { kna_f = 0.9155; ca_f = 0.0828; mg_f = 0.0016; al_f = 1.0330; si_f = 10.3023; };  // SH-1
    if (f == 7) { kna_f = 1.0000; ca_f = 0.0000; mg_f = 0.0000; al_f = 1.0929; si_f = 9.1143; };   // ç¦å³¶
    if (f == 8) { kna_f = 0.9581; ca_f = 0.0349; mg_f = 0.0070; al_f = 1.0896; si_f = 8.4093; };   // æ–°å¹³æ´¥
    if (f == 9) { kna_f = 0.9670; ca_f = 0.0331; mg_f = 0.0000; al_f = 1.0431; si_f = 7.1302; };   // å¡æ–¯ç‰¹
    
    if (form.kna.value == "") form.kna.value = "0"
    f2 = parseFloat(form.kna.value) / kna_f 
    ca_min = ca_f * f2
    mg_min = mg_f * f2
    al_min = al_f * f2
    si_min = si_f * f2 
    min_mole[1] = parseFloat(form.kna.value);
    min_mole[2] = ca_min;
    min_mole[5] = mg_min;
    min_mole[7] = al_min;
    min_mole[8] = si_min; 
    form.Ca_min_message.value = Math.round(ca_min * 100000) / 100000
    form.Mg_min_message.value = Math.round(mg_min * 100000) / 100000
    form.Al_min_message.value = Math.round(al_min * 100000) / 100000
    form.Si_min_message.value = Math.round(si_min * 100000) / 100000
}








function fill_Ca_min(form) {
    form.ca.value = form.Ca_min_message.value
    refer(form)
    document.getElementById("ca").style.color = "black";
}
function fill_Mg_min(form) {
    form.mg.value = form.Mg_min_message.value
    refer(form)
    document.getElementById("mg").style.color = "black";
}
function fill_Al_min(form) {
    form.al.value = form.Al_min_message.value
    refer(form)
    document.getElementById("al").style.color = "black";
}
function fill_Si_min(form) {
    form.si.value = form.Si_min_message.value
    refer(form)
    document.getElementById("si").style.color = "black";
}

function compare_kna(form, mole) { 
    refer(form)
    if (parseFloat(mole) < 0) {
        window.alert("ä¸å¯è¼¸å…¥è² å€¼ : ")
        document.getElementById("kna").style.color = "red";
        form.kna.blur()
    } else {
        document.getElementById("kna").style.color = "black";
    }
}

function compare_ca(form, mole) {
    refer(form)
    if (parseFloat(mole) < parseFloat(form.Ca_min_message.value) - 0.00001) {
        window.alert("Caä¸å¯å°æ–¼æœ€å°å€¼ : " + Math.round(ca_min * 100000) / 100000)
        document.getElementById("ca").style.color = "red";
        form.ca.blur()
    } else if (parseFloat(form.ca.value) < 0 || parseFloat(form.ca.value) > 50) {
        window.alert("Caä¸å¯ç‚ºè² å€¼æˆ–éæ•¸å­— ")
        document.getElementById("ca").style.color = "red";
        form.ca.blur()
    } else {
        document.getElementById("ca").style.color = "black";
    }
    checkSegarComplete(form); // âœ… åŠ å…¥é€™è¡Œ
}

function compare_mg(form, mole) {
    refer(form)
    if (parseFloat(mole) < parseFloat(form.Mg_min_message.value) - 0.00001) {
        window.alert("Mgä¸å¯å°æ–¼æœ€å°å€¼ : " + Math.round(mg_min * 100000) / 100000)
        document.getElementById("mg").style.color = "red";
        form.mg.blur()
    } else {
        document.getElementById("mg").style.color = "black";
    }
    checkSegarComplete(form); // âœ… åŠ å…¥é€™è¡Œ
}

function compare_al(form, mole) {
    refer(form)
    if (parseFloat(mole) < parseFloat(form.Al_min_message.value) - 0.00001) {
        window.alert("Alä¸å¯å°æ–¼æœ€å°å€¼ : " + Math.round(al_min * 100000) / 100000)
        document.getElementById("al").style.color = "red";
        form.al.blur()
    } else {
        document.getElementById("al").style.color = "black";
    }
    checkSegarComplete(form); // âœ… åŠ å…¥é€™è¡Œ
}

function compare_si(form, mole) {
    refer(form)
    if (parseFloat(mole) < parseFloat(form.Si_min_message.value) - 0.00001) {
        window.alert("Siä¸å¯å°æ–¼æœ€å°å€¼ : " + Math.round(si_min * 100000) / 100000)
        document.getElementById("si").style.color = "red";
        form.si.blur()
    } else {
        document.getElementById("si").style.color = "black";
    }
    checkSegarComplete(form); // âœ… åŠ å…¥é€™è¡Œ
}





function check_CaMgAlSi_MinimumValues(form) {
    // ä¾åºå‘¼å«ç¾æœ‰çš„æª¢æŸ¥å‡½æ•¸
     if (form.ca.value) compare_ca(form, form.ca.value);//  æª¢æŸ¥Caæœ€å°å€¼
     if (form.mg.value) compare_mg(form, form.mg.value);//  æª¢æŸ¥Mgæœ€å°å€¼
     if (form.al.value) compare_al(form, form.al.value);//  æª¢æŸ¥Alæœ€å°å€¼
     if (form.si.value) compare_si(form, form.si.value);//  æª¢æŸ¥Siæœ€å°å€¼
    

         }







function reset_data(form) {
    form.kna.value = ""
    form.ca.value = ""
    form.ba.value = ""
    form.zn.value = ""
    form.mg.value = ""
    form.sr.value = ""
    form.al.value = ""
    form.si.value = ""
    form.ti.value = ""
    form.zr.value = ""
    form.sn.value = ""
    f2 = 0
    kna_f = 0
    mg_f = 0
    ca_f = 0
    al_f = 0
    si_f = 0
    i = 0
    j = 0
    total = 0
    correct = 0
    ca_min = 0
    mg_min = 0
    al_min = 0
    si_min = 0
    car = 0
    jen = 0
    jen2 = 0 
    for (i = 0; i <= 12; i++) {
        segar_mole[i] = 0
        min_mole[i] = 0
        t[i] = 0
    }
    for (i = 0; i <= 14; i++) {
        composition_mole[i] = 0
        molecular_weight[i] = 0
        composition_weight[i] = 0
        composition_in_percentage[i] = 0
        composition_in_percentage_int[i] = 0
        form.p[i].value = ""
    }
    form.r.value = ""
    
    form.Ca_min_message.value = ""
    form.Mg_min_message.value = ""
    form.Al_min_message.value = ""
    form.Si_min_message.value = ""
if (typeof clearDisplay === 'function') { clearDisplay(); }
    // âœ… åŠ å…¥é€™å…©è¡Œ
    checkSegarComplete(form);
    checkPercentComplete(form);
check_percent(form);  // âœ… ç¢ºèªæœ‰é€™è¡Œ
}




function check_jen(form) {
    // å°‡ç©ºç™½æ¬„ä½æš«æ™‚è¨­ç‚º 0
    if (form.kna.value == "") form.kna.value = "0"
    if (form.ca.value == "") form.ca.value = "0"
    if (form.ba.value == "") form.ba.value = "0"
    if (form.zn.value == "") form.zn.value = "0"
    if (form.mg.value == "") form.mg.value = "0"
    if (form.sr.value == "") form.sr.value = "0"
    
    // è¨ˆç®—é¹¼æ€§è«è€³æ•¸ç¸½å’Œ
    jen = parseFloat(form.kna.value) + parseFloat(form.ca.value) + parseFloat(form.ba.value) + parseFloat(form.zn.value) + parseFloat(form.mg.value) + parseFloat(form.sr.value) 
    
    // å®¹è¨± 0.002 ä»¥å…§çš„èª¤å·®
    if (1 - jen < 0.002 && 1 - jen >= 0) {
        jen = 1 
    } 
    
    jen = Math.round(jen * 1000000) / 1000000 
    jen2 = 1 - jen
    
    // æ›´æ–°é¡¯ç¤ºï¼ˆä½¿ç”¨çµ±ä¸€æ¨£å¼ï¼‰
    document.getElementById("alkalineTotal").textContent = jen.toFixed(4);
    document.getElementById("alkalineShortage").textContent = jen2.toFixed(4);
    
    // å°‡ 0 å€¼æ¬„ä½æ¢å¾©ç‚ºç©ºç™½
    if (form.kna.value == "0") form.kna.value = ""
    if (form.ca.value == "0") form.ca.value = ""
    if (form.ba.value == "0") form.ba.value = ""
    if (form.zn.value == "0") form.zn.value = ""
    if (form.mg.value == "0") form.mg.value = ""
    if (form.sr.value == "0") form.sr.value = ""
    // âœ… åŠ å…¥é€™è¡Œ
    checkSegarComplete(form);
}





function ADD_Ca(form) {
    // é‡æ–°è¨ˆç®—ç¢ºä¿æ•¸å€¼æ­£ç¢º
    check_jen(form);
    
    // å–å¾—ä¸è¶³é¡ï¼ˆå¯èƒ½æ˜¯æ­£å€¼æˆ–è² å€¼ï¼‰
    let shortage = parseFloat(document.getElementById("alkalineShortage").textContent);
    
    // å–å¾—ç›®å‰çš„éˆ£å€¼
    let currentCa = form.ca.value === "" ? 0 : parseFloat(form.ca.value);
    
    // è¨ˆç®—æ–°çš„éˆ£å€¼
    let newCa = currentCa + shortage;
    
    // æª¢æŸ¥éˆ£å€¼æ˜¯å¦æœƒè®Šæˆè² æ•¸
    if (newCa < 0) {
        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        showTempMessage("éˆ£å€¼å¤ªå°");
        return; // ä¸­æ­¢æ“ä½œ
    }
    
    // æ›´æ–°éˆ£å€¼ï¼ˆå››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œ4ä½ï¼‰
    form.ca.value = newCa.toFixed(4);
    
    // é‡æ–°æª¢æŸ¥é¹¼æ€§è«è€³æ•¸ï¼ˆè§¸ç™¼ onblur äº‹ä»¶ï¼‰
    compare_ca(form, form.ca.value);
    checkSegarComplete(form); // âœ… åŠ å…¥é€™è¡Œ
}




// é¡¯ç¤ºè‡¨æ™‚æç¤ºè¨Šæ¯çš„å‡½æ•¸
// é¡¯ç¤ºè‡¨æ™‚æç¤ºè¨Šæ¯çš„å‡½æ•¸ï¼ˆåœ¨è¡¨æ ¼é™„è¿‘é¡¯ç¤ºï¼‰
function showTempMessage(message) {
    const msgElement = document.getElementById('alkalineMessage');
    if (!msgElement) return;
    
    // è¨­ç½®è¨Šæ¯æ–‡å­—
    msgElement.textContent = message;
    
    // é¡¯ç¤ºè¨Šæ¯
    msgElement.style.display = 'inline-block';
    
    // 2ç§’å¾Œéš±è—
    setTimeout(() => {
        msgElement.style.display = 'none';
    }, 2000);
}



function ADD_Ba(form) {
    // é‡æ–°è¨ˆç®—ç¢ºä¿æ•¸å€¼æ­£ç¢º
    check_jen(form);
    
    // å–å¾—ä¸è¶³é¡
    let shortage = parseFloat(document.getElementById("alkalineShortage").textContent);
    
    // å–å¾—ç›®å‰çš„é‹‡å€¼
    let currentBa = form.ba.value === "" ? 0 : parseFloat(form.ba.value);
    
    // è¨ˆç®—æ–°çš„é‹‡å€¼
    let newBa = currentBa + shortage;
    
    // å¦‚æœçµæœç‚º 0ï¼Œæ¸…ç©ºæ¬„ä½
    if (newBa == 0) {
        form.ba.value = "";
        check_jen(form);
        checkSegarComplete(form); // âœ… åŠ å…¥é€™è¡Œ
        return;
    }
    
    // æª¢æŸ¥é‹‡å€¼æ˜¯å¦æœƒè®Šæˆè² æ•¸
    if (newBa < 0) {
        showTempMessage("é‹‡å€¼å¤ªå°");
        return;
    }
    
    // æ›´æ–°é‹‡å€¼
    form.ba.value = newBa.toFixed(4);
    
    // é‡æ–°æª¢æŸ¥é¹¼æ€§è«è€³æ•¸
    check_jen(form);
    
    // âœ… åŠ å…¥é€™è¡Œ
    checkSegarComplete(form);
}

function ADD_Zn(form) {
    // é‡æ–°è¨ˆç®—ç¢ºä¿æ•¸å€¼æ­£ç¢º
    check_jen(form);
    
    // å–å¾—ä¸è¶³é¡
    let shortage = parseFloat(document.getElementById("alkalineShortage").textContent);
    
    // å–å¾—ç›®å‰çš„é‹…å€¼
    let currentZn = form.zn.value === "" ? 0 : parseFloat(form.zn.value);
    
    // è¨ˆç®—æ–°çš„é‹…å€¼
    let newZn = currentZn + shortage;
    
    // å¦‚æœçµæœç‚º 0ï¼Œæ¸…ç©ºæ¬„ä½
    if (newZn == 0) {
        form.zn.value = "";
        check_jen(form);
        checkSegarComplete(form); // âœ… åŠ å…¥é€™è¡Œ
        return;
    }
    
    // æª¢æŸ¥é‹…å€¼æ˜¯å¦æœƒè®Šæˆè² æ•¸
    if (newZn < 0) {
        showTempMessage("é‹…å€¼å¤ªå°");
        return;
    }
    
    // æ›´æ–°é‹…å€¼
    form.zn.value = newZn.toFixed(4);
    
    // é‡æ–°æª¢æŸ¥é¹¼æ€§è«è€³æ•¸
    check_jen(form);
    
    // âœ… åŠ å…¥é€™è¡Œ
    checkSegarComplete(form);
}

function ADD_Mg(form) {
    // é‡æ–°è¨ˆç®—ç¢ºä¿æ•¸å€¼æ­£ç¢º
    check_jen(form);
    
    // å–å¾—ä¸è¶³é¡
    let shortage = parseFloat(document.getElementById("alkalineShortage").textContent);
    
    // å–å¾—ç›®å‰çš„é‚å€¼
    let currentMg = form.mg.value === "" ? 0 : parseFloat(form.mg.value);
    
    // è¨ˆç®—æ–°çš„é‚å€¼
    let newMg = currentMg + shortage;
    
    // æª¢æŸ¥é‚å€¼æ˜¯å¦æœƒè®Šæˆè² æ•¸
    if (newMg < 0) {
        showTempMessage("é‚å€¼å¤ªå°");
        return;
    }
    
    // æ›´æ–°é‚å€¼
    form.mg.value = newMg.toFixed(4);
    
    // é‡æ–°æª¢æŸ¥é¹¼æ€§è«è€³æ•¸
    check_jen(form);
    
    // âœ… åŠ å…¥é€™è¡Œ
    checkSegarComplete(form);
}


function ADD_Sr(form) {
    // é‡æ–°è¨ˆç®—ç¢ºä¿æ•¸å€¼æ­£ç¢º
    check_jen(form);
    
    // å–å¾—ä¸è¶³é¡
    let shortage = parseFloat(document.getElementById("alkalineShortage").textContent);
    
    // å–å¾—ç›®å‰çš„é¶å€¼
    let currentSr = form.sr.value === "" ? 0 : parseFloat(form.sr.value);
    
    // è¨ˆç®—æ–°çš„é¶å€¼
    let newSr = currentSr + shortage;
    
    // å¦‚æœçµæœç‚º 0ï¼Œæ¸…ç©ºæ¬„ä½
    if (newSr == 0) {
        form.sr.value = "";
        check_jen(form);
        checkSegarComplete(form); // âœ… åŠ å…¥é€™è¡Œ
        return;
    }
    
    // æª¢æŸ¥é¶å€¼æ˜¯å¦æœƒè®Šæˆè² æ•¸
    if (newSr < 0) {
        showTempMessage("é¶å€¼å¤ªå°");
        return;
    }
    
    // æ›´æ–°é¶å€¼
    form.sr.value = newSr.toFixed(4);
    
    // é‡æ–°æª¢æŸ¥é¹¼æ€§è«è€³æ•¸
    check_jen(form);
    
    // âœ… åŠ å…¥é€™è¡Œ
    checkSegarComplete(form);
}





//  è¨ˆç®—åŸæ–™ç™¾åˆ†æ¯”çš„ç¸½å’Œ  ä¸¦é¡¯ç¤º
//  è¨ˆç®—åŸæ–™ç™¾åˆ†æ¯”çš„ç¸½å’Œ  ä¸¦é¡¯ç¤º
function check_percent(form) {
    var total_per = 0;
    
    for (i = 0; i <= 14; i++) {
        if (form.p[i].value == "") {
            composition_in_percentage[i] = 0;
        } else {
            composition_in_percentage[i] = parseFloat(form.p[i].value);
        }
        total_per += composition_in_percentage[i];
    }
    
    document.getElementById("percentTotal").textContent = total_per.toFixed(2);
    
    // æ¸…ç©ºé™£åˆ—
    for (i = 0; i <= 14; i++) {
        composition_in_percentage[i] = 0;
    }
    
    // âœ… åŠ å…¥é€™è¡Œ
    checkPercentComplete(form);
}


function calculate_segar(form) {
    updateGlazeType1(form);
    updateGlazeType2(form);
    vv = 0 
    correct = 1 
    
    refer(form)
    check_jen(form)
    
    if (jen>1.01 || jen<0.99) {
        window.alert("ç›®å‰é¹¼moleç¸½å’Œä¸ç­‰æ–¼1ï¼Œè«‹ä¿®æ­£å†é‡æ–°è¨ˆç®—")
    } 
    
    if (form.m[0].checked) mg = 1
    if (form.m[1].checked) mg = 2
    if (form.m[2].checked) mg = 3
    zr = 1
    
    if (form.ca.value != "" && parseFloat(form.ca.value) == 0) {
        window.alert("ä¸å¯è¼¸å…¥éæ•¸å­—å­—å…ƒï¼Œè«‹é‡æ–°è¼¸å…¥")
        correct = 0
    } 
    
    if (form.ca.value == "") form.ca.value = "0"
    if (form.ba.value == "") form.ba.value = "0"
    if (form.zn.value == "") form.zn.value = "0"
    if (form.mg.value == "") form.mg.value = "0"
    if (form.sr.value == "") form.sr.value = "0"
    if (form.al.value == "") form.al.value = "0"
    if (form.si.value == "") form.si.value = "0"
    if (form.ti.value == "") form.ti.value = "0"
    if (form.zr.value == "") form.zr.value = "0"
    if (form.sn.value == "") form.sn.value = "0"
    
    if (parseFloat(form.ca.value) < ca_min - 0.0001) {
        window.alert("Caä¸å¯å°æ–¼æœ€å°å€¼ : " + Math.round(ca_min * 100000) / 100000 + "mole ï¼Œå› æ­¤ç„¡æ³•è¨ˆç®—ï¼è«‹é‡æ–°è¼¸å…¥ï¼Œå†åšè¨ˆç®—ï¼")
        correct = 0
    } 
    if (parseFloat(form.mg.value) < mg_min - 0.0001) {
        window.alert("Mgä¸å¯å°æ–¼æœ€å°å€¼ : " + Math.round(mg_min * 100000) / 100000 + "mole ï¼Œå› æ­¤ç„¡æ³•è¨ˆç®—ï¼è«‹é‡æ–°è¼¸å…¥ï¼Œå†åšè¨ˆç®—ï¼")
        correct = 0
    }
    if (parseFloat(form.al.value) < al_min - 0.0001) {
        window.alert("Alä¸å¯å°æ–¼æœ€å°å€¼ : " + Math.round(al_min * 100000) / 100000 + "mole ï¼Œå› æ­¤ç„¡æ³•è¨ˆç®—ï¼è«‹é‡æ–°è¼¸å…¥ï¼Œå†åšè¨ˆç®—ï¼")
        correct = 0
    }
    if (parseFloat(form.si.value) < si_min - 0.0001) {
        window.alert("Siä¸å¯å°æ–¼æœ€å°å€¼ : " + Math.round(si_min * 100000) / 100000 + "mole ï¼Œå› æ­¤ç„¡æ³•è¨ˆç®—ï¼è«‹é‡æ–°è¼¸å…¥ï¼Œå†åšè¨ˆç®—ï¼")
        correct = 0
    }
    if (parseFloat(form.kna.value) < 0 || parseFloat(form.ca.value) < 0 || parseFloat(form.ba.value) < 0 || parseFloat(form.zn.value) < 0 || parseFloat(form.mg.value) < 0 || parseFloat(parseFloat(form.sr.value)) < 0 || parseFloat(form.al.value) < 0 || parseFloat(form.si.value) < 0 || parseFloat(form.ti.value) < 0 || parseFloat(form.zr.value) < 0 || parseFloat(form.sn.value) < 0) {
        window.alert("è³½æ ¼é‡‰å¼ç•¶ä¸­ï¼Œmoleæ•¸ä¸å¯å°æ–¼0ï¼Œè«‹ä¿®æ”¹å¾Œå†é‡æ–°è¨ˆç®—!")
        correct = 0
    } 
    
    segar_mole[1] = parseFloat(form.kna.value)
    segar_mole[2] = parseFloat(form.ca.value)
    segar_mole[3] = parseFloat(form.ba.value)
    segar_mole[4] = parseFloat(form.zn.value)
    segar_mole[5] = parseFloat(form.mg.value)
    segar_mole[6] = parseFloat(form.sr.value)
    segar_mole[7] = parseFloat(form.al.value)
    segar_mole[8] = parseFloat(form.si.value)
    segar_mole[9] = parseFloat(form.ti.value)
    segar_mole[10] = parseFloat(form.zr.value)
    segar_mole[11] = parseFloat(form.sn.value) 
    
    car = 0
   
    for (i = 1; i <= 6; i++)  car = car + segar_mole[i]
    if (1 - car < 0.002) {
        car = 1
    } 
  
    jen2 = 1 - jen
    
    for (i = 0; i <= 14; i++) form.p[i].value = ""
    form.r.value = ""
    
    for (i = 1; i <= 12; i++) {
         if (!segar_mole[i]) segar_mole[i] = 0;
         if (!min_mole[i]) min_mole[i] = 0;
         t[i] = segar_mole[i] - min_mole[i] ? segar_mole[i] - min_mole[i]:0;
    } 
    
    composition_mole[0] = f2; t[1] = 0;
    composition_mole[2] = t[3]; t[3] = 0;
    composition_mole[3] = t[4]; t[4] = 0;
    composition_mole[5] = t[6]; t[6] = 0;
    composition_mole[11] = t[9]; t[9] = 0;
    composition_mole[14] = t[11]; t[11] = 0;
    
    if (t[10] > 0) {
        if (zr == 2) {
            composition_mole[12] = t[10];
            t[10] = 0;
        }
        if (zr == 1) {
            if (t[8] >= t[10]) {
                composition_mole[13] = t[10];
                t[8] = t[8] - t[10];
                t[10] = 0;
            }
            else if (t[8] < t[10]) {  // âœ… ä¿®æ­£ 1ï¼šæ”¹æˆ else if
                composition_mole[13] = t[8];
                composition_mole[12] = t[10] - t[8];
                t[8] = 0;
                t[10] = 0;
             }
        }
    }
    
    if (mg == 0) {
        composition_mole[1] = t[2];
        t[2] = 0;
    } 
    
    if (mg == 3) {
        composition_mole[4] = t[5];
        t[5] = 0;
        composition_mole[1] = t[2];
        t[2] = 0;
    } 
    
    // âœ… ä¿®æ­£ 2ï¼šç™½é›²çŸ³é‚è¼¯ï¼ˆæ”¹ç”¨ else ifï¼‰
    if (mg == 1) {
        if (t[2] >= t[5]) {
            composition_mole[6] = t[5];
            composition_mole[4] = 0;
            composition_mole[1] = t[2] - t[5];
            t[2] = 0;
            t[5] = 0;
        }
        else if (t[5] > t[2]) {  // âœ… æ”¹æˆ else if
            composition_mole[6] = t[2];
            composition_mole[1] = 0;
            t[5] = t[5] - t[2];
            t[2] = 0;
            if (t[8] >= t[5] / 3 * 4) {
                composition_mole[7] = t[5] / 3;
                t[5] = 0;
                t[8] = t[8] - composition_mole[7] * 4;
            }
            else if (t[8] < t[5] / 3 * 4) {  // âœ… æ”¹æˆ else if
                composition_mole[7] = t[8] / 4;
                t[5] = t[5] - t[8] / 4 * 3;
                t[8] = 0;
                composition_mole[4] = t[5];
            } 
         }
    }
    
    // âœ… ä¿®æ­£ 3ï¼šæ»‘çŸ³é‚è¼¯ï¼ˆæ”¹ç”¨ else ifï¼‰
    if (mg == 2) {
         if (t[8] >= t[5] / 3 * 4) {
            composition_mole[7] = t[5] / 3;
            composition_mole[4] = 0;
            t[5] = 0;
            t[8] = t[8] - composition_mole[7] * 4;
            composition_mole[1] = t[2];
            t[2] = 0;
        }
        else if (t[8] < t[5] / 3 * 4) {  // âœ… æ”¹æˆ else if
            composition_mole[7] = t[8] / 4;
            t[8] = 0;
            t[5] = t[5] - composition_mole[7] * 3;
            if (t[2] > t[5]) {
                composition_mole[6] = t[5];
                composition_mole[4] = 0;
                composition_mole[1] = t[2] - t[5];
                t[5] = 0; 
             }
            else if (t[5] >= t[2]) {  // âœ… æ”¹æˆ else if
                composition_mole[6] = t[2];
                composition_mole[1] = 0;
                composition_mole[4] = t[5] - t[2];
                t[2] = 0;
            } 
         }
    }
    
    // âœ… ä¿®æ­£ 4ï¼šå…ˆè™•ç†é«˜å¶ºåœŸï¼ˆAl + Siï¼‰
    if (t[7] > 0) {
        if (t[8] >= t[7] * 2) {
            // Si è¶³å¤ ï¼Œå…¨éƒ¨ Al è®Šæˆé«˜å¶ºåœŸ
            composition_mole[8] = t[7];
            t[7] = 0;
            t[8] = t[8] - composition_mole[8] * 2;
        }
        else if (t[8] < t[7] * 2) {
            // Si ä¸å¤ ï¼Œåªåšéƒ¨åˆ†é«˜å¶ºåœŸ
            composition_mole[8] = t[8] / 2;
            t[8] = 0;
            t[7] = t[7] - composition_mole[8];
            composition_mole[9] = t[7];  // å‰©é¤˜ Al è®Šæˆæ°§åŒ–é‹
            t[7] = 0;
        }
    }
    
    // âœ… ä¿®æ­£ 5ï¼šæœ€å¾Œæ‰çµ¦çŸ³è‹±ï¼ˆå‰©é¤˜çš„ Siï¼‰
    composition_mole[10] = t[8];
    t[8] = 0;
    
if (f == 1) molecular_weight[0] = 451;   // éœæ­£
if (f == 2) molecular_weight[0] = 872;   // æ—¥åŒ–
if (f == 3) molecular_weight[0] = 592;   // å°åº¦
if (f == 4) molecular_weight[0] = 571;   // æ¾³æ´²
if (f == 5) molecular_weight[0] = 646;   // é‡œæˆ¶
if (f == 6) molecular_weight[0] = 800;   // SH-1
if (f == 7) molecular_weight[0] = 741;   // ç¦å³¶
if (f == 8) molecular_weight[0] = 689;   // æ–°å¹³æ´¥
if (f == 9) molecular_weight[0] = 617;   // å¡æ–¯ç‰¹
    
    molecular_weight[1] = 100;
    molecular_weight[2] = 197;
    molecular_weight[3] = 81;
    molecular_weight[4] = 84;
    molecular_weight[5] = 148;
    molecular_weight[6] = 184;
    molecular_weight[7] = 379;
    molecular_weight[8] = 258;
    molecular_weight[9] = 102;
    molecular_weight[10] = 60;
    molecular_weight[11] = 80;
    molecular_weight[12] = 123;
    molecular_weight[13] = 183;
    molecular_weight[14] = 151;
    
    total = 0;
    total100 = 0;
    for (i = 0; i <= 14; i++) {
        if(!composition_mole[i]) composition_mole[i] = 0;
        composition_weight[i] = composition_mole[i] * molecular_weight[i];
        total = total + composition_weight[i];
    } 
    
    for (i = 0; i <= 14; i++) {
        composition_in_percentage[i] = composition_weight[i] / total * 100;
        composition_in_percentage_int[i] = Math.round(composition_in_percentage[i] * 10) / 10
         if (composition_in_percentage_int[i] > 0.00001 && composition_in_percentage_int[i] < 100.1) {
            if (correct) form.p[i].value = composition_in_percentage[i];
        }
        composition_in_percentage_int[i] = 0
    } 
    
    if (segar_mole[8] + segar_mole[9] + segar_mole[10] + segar_mole[11] > 0 && segar_mole[7] > 0) {
        ratio = (segar_mole[8] + segar_mole[9] + segar_mole[10] + segar_mole[11]) / segar_mole[7]
        if (correct) form.r.value = "1:" + ratio.toFixed(1)
    }
    else form.r.value = "ç„¡"
    
    let toint=Number(form.toint.checked)
    if (toint==1) {
        to_int(form)
    } 
    
    ex_ave = (parseFloat(form.si.value) * ex_si + parseFloat(form.al.value) * ex_al + parseFloat(form.kna.value) * ex_kna + parseFloat(form.zn.value) * ex_zn + parseFloat(form.ca.value) * ex_ca + parseFloat(form.mg.value) * ex_mg + parseFloat(form.ba.value) * ex_ba + parseFloat(form.sr.value) * ex_sr) / (parseFloat(form.si.value) + parseFloat(form.al.value) + parseFloat(form.kna.value) + parseFloat(form.zn.value) + parseFloat(form.ca.value) + parseFloat(form.mg.value) + parseFloat(form.ba.value) + parseFloat(form.sr.value)) 
    
    if (form.kna.value == "0") form.kna.value = ""
    if (form.ca.value == "0") form.ca.value = ""
    if (form.ba.value == "0") form.ba.value = ""
    if (form.zn.value == "0") form.zn.value = ""
    if (form.mg.value == "0") form.mg.value = ""
    if (form.sr.value == "0") form.sr.value = ""
    if (form.al.value == "0") form.al.value = ""
    if (form.si.value == "0") form.si.value = ""
    if (form.ti.value == "0") form.ti.value = ""
    if (form.zr.value == "0") form.zr.value = ""
    if (form.sn.value == "0") form.sn.value = ""
    
    // âœ… ä¿®æ­£ 6ï¼šè¨»è§£æ‰ analysisï¼ˆé¿å…éŒ¯èª¤ï¼‰
    // if (correct == 1) analysis(form)
    
    clear_for_next()
    check_percent(form)
    checkPercentComplete(form);
    updateGlazeType1(form);
    updateGlazeType2(form);
}







// ç´”å‡½æ•¸ï¼šè¼¸å…¥è³½æ ¼é‡‰å¼ï¼Œè¼¸å‡ºåŸæ–™ç™¾åˆ†æ¯”
// inputData = { kna, ca, ba, zn, mg, sr, al, si, ti, zr, sn, f_type, mg_type }
// å›å‚³ { percentages: [15å€‹ç™¾åˆ†æ¯”], ratio: "1:X.X", correct: true/false, error: "éŒ¯èª¤è¨Šæ¯æˆ–null" }



function calculate_segar_pure(inputData) {
    const { kna, ca, ba, zn, mg, sr, al, si, ti, zr, sn, f_type, mg_type } = inputData;
    
    const result = {
        percentages: new Array(15).fill(0),
        ratio: "ç„¡",
        correct: true,
        error: null
    };
    
    // é•·çŸ³ä¿‚æ•¸è¡¨
    let kna_f, mg_f, ca_f, al_f, si_f, molecular_weight_0;
if (f_type == 1) { kna_f = 0.9420; ca_f = 0.0568; mg_f = 0.0011; al_f = 1.0401; si_f = 4.5997; molecular_weight_0 = 451; }
else if (f_type == 2) { kna_f = 0.9432; ca_f = 0.0549; mg_f = 0.0018; al_f = 1.1672; si_f = 11.2996; molecular_weight_0 = 872; }
else if (f_type == 3) { kna_f = 0.9828; ca_f = 0.0161; mg_f = 0.0012; al_f = 1.0519; si_f = 6.6741; molecular_weight_0 = 592; }
else if (f_type == 4) { kna_f = 0.9588; ca_f = 0.0287; mg_f = 0.0126; al_f = 0.9732; si_f = 6.4918; molecular_weight_0 = 571; }
else if (f_type == 5) { kna_f = 0.9035; ca_f = 0.0959; mg_f = 0.0006; al_f = 0.8964; si_f = 8.1056; molecular_weight_0 = 646; }
else if (f_type == 6) { kna_f = 0.9155; ca_f = 0.0828; mg_f = 0.0016; al_f = 1.0330; si_f = 10.3023; molecular_weight_0 = 800; }
else if (f_type == 7) { kna_f = 1.0000; ca_f = 0.0000; mg_f = 0.0000; al_f = 1.0929; si_f = 9.1143; molecular_weight_0 = 741; }
else if (f_type == 8) { kna_f = 0.9581; ca_f = 0.0349; mg_f = 0.0070; al_f = 1.0896; si_f = 8.4093; molecular_weight_0 = 689; }
else if (f_type == 9) { kna_f = 0.9670; ca_f = 0.0331; mg_f = 0.0000; al_f = 1.0431; si_f = 7.1302; molecular_weight_0 = 617; }
else { kna_f = 1; mg_f = 0; ca_f = 0; al_f = 1; si_f = 6; molecular_weight_0 = 0; }    
    const f2 = kna / kna_f;
    const ca_min = ca_f * f2;
    const mg_min = mg_f * f2;
    const al_min = al_f * f2;
    const si_min = si_f * f2;
    
    // æª¢æŸ¥æœ€å°å€¼
    if (ca < ca_min - 0.0001) {
        result.correct = false;
        result.error = "Caä¸å¯å°æ–¼æœ€å°å€¼";
        return result;
    }
    if (mg < mg_min - 0.0001) {
        result.correct = false;
        result.error = "Mgä¸å¯å°æ–¼æœ€å°å€¼";
        return result;
    }
    if (al < al_min - 0.0001) {
        result.correct = false;
        result.error = "Alä¸å¯å°æ–¼æœ€å°å€¼";
        return result;
    }
    if (si < si_min - 0.0001) {
        result.correct = false;
        result.error = "Siä¸å¯å°æ–¼æœ€å°å€¼";
        return result;
    }
    
    // æ‰£é™¤é•·çŸ³æä¾›çš„é‡
    const t = new Array(13).fill(0);
    t[1] = 0; // kna å…¨ç”±é•·çŸ³æä¾›
    t[2] = ca - ca_min;
    t[3] = ba;
    t[4] = zn;
    t[5] = mg - mg_min;
    t[6] = sr;
    t[7] = al - al_min;
    t[8] = si - si_min;
    t[9] = ti;
    t[10] = zr;
    t[11] = sn;
    
    const comp_mole = new Array(15).fill(0);
    
    comp_mole[0] = f2; // é•·çŸ³
    comp_mole[2] = t[3]; t[3] = 0; // ç¢³é…¸é‹‡
    comp_mole[3] = t[4]; t[4] = 0; // æ°§åŒ–é‹…
    comp_mole[5] = t[6]; t[6] = 0; // ç¢³é…¸é¶
    comp_mole[11] = t[9]; t[9] = 0; // äºŒæ°§åŒ–éˆ¦
    comp_mole[14] = t[11]; t[11] = 0; // äºŒæ°§åŒ–éŒ«
    
    // è™•ç† Zrï¼ˆä¸€å¾‹ä½¿ç”¨çŸ½é…¸é‹¯ï¼‰
    if (t[10] > 0) {
        if (t[8] >= t[10]) {
            comp_mole[13] = t[10]; // çŸ½é…¸é‹¯
            t[8] -= t[10];
            t[10] = 0;
        } else {
            comp_mole[13] = t[8];
            comp_mole[12] = t[10] - t[8]; // äºŒæ°§åŒ–é‹¯
            t[8] = 0;
            t[10] = 0;
        }
    }
    
    // è™•ç† Mgï¼ˆmg_type: 1=ç™½é›²çŸ³, 2=æ»‘çŸ³, 3=ç¢³é…¸é‚ï¼‰
    if (mg_type == 3) {
        comp_mole[4] = t[5]; // ç¢³é…¸é‚
        t[5] = 0;
        comp_mole[1] = t[2]; // ç¢³é…¸éˆ£
        t[2] = 0;
    } else if (mg_type == 1) { // ç™½é›²çŸ³
        if (t[2] >= t[5]) {
            comp_mole[6] = t[5]; // ç™½é›²çŸ³
            comp_mole[1] = t[2] - t[5]; // ç¢³é…¸éˆ£
            t[2] = 0;
            t[5] = 0;
        } else {
            comp_mole[6] = t[2]; // ç™½é›²çŸ³
            comp_mole[1] = 0;
            t[5] -= t[2];
            t[2] = 0;
            if (t[8] >= t[5] / 3 * 4) {
                comp_mole[7] = t[5] / 3; // æ»‘çŸ³
                t[8] -= comp_mole[7] * 4;
                t[5] = 0;
            } else {
                comp_mole[7] = t[8] / 4; // æ»‘çŸ³
                t[5] -= comp_mole[7] * 3;
                t[8] = 0;
                comp_mole[4] = t[5]; // ç¢³é…¸é‚
                t[5] = 0;
            }
        }
    } else if (mg_type == 2) { // æ»‘çŸ³
        if (t[8] >= t[5] / 3 * 4) {
            comp_mole[7] = t[5] / 3; // æ»‘çŸ³
            t[8] -= comp_mole[7] * 4;
            t[5] = 0;
            comp_mole[1] = t[2]; // ç¢³é…¸éˆ£
            t[2] = 0;
        } else {
            comp_mole[7] = t[8] / 4; // æ»‘çŸ³
            t[5] -= comp_mole[7] * 3;
            t[8] = 0;
            if (t[2] > t[5]) {
                comp_mole[6] = t[5]; // ç™½é›²çŸ³
                comp_mole[1] = t[2] - t[5]; // ç¢³é…¸éˆ£
                t[5] = 0;
            } else {
                comp_mole[6] = t[2]; // ç™½é›²çŸ³
                comp_mole[4] = t[5] - t[2]; // ç¢³é…¸é‚
                t[5] = 0;
            }
            t[2] = 0;
        }
    }
    
    // è™•ç† Al
    if (t[7] > 0) {
        if (t[8] >= t[7] * 2) {
            comp_mole[8] = t[7]; // é«˜å¶ºåœŸ
            t[8] -= comp_mole[8] * 2;
            t[7] = 0;
        } else {
            comp_mole[8] = t[8] / 2; // é«˜å¶ºåœŸ
            t[7] -= comp_mole[8];
            t[8] = 0;
            comp_mole[9] = t[7]; // æ°§åŒ–é‹
            t[7] = 0;
        }
    }
    
    comp_mole[10] = t[8]; // çŸ³è‹±
    
    // åˆ†å­é‡è¡¨ï¼ˆ0=é•·çŸ³, 1=ç¢³é…¸éˆ£, 2=ç¢³é…¸é‹‡, 3=æ°§åŒ–é‹…, 4=ç¢³é…¸é‚, 5=ç¢³é…¸é¶,
    //         6=ç™½é›²çŸ³, 7=æ»‘çŸ³, 8=é«˜å¶ºåœŸ, 9=æ°§åŒ–é‹, 10=çŸ³è‹±,
    //         11=äºŒæ°§åŒ–éˆ¦, 12=äºŒæ°§åŒ–é‹¯, 13=çŸ½é…¸é‹¯, 14=äºŒæ°§åŒ–éŒ«ï¼‰
    const molecular_weight = [
        molecular_weight_0, 100, 197, 81, 84, 148, 184, 379, 258, 102, 60, 80, 123, 183, 151
    ];
    
    // è¨ˆç®—é‡é‡ç™¾åˆ†æ¯”
    let total = 0;
    const comp_weight = new Array(15);
    for (let i = 0; i <= 14; i++) {
        comp_weight[i] = comp_mole[i] * molecular_weight[i];
        total += comp_weight[i];
    }
    
    for (let i = 0; i <= 14; i++) {
        result.percentages[i] = (comp_weight[i] / total * 100);
    }
    
    // è¨ˆç®—ä¸­é…¸æ¯”
    if (si + ti + zr + sn > 0 && al > 0) {
        const ratio_val = (si + ti + zr + sn) / al;
        result.ratio = "1:" + ratio_val.toFixed(1);
    }
    
    return result;
}









function clear_for_next() {
    f = 1; f2 = 0; mg = 1; zr = 1; kna_f = 0; mg_f = 0; ca_f = 0; al_f = 0; si_f = 0; i = 0; j = 0; total = 0; ca_min = 0; mg_min = 0; al_min = 0; si_min = 0; ratio = 0
    for (i = 0; i <= 12; i++) {
        segar_mole[i] = 0
        min_mole[i] = 0
        t[i] = 0
    }
    for (i = 0; i <= 15; i++) {
        composition_mole[i] = 0
        molecular_weight[i] = 0
        composition_weight[i] = 0
        composition_in_percentage[i] = 0
        composition_in_percentage_int[i] = 0
    } 
}

function to_int(form) {
    for (i = 0; i <= 14; i++) {
        if (form.p[i].value == "") form.p[i].value = "0"
        composition_in_percentage[i] = parseFloat(form.p[i].value)
        form.p[i].value = composition_in_percentage[i].toFixed(0)
        if (form.p[i].value == "0") form.p[i].value = ""
     }
     // âœ… åŠ å…¥é€™è¡Œ
     checkPercentComplete(form);
}

function to_to(form) {
    for (i = 0; i <= 14; i++) {
        if (form.p[i].value == "") form.p[i].value = "0"
        composition_in_percentage[i] = parseFloat(form.p[i].value)
        form.p[i].value = composition_in_percentage[i].toFixed(1)
        if (form.p[i].value == "0.0") form.p[i].value = ""
     }
    check_percent(form)
    // âœ… åŠ å…¥é€™è¡Œ
    checkPercentComplete(form);
}

function bay(form) {
    for (i = 0; i <= 14; i++) {
        if (form.p[i].value == "") form.p[i].value = "0"
        composition_in_percentage[i] = parseFloat(form.p[i].value)
        form.p[i].value = composition_in_percentage[i] * parseFloat(form.multiple_value.value)
        if (form.p[i].value == "0") form.p[i].value = ""
     }
    check_percent(form)
    // âœ… åŠ å…¥é€™è¡Œ
    checkPercentComplete(form);
}

function calculate_100(form) {
    // âœ… å…ˆæ›´æ–°é¸å–®ï¼ˆåœ¨æ‰€æœ‰è¨ˆç®—ä¹‹å‰ï¼‰
    setTimeout(() => {
        updateGlazeType1(form);
        updateGlazeType2(form);
    }, 100);  // å»¶é² 100ms ç¢ºä¿ DOM å·²æ›´æ–°
    
    // âœ… æª¢æŸ¥ç™¾åˆ†æ¯”é…æ–¹æ˜¯å¦å®Œæ•´
    const btn2 = document.getElementById('calculateBtn2');
    if (btn2 && !btn2.value.includes('âœ“')) {
        alert('æ³¨æ„ï¼é€™ä¸¦éå®Œæ•´é…æ–¹');
    }
    
    form.kna.value = ""
    form.ca.value = ""
    form.ba.value = ""
    form.zn.value = ""
    form.mg.value = ""
    form.sr.value = ""
    form.al.value = ""
    form.si.value = ""
    form.ti.value = ""
    form.zr.value = ""
    form.sn.value = ""
    
    // ä½¿ç”¨èˆ‡ refer() å’Œ calculate_segar() ç›¸åŒçš„æ–°ç‰ˆä¿‚æ•¸
    if (form.f[0].checked) { molecular_weight[0] = 451; kna_f2 = 0.9420; ca_f2 = 0.0568; mg_f2 = 0.0011; al_f2 = 1.0401; si_f2 = 4.5997; }   // éœæ­£
    if (form.f[1].checked) { molecular_weight[0] = 872; kna_f2 = 0.9432; ca_f2 = 0.0549; mg_f2 = 0.0018; al_f2 = 1.1672; si_f2 = 11.2996; }  // æ—¥åŒ–
    if (form.f[2].checked) { molecular_weight[0] = 592; kna_f2 = 0.9828; ca_f2 = 0.0161; mg_f2 = 0.0012; al_f2 = 1.0519; si_f2 = 6.6741; }   // å°åº¦
    if (form.f[3].checked) { molecular_weight[0] = 571; kna_f2 = 0.9588; ca_f2 = 0.0287; mg_f2 = 0.0126; al_f2 = 0.9732; si_f2 = 6.4918; }   // æ¾³æ´²
    if (form.f[4].checked) { molecular_weight[0] = 646; kna_f2 = 0.9035; ca_f2 = 0.0959; mg_f2 = 0.0006; al_f2 = 0.8964; si_f2 = 8.1056; }   // é‡œæˆ¶
    if (form.f[5].checked) { molecular_weight[0] = 800; kna_f2 = 0.9155; ca_f2 = 0.0828; mg_f2 = 0.0016; al_f2 = 1.0330; si_f2 = 10.3023; }  // SH-1
    if (form.f[6].checked) { molecular_weight[0] = 741; kna_f2 = 1.0000; ca_f2 = 0.0000; mg_f2 = 0.0000; al_f2 = 1.0929; si_f2 = 9.1143; }   // ç¦å³¶
    if (form.f[7].checked) { molecular_weight[0] = 689; kna_f2 = 0.9581; ca_f2 = 0.0349; mg_f2 = 0.0070; al_f2 = 1.0896; si_f2 = 8.4093; }   // æ–°å¹³æ´¥
    if (form.f[8].checked) { molecular_weight[0] = 617; kna_f2 = 0.9670; ca_f2 = 0.0331; mg_f2 = 0.0000; al_f2 = 1.0431; si_f2 = 7.1302; }   // å¡æ–¯ç‰¹    
    molecular_weight[1] = 100;
    molecular_weight[2] = 197;
    molecular_weight[3] = 81;
    molecular_weight[4] = 84;
    molecular_weight[5] = 148;
    molecular_weight[6] = 184;
    molecular_weight[7] = 379;
    molecular_weight[8] = 258;
    molecular_weight[9] = 102;
    molecular_weight[10] = 60;
    molecular_weight[11] = 80;
    molecular_weight[12] = 123;
    molecular_weight[13] = 183;
    molecular_weight[14] = 151;
    
    total = 0
    for (i = 1; i <= 11; i++) { segar_mole[i] = 0 }
    for (i = 0; i <= 14; i++) {
        // âœ… ä¸ä¿®æ”¹åŸå§‹å€¼ï¼Œç›´æ¥ç”¨ || 0 è™•ç†ç©ºç™½
        composition_in_percentage[i] = parseFloat(form.p[i].value) || 0;
        total += composition_in_percentage[i]
        composition_mole[i] = composition_in_percentage[i] / molecular_weight[i];
    }    
    segar_mole[1] = composition_mole[0] * kna_f2
    segar_mole[2] = composition_mole[1] + ca_f2 * composition_mole[0] + composition_mole[6]
    segar_mole[3] = composition_mole[2]
    segar_mole[4] = composition_mole[3]
    segar_mole[5] = composition_mole[4] + mg_f2 * composition_mole[0] + composition_mole[6] + 3 * composition_mole[7]
    segar_mole[6] = composition_mole[5]
    segar_mole[7] = composition_mole[9] + al_f2 * composition_mole[0] + composition_mole[8]
    segar_mole[8] = composition_mole[10] + si_f2 * composition_mole[0] + composition_mole[7] * 4.0 + composition_mole[8] * 2.0 + composition_mole[13]
    segar_mole[9] = composition_mole[11]
    segar_mole[10] = composition_mole[12] + composition_mole[13]
    segar_mole[11] = composition_mole[14]
    
    correct = 1
    var normal = 0
    for (i = 1; i <= 6; i++) normal += segar_mole[i] 
    if (normal == 0) {
        normal = 1
        window.alert("ç¼ºé¹¼æ€§é‡‘å±¬ï¼æ­¤éå®Œæ•´è³½æ ¼é‡‰å¼ã€‚");
    } 
    
    if (correct == 1) {
        for (i = 1; i <= 11; i++) { 
            segar_mole[i] /= normal; 
            segar_mole[i] = Math.round(segar_mole[i] * 100000) / 100000 
        }
        if (segar_mole[1] > 0) form.kna.value = segar_mole[1]
        if (segar_mole[2] > 0) form.ca.value = segar_mole[2]
        if (segar_mole[3] > 0) form.ba.value = segar_mole[3]
        if (segar_mole[4] > 0) form.zn.value = segar_mole[4]
        if (segar_mole[5] > 0) form.mg.value = segar_mole[5]
        if (segar_mole[6] > 0) form.sr.value = segar_mole[6]
        if (segar_mole[7] > 0) form.al.value = segar_mole[7]
        if (segar_mole[8] > 0) form.si.value = segar_mole[8]
        if (segar_mole[9] > 0) form.ti.value = segar_mole[9]
        if (segar_mole[10] > 0) form.zr.value = segar_mole[10]
        if (segar_mole[11] > 0) form.sn.value = segar_mole[11] 
        
        ex_ave = (segar_mole[8] * ex_si + segar_mole[7] * ex_al + segar_mole[1] * ex_kna + segar_mole[4] * ex_zn + segar_mole[2] * ex_ca + segar_mole[5] * ex_mg + segar_mole[3] * ex_ba + segar_mole[6] * ex_sr) / (segar_mole[8] + segar_mole[7] + segar_mole[1] + segar_mole[4] + segar_mole[2] + segar_mole[5] + segar_mole[3] + segar_mole[6]) 
        
        ratio = Math.round(100 * (segar_mole[8] + segar_mole[9] + segar_mole[10] + segar_mole[11]) / segar_mole[7]) / 100
        form.r.value = "1:" + ratio
        total = Math.round(total * 10000) / 10000
        if (segar_mole[7] * segar_mole[8] == 0) form.r.value = "ç„¡"
  
        refer(form)
        analysis(form)
    } 
    
    if (form.kna.value == "0") form.kna.value = "" 
    clear_for_next()
    checkPercentComplete(form);
}






//  å­˜æª”åŠŸèƒ½æŠŠç•¶å‰é…æ–¹å­˜æˆ JSON æª”æ¡ˆä¸‹è¼‰æš«å­˜å€æŒ‰ã€Œå­˜1ã€ã€Œå­˜2ã€æ™‚ï¼ŒæŠŠè³‡æ–™å­˜åˆ°è¨˜æ†¶é«”Undo/Redoè¨˜éŒ„æ“ä½œæ­·å²ï¼Œè®“ã€Œä¸Šä¸€æ­¥ã€åŠŸèƒ½èƒ½å›å¾©
function serializeForm(form){
  const data = { fields:{} , radios:{} , checks:{} };
  const inputs = form.querySelectorAll('input, textarea, select');
  
  const nameCount = {};
  inputs.forEach(el=>{
    if(!el.name) return;
    if(el.type==='radio') return;
    if(el.type==='checkbox') return;
    nameCount[el.name]=(nameCount[el.name]||0)+1;
  });
  
  Object.keys(nameCount).forEach(n=>{
    if(nameCount[n]>1){ data.fields[n]=[]; }
  });
  
  inputs.forEach(el=>{
    if(!el.name) return;
    if(el.type==='radio'){
      const list = form.querySelectorAll(`input[type="radio"][name="${el.name}"]`);
      let idx = -1;
      list.forEach((r,i)=>{ if(r.checked) idx=i;});
      data.radios[el.name]=idx;
    }else if(el.type==='checkbox'){
      data.checks[el.name]=el.checked?1:0;
    }else{
      if(Array.isArray(data.fields[el.name])){
        data.fields[el.name].push(el.value);
      }else{
        data.fields[el.name]=el.value;
      }
    }
  });
  return data;
}


//  ä½¿ç”¨å ´æ™¯ğŸ“‚ è¼‰å…¥æª”æ¡ˆï¼šè®€å– JSON æª”æ¡ˆå¾Œå¡«å›è¡¨å–®    ğŸ“‹ å–å‡ºæš«å­˜ï¼šæŒ‰ã€Œå–1ã€~ã€Œå–5ã€    â†©ï¸ ä¸Šä¸€æ­¥/ä¸‹ä¸€æ­¥ï¼šé‚„åŸæ­·å²è¨˜éŒ„
function deserializeForm(form, data){
  if(!data) return;
  Object.keys(data.fields||{}).forEach(n=>{
    const els = form.querySelectorAll(`[name="${n}"]`);
    if(Array.isArray(data.fields[n])){
      els.forEach((el,i)=>{ if(i<data.fields[n].length) el.value = data.fields[n][i]; });
    }else{
      els.forEach((el,i)=>{ if(i===0) el.value = data.fields[n]; });
    }
  });
  Object.keys(data.radios||{}).forEach(n=>{
    const idx = data.radios[n];
    const radios = form.querySelectorAll(`input[type="radio"][name="${n}"]`);
    if(idx>=0 && idx<radios.length){ radios[idx].checked = true; }
  });
  Object.keys(data.checks||{}).forEach(n=>{
    const el = form.querySelector(`input[type="checkbox"][name="${n}"]`);
    if(el){ el.checked = !!data.checks[n]; }
  });
}

function saveData(form){
  const json = serializeForm(form);
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm   = String(now.getMonth()+1).padStart(2,"0");
  const dd   = String(now.getDate()).padStart(2,"0");
  const hh   = String(now.getHours()).padStart(2,"0");
  const mi   = String(now.getMinutes()).padStart(2,"0");
  const ss   = String(now.getSeconds()).padStart(2,"0");
  const filename = `glaze_${yyyy}${mm}${dd}_${hh}${mi}${ss}.json`;
  
  const blob = new Blob([JSON.stringify(json,null,2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
}

function handleFile(input, form){
  const file = input.files && input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      deserializeForm(form, data);
      pushSnapshot(form);
    }catch(err){
      alert("æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é¸æ“‡æœ¬ç¨‹å¼åŒ¯å‡ºçš„ JSONã€‚");
    }
    input.value = "";
  };
  reader.readAsText(file);
}

// Undo/Redo åŠŸèƒ½
let historyStack = [];
let redoStack = [];
let saveTimer = null;


//  è¡¨å–®è®Šå‹• â†’ pushSnapshot() â†’ å­˜å…¥æ­·å²å †ç–Š200å€‹ â†’ ä¾› undo/redo ä½¿ç”¨
function pushSnapshot(form){
  const snapshot = JSON.stringify(serializeForm(form));
  if(historyStack.length === 0 || historyStack[historyStack.length-1] !== snapshot){
    historyStack.push(snapshot);
    if(historyStack.length > 200) historyStack.shift();
  }
  redoStack = [];
}

//  æŠ€è¡“åè©é€™å« Debounceï¼ˆé˜²æŠ–å‹•ï¼‰å°±åƒè‡ªå‹•å­˜æª”å»¶é²50msï¼šä¸æ˜¯ç«‹åˆ»å­˜ï¼Œè€Œæ˜¯ã€Œç¢ºèªä½ åœä¸‹ä¾†äº†ã€æ‰å­˜ï¼Œé¿å…ç˜‹ç‹‚å­˜æª”ã€‚
function saveState(form){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{
    pushSnapshot(form);
  },50);
}

//   æ­·å²è¨˜éŒ„ â†’ applySnapshot() â†’ é‚„åŸåˆ°è¡¨å–®ç•«é¢
function applySnapshot(form, snapshot){
  try{
    const data = JSON.parse(snapshot);
    deserializeForm(form, data);
  }catch(e){}
}


function undo(form){
  if(historyStack.length <= 1) return;
  const current = historyStack.pop();
  redoStack.push(current);
  const prev = historyStack[historyStack.length-1];
  applySnapshot(form, prev);
  
  // âœ… è§¸ç™¼æ‰€æœ‰ç›¸é—œè¨ˆç®—ä»¥æ›´æ–°é¡¯ç¤º
  if(form){
    updateFeldsparName(form);  // æ›´æ–°é•·çŸ³åç¨±
    refer(form);               // æ›´æ–°æœ€å°å€¼
    check_jen(form);           // æ›´æ–°é¹¼è«è€³æ•¸å’Œä¸è¶³é¡
    check_percent(form);       // æ›´æ–°ç™¾åˆ†æ¯”ç¸½å’Œ
    checkSegarComplete(form); // âœ… åŠ å…¥é€™è¡Œ
    checkPercentComplete(form); // âœ… åŠ å…¥é€™è¡Œ
  }
}

function redo(form){
  if(redoStack.length === 0) return;
  const snap = redoStack.pop();
  historyStack.push(snap);
  applySnapshot(form, snap);
  
  // âœ… è§¸ç™¼æ‰€æœ‰ç›¸é—œè¨ˆç®—ä»¥æ›´æ–°é¡¯ç¤º
  if(form){
    updateFeldsparName(form);  // æ›´æ–°é•·çŸ³åç¨±
    refer(form);               // æ›´æ–°æœ€å°å€¼
    check_jen(form);           // æ›´æ–°é¹¼è«è€³æ•¸å’Œä¸è¶³é¡
    check_percent(form);       // æ›´æ–°ç™¾åˆ†æ¯”ç¸½å’Œ
    checkSegarComplete(form); // âœ… åŠ å…¥é€™è¡Œ
    checkPercentComplete(form); // âœ… åŠ å…¥é€™è¡Œ
  }
}



document.addEventListener('DOMContentLoaded', ()=>{
  const form = document.forms[0];
  if(!form) return;
  
  pushSnapshot(form);
  form.addEventListener('input', ()=>saveState(form), true);
  form.addEventListener('change', ()=>saveState(form), true);
  
  [
    'calculate_segar','calculate_100','reset_data',
    'ADD_Ca','ADD_Ba','ADD_Zn','ADD_Mg','ADD_Sr',
    'fill_Ca_min','fill_Mg_min','fill_Al_min','fill_Si_min',
    'set_default_values','to_int','to_to','bay'
  ].forEach(fn=>{
    if(typeof window[fn] === 'function'){
      const orig = window[fn];
      window[fn] = function(){
        const res = orig.apply(this, arguments);
        const formArg = arguments[0];
        if(formArg && formArg.tagName === 'FORM'){
          saveState(formArg);
        }else{
          saveState(form);
        }
        return res;
      }
    }
  });
});










// æ¨™æº–åŒ–é¹¼ç³»åˆ—
// ========== ä¸»ç¨‹å¼ï¼šjen_standardize() ==========
function jen_standardize() {
  const names = ["kna","ca","ba","zn","mg","sr","al","si","ti","zr","sn"];

  const newWin = window.open("about:blank", "_blank");
  
  newWin.document.write('<div style="max-width:95%; margin:0 auto; padding:20px;">');

  function log(msg) {
    newWin.document.write(msg.replace(/\n/g, "<br>") + "<br><br>");
  }

  const getNum = (el) => {
    if (!el) return 0;
    const v = parseFloat(el.value);
    return Number.isFinite(v) ? v : 0;
  };

function getCurrentFType() {
  const radios = document.getElementsByName("f");
  for (let i = 0; i < radios.length; i++) {
    if (radios[i].checked) return i + 1;
  }
  return 1;  // âœ… æ”¹æˆ 1ï¼ˆéœæ­£ï¼‰
}

  function getCurrentMgType() {
    const radios = document.getElementsByName("m");
    for (let i = 0; i < radios.length; i++) {
      if (radios[i].checked) return i + 1;
    }
    return 2;
  }

  function clearRows2to6() {
    for (let r = 2; r <= 6; r++) {
      for (let i = 1; i <= 11; i++) {
        const el = (r === 2)
          ? document.getElementById("out" + i)
          : document.getElementById(`row${r}col${i}`);
        if (el) el.value = "";
      }
    }
  }

  const srcVals = names.map(n => {
    const el = document.getElementById(n);
    const raw = el ? el.value.trim() : "";
    return raw === "" ? "" : raw;
  });

  const allEmptyOrZero = srcVals.every(v => v === "" || parseFloat(v) === 0);
  if (allEmptyOrZero) {
    clearRows2to6();
    log("âš ï¸ æ²’æœ‰æ•¸å­—ï¼Œç¨‹å¼ä¸åŸ·è¡Œ");
    newWin.document.write('</div>');
    return;
  }

  const mgMinEl = document.getElementById("mg_min");
  const mgMinVal = getNum(mgMinEl);
  const anySrcNegative = srcVals.some(v => v !== "" && parseFloat(v) < 0);
  if (anySrcNegative || (mgMinEl && mgMinEl.value.trim() !== "" && mgMinVal < 0)) {
    clearRows2to6();
    log("âŒ éŒ¯èª¤å¡æ ¼é‡‰å¼");
    newWin.document.write('</div>');
    return;
  }

  // å‡½æ•¸ï¼šè¨ˆç®—ä¸¦æ”¶é›†å–®ä¸€æ¨¡å¼çš„çµæœ
  function calculateMode(mode) {
    for (let i = 0; i < names.length; i++) {
      const src  = document.getElementById(names[i]);
      const dest = document.getElementById("out" + (i+1));
      if (dest) dest.value = src ? src.value : "";
    }

    const val5 = getNum(document.getElementById("out5"));
    const val2 = getNum(document.getElementById("out2"));
    const val3 = getNum(document.getElementById("out3"));
    const val4 = getNum(document.getElementById("out4"));
    const val6 = getNum(document.getElementById("out6"));
    const result = val5 - mgMinVal + val2 + val3 + val4 + val6;

    const out2El = document.getElementById("out2");
    if (out2El) out2El.value = result;
    const out5El = document.getElementById("out5");
    if (out5El) out5El.value = mgMinVal;
    ["out3", "out4", "out6"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });

    // row3 å¡«å…¥
    for (let i = 1; i <= 11; i++) {
      const src = document.getElementById("out" + i);
      const dest = document.getElementById("row3col" + i);
      if (!src || !dest) continue;
      let v = getNum(src);
      if (i === 2) v = v - 0.2;
      if (i === 3) v = v + 0.2;
      dest.value = src.value.trim() === "" && i !== 2 && i !== 3 ? "" : v;
    }

    // å¼·åŒ–æ¨¡å¼èª¿æ•´ row3
    if (mode === 'enhanced') {
      const row3col2 = document.getElementById("row3col2");
      if (row3col2 && row3col2.value !== "") {
        row3col2.value = parseFloat(row3col2.value) - 0.1;
      }
      const row3col3 = document.getElementById("row3col3");
      if (row3col3 && row3col3.value !== "") {
        row3col3.value = parseFloat(row3col3.value) + 0.1;
      }
    }

    // row4 å¡«å…¥
    for (let i = 1; i <= 11; i++) {
      const src = document.getElementById("row3col" + i);
      const dest = document.getElementById("row4col" + i);
      if (!src || !dest) continue;
      if (i === 3) { dest.value = ""; continue; }
      if (i === 4) { dest.value = 0.2; continue; }
      dest.value = src.value;
    }

    // å¼·åŒ–æ¨¡å¼èª¿æ•´ row4
    if (mode === 'enhanced') {
      const row4col4 = document.getElementById("row4col4");
      if (row4col4 && row4col4.value !== "") {
        row4col4.value = parseFloat(row4col4.value) + 0.1;
      }
    }

    // row5 å¡«å…¥
    for (let i = 1; i <= 11; i++) {
      const src = document.getElementById("row4col" + i);
      const dest = document.getElementById("row5col" + i);
      if (!src || !dest) continue;
      if (i === 4) { dest.value = ""; continue; }
      if (i === 5) {
        const base = getNum(src);
        dest.value = (src.value.trim() === "" ? "" : (base + 0.2));
        continue;
      }
      dest.value = src.value;
    }

    // å¼·åŒ–æ¨¡å¼èª¿æ•´ row5
    if (mode === 'enhanced') {
      const row5col5 = document.getElementById("row5col5");
      if (row5col5 && row5col5.value !== "") {
        row5col5.value = parseFloat(row5col5.value) + 0.1;
      }
    }

    // row6 å¡«å…¥
    for (let i = 1; i <= 11; i++) {
      const src = document.getElementById("row3col" + i);
      const dest = document.getElementById("row6col" + i);
      if (!src || !dest) continue;
      if (i === 3) { dest.value = ""; continue; }
      if (i === 6) { dest.value = 0.2; continue; }
      dest.value = src.value;
    }

    // å¼·åŒ–æ¨¡å¼èª¿æ•´ row6
    if (mode === 'enhanced') {
      const row6col6 = document.getElementById("row6col6");
      if (row6col6 && row6col6.value !== "") {
        row6col6.value = parseFloat(row6col6.value) + 0.1;
      }
    }

    normalize_series_ABCD(0);

    const ABCD = [];
    const f_type = getCurrentFType();
    const mg_type = getCurrentMgType();

    savedData2[0].forEach((row) => {
      const segarData = parseSegarFromRow(row);
      const result = calculate_segar_pure({ ...segarData, f_type, mg_type });
      if (result.correct) ABCD.push(result.percentages);
    });

    // ä¿å­˜ alkaliTable çš„å¿«ç…§
    const sourceTable = document.getElementById('alkaliTable');
    let tableSnapshot = null;
    if (sourceTable) {
      tableSnapshot = {
        headers: [],
        rows: []
      };
      const headers = sourceTable.rows[0].cells;
      for (let i = 0; i < headers.length; i++) {
        tableSnapshot.headers.push(headers[i].textContent);
      }
      
      for (let r = 1; r < sourceTable.rows.length; r++) {
        const rowData = [];
        const cells = sourceTable.rows[r].cells;
        for (let c = 0; c < cells.length; c++) {
          const input = cells[c].querySelector('input');
          let value = input ? input.value : '';
          if (value !== '') {
            const num = parseFloat(value);
            if (!isNaN(num)) {
              value = num.toFixed(4);
            }
          }
          rowData.push(value);
        }
        tableSnapshot.rows.push(rowData);
      }
    }

    return { ABCD, f_type, tableSnapshot };
  }

  // è¨ˆç®—æ­£å¸¸æ¨¡å¼
  const normalResult = calculateMode('normal');
  
  // è¨ˆç®—å¼·åŒ–æ¨¡å¼
  const enhancedResult = calculateMode('enhanced');

  // ç”Ÿæˆå…©çµ„çµæœçš„ HTML
  function generateHTML(result, mode) {
    const feldsparNames = {
      1: "éœæ­£é•·çŸ³", 2: "æ—¥åŒ–é•·çŸ³", 3: "å—éé•·çŸ³", 4: "é‡œæˆ¶é•·çŸ³",
      5: "æ¾³æ´²é•·çŸ³", 6: "å°åº¦é•·çŸ³", 7: "å®‰é¤Šé•·çŸ³"
    };
    const feldsparLabel = feldsparNames[result.f_type] || "é•·çŸ³";

    const colHeaders = [
      feldsparLabel,"ç¢³é…¸éˆ£","ç¢³é…¸é‹‡","æ°§åŒ–é‹…","ç¢³é…¸é‚","ç¢³é…¸é¶",
      "ç™½é›²çŸ³","æ»‘çŸ³","é«˜å¶ºåœŸ","æ°§åŒ–é‹","äºŒæ°§åŒ–çŸ½(çŸ³è‹±)",
      "äºŒæ°§åŒ–éˆ¦(é‡‘ç´…çŸ³)","äºŒæ°§åŒ–é‹¯","çŸ½é…¸é‹¯","äºŒæ°§åŒ–éŒ«"
    ];

    const rowLabels = ["Caé‡‰","Baé‡‰","Zné‡‰","Mgé‡‰","Sré‡‰"];

    let html = '';
    
    // è³½æ ¼é‡‰å¼è¡¨æ ¼
    if (result.tableSnapshot) {
      html += `<h2 style="color:#333;margin-top:40px;margin-bottom:10px;font-size:24px;">ğŸ’– è³½æ ¼é‡‰å¼ (${mode === 'enhanced' ? 'å¼·åŒ–æ¨¡å¼' : 'æ­£å¸¸æ¨¡å¼'})</h2>`;
      html += '<h3 style="color:#666;margin-top:5px;margin-bottom:10px;font-size:18px;">æ¨™æº–åŒ– é¹¼ç³»åˆ—è¡¨æ ¼</h3>';
      html += '<table border="1" cellspacing="0" cellpadding="8" style="border-collapse:collapse;font-family:monospace;text-align:center;margin-bottom:30px;font-size:16px;width:90%;">';
      
      html += '<tr style="background:#ffe0e0;font-weight:bold;">';
      html += '<th style="padding:10px;"></th>';
      result.tableSnapshot.headers.forEach(h => {
        html += '<th style="padding:10px;">' + h + '</th>';
      });
      html += '</tr>';
      
      const segarRowLabels = ['Caé‡‰', 'Baé‡‰', 'Zné‡‰', 'Mgé‡‰', 'Sré‡‰'];
      result.tableSnapshot.rows.forEach((row, rIndex) => {
        html += '<tr>';
        html += '<td style="background:#f9f9f9;font-weight:bold;padding:10px;">' + (segarRowLabels[rIndex] || '') + '</td>';
        row.forEach(value => {
          html += '<td style="padding:10px;">' + value + '</td>';
        });
        html += '</tr>';
      });
      html += '</table>';
    }

    // åŸæ–™ç™¾åˆ†æ¯”è¡¨æ ¼
    html += `<h3 style="margin-bottom:10px;">ğŸ’– åŸæ–™ç™¾åˆ†æ¯” (${mode === 'enhanced' ? 'å¼·åŒ–æ¨¡å¼' : 'æ­£å¸¸æ¨¡å¼'})</h3>`;
    html += `
      <table border="1" cellspacing="0" cellpadding="10" style="border-collapse:collapse;font-family:monospace;text-align:center;font-size:18px;width:90%;line-height:1.6;margin-bottom:60px;">
        <tr style="background:#ffe0e0;font-weight:bold;">
          <th></th>
          ${colHeaders.map(h => `<th style="white-space:pre-line;">${h.replace(/(.{3})/g,"$1\n")}</th>`).join("")}
        </tr>
    `;

    result.ABCD.forEach((row, rIndex) => {
      html += `<tr><td style="background:#f9f9f9;font-weight:bold;">${rowLabels[rIndex] || ""}</td>`;
      html += row.map(v => {
        const val = Math.round(v);
        return `<td>${val === 0 ? "" : val}</td>`;
      }).join("");
      html += "</tr>";
    });

    html += "</table>";
    
    return html;
  }





  // å‰¯ç¨‹å¼ï¼šç”Ÿæˆçµ„åˆè¡¨æ ¼  jen_standardizeå‘¼å«
  function generateCombinationTable(win, enhancedData) {
    win.document.write(`
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                  padding: 30px; 
                  margin: 60px 0; 
                  text-align: center; 
                  border-radius: 10px;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <h2 style="color: white; 
                   font-size: 32px; 
                   margin: 0; 
                   text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                   letter-spacing: 2px;">
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        </h2>
        <h2 style="color: white; 
                   font-size: 28px; 
                   margin: 15px 0; 
                   text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
          â¬‡ï¸ é™„éŒ„: ä»¥ä¸‹ç‚ºCa Ba Zn Mgå„ç¨®å…¨éƒ¨çµ„åˆ â¬‡ï¸
        </h2>
        <h2 style="color: white; 
                   font-size: 32px; 
                   margin: 0; 
                   text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                   letter-spacing: 2px;">
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        </h2>
      </div>
    `);
    
    const caRow = (enhancedData.tableSnapshot && enhancedData.tableSnapshot.rows[0]) || [];
    const baRow = (enhancedData.tableSnapshot && enhancedData.tableSnapshot.rows[1]) || [];
    const znRow = (enhancedData.tableSnapshot && enhancedData.tableSnapshot.rows[2]) || [];
    const mgRow = (enhancedData.tableSnapshot && enhancedData.tableSnapshot.rows[3]) || [];
    
    const combinationHeaders = ["KNa", "Ca", "Ba", "Zn", "Mg", "Sr", "Al", "Si", "Ti", "Zr", "Sn"];
    
    win.document.write('<table border="1" cellspacing="0" cellpadding="8" style="border-collapse:collapse;font-family:monospace;text-align:center;margin-bottom:30px;font-size:16px;width:90%;">');
    
    win.document.write('<tr style="background:#ffe0e0;font-weight:bold;">');
    win.document.write('<th style="padding:10px;"></th>');
    for (let h = 0; h < combinationHeaders.length; h++) {
      win.document.write('<th style="padding:10px;">' + combinationHeaders[h] + '</th>');
    }
    win.document.write('</tr>');
    
    for (let i = 1; i <= 16; i++) {
      win.document.write('<tr>');
      win.document.write('<td style="background:#f9f9f9;font-weight:bold;padding:10px;">' + i + '</td>');
      
      // å®šç¾©å…¬å¼æ˜ å°„
      const formulas = {
        1: { type: 'direct', row: caRow },           // 1=C
        2: { type: 'formula', calc: (j) => (2 * parseFloat(caRow[j] || 0) + parseFloat(mgRow[j] || 0)) / 3 }, // 2=2C+M
        3: { type: 'formula', calc: (j) => (parseFloat(caRow[j] || 0) + 2 * parseFloat(mgRow[j] || 0)) / 3 }, // 3=C+2M
        4: { type: 'direct', row: mgRow },           // 4=M
        5: { type: 'formula', calc: (j) => (2 * parseFloat(caRow[j] || 0) + parseFloat(baRow[j] || 0)) / 3 }, // 5=2C+B
        6: { type: 'formula', calc: (j) => (2 * parseFloat(caRow[j] || 0) + parseFloat(znRow[j] || 0)) / 3 }, // 6=2C+Z
        7: { type: 'formula', calc: (j) => (parseFloat(baRow[j] || 0) + 2 * parseFloat(mgRow[j] || 0)) / 3 }, // 7=B+2M
        8: { type: 'formula', calc: (j) => (parseFloat(znRow[j] || 0) + 2 * parseFloat(mgRow[j] || 0)) / 3 }, // 8=Z+2M
        9: { type: 'formula', calc: (j) => (2 * parseFloat(baRow[j] || 0) + parseFloat(caRow[j] || 0)) / 3 }, // 9=2B+C
        10: { type: 'formula', calc: (j) => (2 * parseFloat(baRow[j] || 0) + parseFloat(mgRow[j] || 0)) / 3 }, // 10=2B+M
        11: { type: 'formula', calc: (j) => (parseFloat(caRow[j] || 0) + 2 * parseFloat(znRow[j] || 0)) / 3 }, // 11=C+2Z
        12: { type: 'formula', calc: (j) => (2 * parseFloat(znRow[j] || 0) + parseFloat(mgRow[j] || 0)) / 3 }, // 12=2Z+M
        13: { type: 'direct', row: baRow },          // 13=B
        14: { type: 'formula', calc: (j) => (2 * parseFloat(baRow[j] || 0) + parseFloat(znRow[j] || 0)) / 3 }, // 14=2B+Z
        15: { type: 'formula', calc: (j) => (parseFloat(baRow[j] || 0) + 2 * parseFloat(znRow[j] || 0)) / 3 }, // 15=B+2Z
        16: { type: 'direct', row: znRow }           // 16=Z
      };
      
      const config = formulas[i];
      
      if (config) {
        if (config.type === 'direct') {
          // ç›´æ¥è¤‡è£½ä¾†æºæ•¸æ“š
          for (let j = 0; j < 11; j++) {
            const value = config.row[j] !== undefined && config.row[j] !== null ? config.row[j] : '';
            win.document.write('<td style="padding:10px;">' + value + '</td>');
          }
        } else if (config.type === 'formula') {
          // è¨ˆç®—å…¬å¼
          for (let j = 0; j < 11; j++) {
            const result = config.calc(j);
            const value = result === 0 ? '' : result.toFixed(4);
            win.document.write('<td style="padding:10px;">' + value + '</td>');
          }
        }
      } else {
        // ç©ºç™½åˆ—
        for (let j = 0; j < 11; j++) {
          win.document.write('<td style="padding:10px;"></td>');
        }
      }
      
      win.document.write('</tr>');
    }
    
    win.document.write('</table>');
  }

  newWin.document.write(generateHTML(normalResult, 'normal'));
  
  newWin.document.write(`
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                padding: 30px; 
                margin: 60px 0; 
                text-align: center; 
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
      <h2 style="color: white; 
                 font-size: 32px; 
                 margin: 0; 
                 text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                 letter-spacing: 2px;">
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      </h2>
      <h2 style="color: white; 
                 font-size: 28px; 
                 margin: 15px 0; 
                 text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
        â¬‡ï¸ ä»¥ä¸‹ç‚ºå¼·åŒ–æ¨¡å¼çµæœ â¬‡ï¸
      </h2>
      <h2 style="color: white; 
                 font-size: 32px; 
                 margin: 0; 
                 text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                 letter-spacing: 2px;">
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      </h2>
    </div>
  `);
  
  newWin.document.write(generateHTML(enhancedResult, 'enhanced'));
  
  generateCombinationTable(newWin, enhancedResult);
  
  newWin.document.write("<hr style='margin-top:20px;'><small>ç”± jen_standardize() è‡ªå‹•ç”Ÿæˆ</small>");
  newWin.document.write('</div>');
}
// ========== jen_standardize() çµæŸ ==========









// è§£æå‰¯ç¨‹å¼  ç”±jen_standardizeå‘¼å«
function parseSegarFromRow(row) {
  const names = ["kna","ca","ba","zn","mg","sr","al","si","ti","zr","sn"];
  const data = {};
  if (Array.isArray(row)) {
    for (let i = 0; i < names.length; i++) {
      const v = parseFloat(row[i]);
      data[names[i]] = Number.isFinite(v) ? v : 0;
    }
    return data;
  }
  if (row && row.cells) {
    for (let i = 0; i < names.length; i++) {
      let cell = row.cells[i];
      let value = 0;
      if (cell) {
        if (cell.querySelector("input")) {
          value = parseFloat(cell.querySelector("input").value) || 0;
        } else {
          value = parseFloat(cell.textContent.trim()) || 0;
        }
      }
      data[names[i]] = value;
    }
    return data;
  }
  return names.reduce((acc, n) => ({ ...acc, [n]: 0 }), {});
}













//  jen_standardizeå‘¼å«
// è¢« jen_standardize() èª¿ç”¨ï¼Œåœ¨ç”Ÿæˆã€Œæ¨™æº–åŒ–é¹¼ç³»åˆ—ã€æ™‚ï¼š
// 1. ç”¨æˆ¶æŒ‰ä¸‹ã€Œæ¨™æº–åŒ–é¹¼ç³»åˆ—ã€æŒ‰éˆ•
// 2. jen_standardize() ç”Ÿæˆ Caé‡‰ã€Baé‡‰ã€Zné‡‰ã€Mgé‡‰ã€Sré‡‰
// 3. normalize_series_ABCD() æŠŠé€™äº›è³‡æ–™ä¿å­˜èµ·ä¾†
// 4. åœ¨æ–°è¦–çª—é¡¯ç¤ºè¡¨æ ¼å’Œç™¾åˆ†æ¯”é…æ–¹

function normalize_series_ABCD(slot = 0) {
  const tableEl = document.querySelector('#alkaliTable');
  if (!tableEl) {
    console.warn("âš ï¸ æ‰¾ä¸åˆ°æ¨™æº–åŒ–é¹¼ç³»åˆ—è¡¨æ ¼");
    return;
  }
  
  if (!Array.isArray(window.TempData))   window.TempData = [];
  if (!Array.isArray(window.savedData2)) window.savedData2 = [];
  
  const lines = [];
  const texts = document.querySelectorAll('input[type="text"]');
  texts.forEach((el, idx) => {
    const id   = el.id   ? `id=${el.id}`     : "";
    const name = el.name ? `name=${el.name}` : "";
    lines.push(`[TEXT ${idx+1}] ${id} ${name} : "${el.value}"`);
  });
  
  const radios = document.querySelectorAll('input[type="radio"]');
  const radioGroups = {};
  radios.forEach(el => {
    if (el.name && !radioGroups[el.name]) {
      radioGroups[el.name] = document.querySelector(`input[name="${el.name}"]:checked`);
    }
  });
  
  Object.keys(radioGroups).forEach((groupName, idx) => {
    const chosen = radioGroups[groupName];
    const value = chosen ? chosen.value : "(æœªé¸)";
    lines.push(`[RADIO ${idx+1}] ç¾¤çµ„=${groupName}, é¸ä¸­="${value}"`);
  });
  
  // å„²å­˜ TempData
  TempData[slot] = lines.slice();

  // å„²å­˜è¡¨æ ¼è³‡æ–™
  const rows = Array.from(tableEl.querySelectorAll('tr')).slice(1, 6);
  const savedRows = rows.map(r => {
    return Array.from(r.querySelectorAll('td')).map(cell => {
      const inp = cell.querySelector('input');
      return inp ? inp.value : cell.textContent.trim();
    });
  });
  savedData2[slot] = savedRows;

  console.log("âœ… normalize_series_ABCD(): å·²å„²å­˜ TempData èˆ‡ savedData2ï¼Œä¸é–‹è¦–çª—ã€‚");
  console.log("TempData[" + slot + "] =", TempData[slot]);
  console.log("savedData2[" + slot + "] =", savedData2[slot]);
}



//   æ›´æ–°ã€Œæš«å­˜å€ã€5 å€‹æŒ‰éˆ•çš„é¡¯ç¤ºç‹€æ…‹ï¼ˆé¡è‰²ã€å•Ÿç”¨/ç¦ç”¨ï¼‰
function renderSlots(){
  for(let i=0;i<5;i++){
    const saveBtn = document.getElementById(`saveBtn${i+1}`);
    const loadBtn = document.getElementById(`loadBtn${i+1}`);
    if(!saveBtn || !loadBtn) continue;
    
    if(slotHasData(i)){
      // æœ‰è³‡æ–™ï¼šå–æŒ‰éˆ•è®Šç¶ è‰²ï¼Œå­˜æŒ‰éˆ•ä¿æŒåŸè‰²
      saveBtn.style.backgroundColor = '';
      saveBtn.style.fontWeight = '';
      loadBtn.style.backgroundColor = '#90EE90';
      loadBtn.style.fontWeight = 'bold';
      loadBtn.disabled = false;
    }else{
      // æ²’è³‡æ–™ï¼šå–æŒ‰éˆ•æ¢å¾©åŸè‰²ä¸”ç¦ç”¨
      saveBtn.style.backgroundColor = '';
      saveBtn.style.fontWeight = '';
      loadBtn.style.backgroundColor = '';
      loadBtn.style.fontWeight = '';
      loadBtn.disabled = true;
    }
  }
}

//   å•ï¼šã€Œå­˜ã€æœ‰æ²’æœ‰å­˜è³‡æ–™ï¼Ÿ  ç­”ï¼šslotHasData(0) â†’ true/false
function slotHasData(slot) {
  return Array.isArray(window.savedData) && savedData[slot] && Array.isArray(savedData[slot]) && savedData[slot].length > 0;
}





function showAllValues(slot = 0) {
  // âœ… æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®
  const hadData = slotHasData(slot);
  
  const lines = [];
  const texts = document.querySelectorAll('input[type="text"]');
  texts.forEach((el, idx) => {
    const id = el.id ? `id=${el.id}` : "";
    const name = el.name ? `name=${el.name}` : "";
    lines.push(`[TEXT ${idx+1}] ${id} ${name} : "${el.value}"`);
  });
  
  const radios = document.querySelectorAll('input[type="radio"]');
  const radioGroups = {};
  radios.forEach(el => {
    if (el.name && !radioGroups[el.name]) {
      radioGroups[el.name] = document.querySelector(`input[name="${el.name}"]:checked`);
    }
  });
  
  Object.keys(radioGroups).forEach((groupName, idx) => {
    const chosen = radioGroups[groupName];
    const value = chosen ? chosen.value : "(æœªé¸)";
    lines.push(`[RADIO ${idx+1}] ç¾¤çµ„=${groupName}, é¸ä¸­="${value}"`);
  });
  
  if (!Array.isArray(window.savedData)) window.savedData = [];
  savedData[slot] = lines;
  
  // âœ… å¦‚æœä¹‹å‰æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºè¦†ç›–æç¤º
if (hadData) {
    const saveBtn = document.getElementById('saveBtn' + (slot + 1));
    if (saveBtn) {
      // åˆ›å»ºæç¤ºå…ƒç´ 
      const tooltip = document.createElement('span');
      tooltip.textContent = 'å·²è¦†è“‹èˆŠè³‡æ–™';
      tooltip.style.cssText = 'position: absolute; background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 3px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 1000; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 4px; white-space: nowrap;';
      
      // æ’å…¥åˆ°æŒ‰é’®æ—è¾¹
      saveBtn.parentNode.style.position = 'relative';
      saveBtn.parentNode.appendChild(tooltip);
      
      // 1ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        tooltip.remove();
      }, 1000);
    }
  }  
  // å¯ç”¨å¯¹åº”çš„"å–"æŒ‰é’®å¹¶è®¾ç½® cursor
  const loadBtn = document.getElementById('loadBtn' + (slot + 1));
  if (loadBtn) {
    loadBtn.disabled = false;
    loadBtn.style.opacity = '1';
    loadBtn.style.cursor = 'pointer';
  }
  
  // æ”¹å˜"å­˜"æŒ‰é’®èƒŒæ™¯è‰²ä¸ºç»¿è‰²
  const saveBtn = document.getElementById('saveBtn' + (slot + 1));
  if (saveBtn) {
    saveBtn.style.background = '#90EE90';
    saveBtn.classList.add('has-data');
  }
  
  renderSlots();
}

function loadValues(slot = 0) {
  if (!slotHasData(slot)) {
    alert("æ­¤çµ„å°šæœªå­˜æª”!");
    return;
  }
  
  const allTexts = Array.from(document.querySelectorAll('input[type="text"]'));
  const nameCounters = {};
  
  savedData[slot].forEach(line => {
    if (line.startsWith("[TEXT")) {
      const m = line.match(/^\[TEXT\s+(\d+)\]\s+(?:id=([^\s]*)\s*)?(?:name=([^\s]*)\s*)?:\s*"([^"]*)"/);
      if (!m) return;
      const index = parseInt(m[1], 10) - 1;
      const id = m[2] || "";
      const name = m[3] || "";
      const value = m[4];
      if (id) {
        const byId = document.getElementById(id);
        if (byId) { byId.value = value; return; }
      }
      if (allTexts[index]) { allTexts[index].value = value; return; }
      if (name) {
        const group = document.getElementsByName(name);
        const k = nameCounters[name] || 0;
        if (group[k]) {
          group[k].value = value;
          nameCounters[name] = k + 1;
          return;
        }
      }
    }
    if (line.startsWith("[RADIO")) {
      const match = line.match(/ç¾¤çµ„=([^,]+), é¸ä¸­="([^"]*)"/);
      if (match) {
        const groupName = match[1];
        const value = match[2];
        const radios = document.querySelectorAll(`input[name="${groupName}"]`);
        radios.forEach(r => { r.checked = (r.value === value); });
      }
    }
  });
  
  savedData[slot] = null;
  
  // ç¦ç”¨å¯¹åº”çš„"å–"æŒ‰é’®å¹¶è®¾ç½® cursor
  const loadBtn = document.getElementById('loadBtn' + (slot + 1));
  if (loadBtn) {
    loadBtn.disabled = true;
    loadBtn.style.opacity = '0.5';
    loadBtn.style.cursor = 'not-allowed';
  }
  
  // æ¢å¤"å­˜"æŒ‰é’®èƒŒæ™¯è‰²
  const saveBtn = document.getElementById('saveBtn' + (slot + 1));
  if (saveBtn) {
    saveBtn.style.background = '#f5e0ff';
    saveBtn.classList.remove('has-data');
  }
  
  renderSlots();
}

document.addEventListener('DOMContentLoaded', renderSlots);



































// Stull Chart
// Stull Chart
// Stull Chart  å·²ç¶“å»¢æ£„ä¸ç”¨äº†
  function stull_v2() {
  const siMinInput = document.getElementById('si_min');
  const siMinRaw   = siMinInput ? parseFloat(siMinInput.value) : NaN;
  const baseValNum = 0
  const x1Str  = baseValNum.toFixed(4);
  const x4Str  = (baseValNum + 20).toFixed(4);
  
  const alMinInput = document.getElementById('al_min');
  const alMinRaw   = alMinInput ? parseFloat(alMinInput.value) : NaN;
  
  const yAxisLength = 10;
  const xAxisLength = 30;
  const xTicks = [5, 12, 19, 26];
  const yTicks = [2, 4, 6, 8];
  
  const y1Num     = baseValNum / 10;
  const y1ShowNum = Number.isFinite(alMinRaw) ? Math.max(y1Num, alMinRaw) : y1Num;
  const y1Str     = y1ShowNum.toFixed(4);
  const y4Str     = (y1ShowNum + 0.15).toFixed(4);
  
  const W=640, H=360, ml=72, mr=20, mt=24, mb=64;
  const plotW=W-ml-mr, plotH=H-mt-mb;
  
  // SVG ç”Ÿæˆå‡½æ•¸
  function generateSVG(x1Val, x4Val, y1Val, y4Val) {
    const x2px = x => ml + (x / xAxisLength) * plotW;
    const y2px = y => H - mb - (y / yAxisLength) * plotH;
    const y0 = y2px(0), yTop = y2px(yAxisLength);
    
    let svg = '<svg width="'+W+'" height="'+H+'" viewBox="0 0 '+W+' '+H+'" xmlns="http://www.w3.org/2000/svg">';
    svg += '<defs><marker id="arr" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#333"/></marker></defs>';
    svg += '<line x1="'+ml+'" y1="'+y0+'" x2="'+(ml+plotW)+'" y2="'+y0+'" stroke="#333" stroke-width="1.6" marker-end="url(#arr)"/>';
    svg += '<line x1="'+ml+'" y1="'+y0+'" x2="'+ml+'" y2="'+(yTop-2)+'" stroke="#333" stroke-width="1.6" marker-end="url(#arr)"/>';
    
    for (const xt of xTicks) {
      svg += '<line x1="'+x2px(xt)+'" y1="'+y0+'" x2="'+x2px(xt)+'" y2="'+yTop+'" stroke="#999" stroke-dasharray="4 4"/>';
      svg += '<line x1="'+x2px(xt)+'" y1="'+y0+'" x2="'+x2px(xt)+'" y2="'+(y0+6)+'" stroke="#333"/>';
    }
    for (const yt of yTicks) {
      svg += '<line x1="'+ml+'" y1="'+y2px(yt)+'" x2="'+(ml+plotW)+'" y2="'+y2px(yt)+'" stroke="#bbb" stroke-dasharray="4 4"/>';
      svg += '<line x1="'+ml+'" y1="'+y2px(yt)+'" x2="'+(ml-6)+'" y2="'+y2px(yt)+'" stroke="#333"/>';
    }
    for (const yt of yTicks) {
      for (const xt of xTicks) {
        svg += '<circle cx="'+x2px(xt)+'" cy="'+y2px(yt)+'" r="3" fill="#333"/>';
      }
    }
    
    // åº§æ¨™è½‰æ›å‡½æ•¸
    const si2abstract = (si) => {
      return 5 + (si - x1Val) / (x4Val - x1Val) * (26 - 5);
    };
    const al2abstract = (al) => {
      return 2 + (al - y1Val) / (y4Val - y1Val) * (8 - 2);
    };

    // 1:5 æ–œç‡ç·š
    const test_si1 = 0, test_al1 = test_si1 / 5;
    const abs_x1 = si2abstract(test_si1), abs_y1 = al2abstract(test_al1);
    const test_si2 = 20, test_al2 = test_si2 / 5;
    const abs_x2 = si2abstract(test_si2), abs_y2 = al2abstract(test_al2);
    svg += '<line x1="'+x2px(abs_x1)+'" y1="'+y2px(abs_y1)+'" x2="'+x2px(abs_x2)+'" y2="'+y2px(abs_y2)+'" stroke="#87CEEB" stroke-width="2" stroke-dasharray="8 4"/>';
    svg += '<text x="'+(x2px((abs_x1+abs_x2)/2))+'" y="'+(y2px((abs_y1+abs_y2)/2)-8)+'" fill="#87CEEB" font-size="14" font-weight="bold">1:5</text>';

    // 1:10 æ–œç‡ç·š
    const test_si3 = 0, test_al3 = test_si3 / 10;
    const abs_x3 = si2abstract(test_si3), abs_y3 = al2abstract(test_al3);
    const test_si4 = 20, test_al4 = test_si4 / 10;
    const abs_x4 = si2abstract(test_si4), abs_y4 = al2abstract(test_al4);
    svg += '<line x1="'+x2px(abs_x3)+'" y1="'+y2px(abs_y3)+'" x2="'+x2px(abs_x4)+'" y2="'+y2px(abs_y4)+'" stroke="#87CEEB" stroke-width="2" stroke-dasharray="8 4"/>';
    svg += '<text x="'+(x2px((abs_x3+abs_x4)/2))+'" y="'+(y2px((abs_y3+abs_y4)/2)+15)+'" fill="#87CEEB" font-size="14" font-weight="bold">1:10</text>';

    // 1:15 æ–œç‡ç·š
    const test_si5 = 0, test_al5 = test_si5 / 15;
    const abs_x5 = si2abstract(test_si5), abs_y5 = al2abstract(test_al5);
    const test_si6 = 20, test_al6 = test_si6 / 15;
    const abs_x6 = si2abstract(test_si6), abs_y6 = al2abstract(test_al6);
    svg += '<line x1="'+x2px(abs_x5)+'" y1="'+y2px(abs_y5)+'" x2="'+x2px(abs_x6)+'" y2="'+y2px(abs_y6)+'" stroke="#87CEEB" stroke-width="2" stroke-dasharray="8 4"/>';
    svg += '<text x="'+(x2px((abs_x5+abs_x6)/2))+'" y="'+(y2px((abs_y5+abs_y6)/2)+15)+'" fill="#87CEEB" font-size="14" font-weight="bold">1:15</text>';

    // é ‚éƒ¨æ¨™è¨»
    const topCenterX = ml + plotW / 2;
    const topY = mt + 15;
    svg += '<text x="'+topCenterX+'" y="'+topY+'" text-anchor="middle" fill="#87CEEB" font-size="25" font-weight="bold">ä¸­é…¸æ¯”ç‚º 1:5  1:10  1:15</text>';

    // ABCD æ¨™ç±¤
    svg += '<text x="'+(x2px(xTicks[0])+8)+'" y="'+(y2px(2)+4)+'" fill="#d00" font-weight="700">A</text>';
    svg += '<text x="'+(x2px(xTicks[0])+8)+'" y="'+(y2px(8)+4)+'" fill="#d00" font-weight="700">B</text>';
    svg += '<text x="'+(x2px(xTicks[3])+8)+'" y="'+(y2px(8)+4)+'" fill="#d00" font-weight="700">C</text>';
    svg += '<text x="'+(x2px(xTicks[3])+8)+'" y="'+(y2px(2)+4)+'" fill="#d00" font-weight="700">D</text>';
    
    // åº§æ¨™è»¸æ¨™ç±¤
    svg += '<text x="'+x2px(xTicks[0])+'" y="'+(y0+22)+'" text-anchor="middle" fill="#333" id="si_x1">'+x1Val.toFixed(4)+'</text>';
    svg += '<text x="'+x2px(xTicks[3])+'" y="'+(y0+22)+'" text-anchor="middle" fill="#333" id="si_x4">'+x4Val.toFixed(4)+'</text>';
    svg += '<text x="'+(ml+plotW/2)+'" y="'+(H-18)+'" text-anchor="middle" fill="#333">Si</text>';
    svg += '<text x="'+(ml-10)+'" y="'+(y2px(2)+4)+'" text-anchor="end" fill="#333" id="al_y1">'+y1Val.toFixed(4)+'</text>';
    svg += '<text x="'+(ml-10)+'" y="'+(y2px(8)+4)+'" text-anchor="end" fill="#333" id="al_y4">'+y4Val.toFixed(4)+'</text>';
    svg += '<text x="'+(ml-30)+'" y="'+(yTop-10)+'" text-anchor="end" fill="#333">Al</text>';
    svg += '</svg>';
    
    return svg;
  }
  
  const svg = generateSVG(parseFloat(x1Str), parseFloat(x4Str), parseFloat(y1Str), parseFloat(y4Str));
  
  const tableHtml =
    '<table class="vals" style="font-size: 20px;"><thead><tr><th></th><th>Al</th><th>Si</th></tr></thead><tbody>'+
      '<tr><td class="lbl">A</td><td class="num">'+y1Str+'</td><td class="num">'+x1Str+'</td></tr>'+
      '<tr><td class="lbl">B</td><td class="num">'+y4Str+'</td><td class="num">'+x1Str+'</td></tr>'+
      '<tr><td class="lbl">C</td><td class="num">'+y4Str+'</td><td class="num">'+x4Str+'</td></tr>'+
      '<tr><td class="lbl">D</td><td class="num">'+y1Str+'</td><td class="num">'+x4Str+'</td></tr>'+
    '</tbody></table>';
  
  const sources = [
    { label: 'KNa', sels: ['#KNa','#kna','[name="KNa"]','[name="kna"]'] },
    { label: 'Ca',  sels: ['#Ca','#ca','[name="Ca"]','[name="ca"]'] },
    { label: 'Ba',  sels: ['#Ba','#ba','[name="Ba"]','[name="ba"]'] },
    { label: 'Zn',  sels: ['#Zn','#zn','[name="Zn"]','[name="zn"]'] },
    { label: 'Mg',  sels: ['#Mg','#mg','[name="Mg"]','[name="mg"]'] },
    { label: 'Sr',  sels: ['#Sr','#sr','[name="Sr"]','[name="sr"]'] },
    { label: 'Ti',  sels: ['#Ti','#ti','[name="Ti"]','[name="ti"]'] },
    { label: 'Zr',  sels: ['#Zr','#zr','[name="Zr"]','[name="zr"]'] },
    { label: 'Sn',  sels: ['#Sn','#sn','[name="Sn"]','[name="sn"]'] },
  ];
  
  function normalizeNumberText(s){
    if(s==null)return '';
    return String(s)
      .replace(/[ï¼-ï¼™]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFF10+0x30))
      .replace(/ï¼/g,'.').replace(/[ï¼Œ,]/g,'').replace(/\u00A0|\u3000/g,' ')
      .replace(/\s+/g,'').replace(/%/g,'');
  }
  
  function readFirstNumeric(selectors){
    for(const sel of selectors){
      const el=document.querySelector(sel);
      if(!el) continue;
      const raw=('value' in el)? el.value : (el.textContent||el.innerText||'');
      const num=parseFloat(normalizeNumberText(raw));
      if(Number.isFinite(num)) return num;
    }
    return null;
  }
  
  let rightHtml='';
  for(const {label,sels} of sources){
    const v=readFirstNumeric(sels);
    if(v==null) continue;
    const r=+v.toFixed(4);
    if(r===0) continue;
    rightHtml += '<div class="note">'+label+'= <span class="blue">'+r.toFixed(4)+'</span></div>';
  }
  
  const radioF = document.querySelector('input[name="f"]:checked');
  const feldsparType = radioF ? radioF.value : "æœªé¸æ“‡";
  
  const extraHtml =
    '<div class="note" style="margin-top:12px">é•·çŸ³ç¨®é¡ï¼š' + feldsparType + '</div>'+
    '<div class="note">ä»¥åŠå¤–åŠ ï¼š_____________</div>';
  
  const w = window.open('', 'stull_chart_v2');
  if (!w) { alert('å½ˆå‡ºè¦–çª—è¢«ç€è¦½å™¨é˜»æ“‹'); return; }
  w.document.open();
  w.document.write(
    '<!DOCTYPE html><html><head><meta charset="utf-8" />' +
    '<title>Stull Chartï¼ˆç›´è§’åæ¨™ï¼‰</title>' +
    '<style>' +
      'body{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#f4f4f4;color:#333;line-height:1.3;margin:0;padding:20px}' +
      'h1{margin:0 0 8px 0;font-weight:700}.meta{font-size:12px;color:#777;margin-bottom:12px}' +
      '.wrap{display:flex;gap:28px;align-items:flex-start}' +
      '.leftcol{display:flex;flex-direction:column;gap:12px}' +
      '.vector{position:relative}.vector svg{background:#fff;border:1px solid #ddd;border-radius:6px}' +
      '.si-controls{position:absolute;bottom:12px;left:50%;transform:translateX(80px);display:flex;gap:8px}' +
      '.si-controls button{width:36px;height:36px;font-size:20px;font-weight:bold;border:2px solid #333;cursor:pointer;border-radius:6px}' +
      '.si-controls button:first-child{background:#ff6b6b;color:#fff}' +
      '.si-controls button:first-child:hover{background:#ee5555}' +
      '.si-controls button:last-child{background:#51cf66;color:#fff}' +
      '.si-controls button:last-child:hover{background:#40c057}' +
      '.vector svg{background:#fff;border:1px solid #ddd;border-radius:6px}' +
      '.vals{border-collapse:collapse;background:#fff;font-family:inherit}' +
      '.vals th,.vals td{border:2px solid #333;padding:6px 12px;text-align:center}' +
      '.lbl{color:#d00;font-weight:700}.num{color:#06c;font-weight:700}' +
      '.side{min-width:180px}.side .note{font-size:20px;line-height:1.8;letter-spacing:.5px}' +
      '.blue{color:#00f;font-weight:700}.red{color:#d00;font-weight:700}' +
      '.bigtable{border-collapse:collapse;margin-top:40px;width:100%;background:#fff}' +
      '.bigtable td{border:1px solid #333;padding:10px;text-align:center;height:40px;font-size:18px}' +
      '.bigtable td:first-child{color:#d00;font-weight:bold;font-size:24px}' +
      '.calc-btn{margin-top:16px;padding:12px 24px;font-size:18px;font-weight:bold;background:#4c6ef5;color:#fff;border:none;border-radius:8px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,0.2)}' +
      '.calc-btn:hover{background:#3b5bdb}' +
      '.calc-btn:active{transform:translateY(1px)}' +
    '</style></head><body>' +
      '<h1>Stull Chartï¼ˆç›´è§’åæ¨™ï¼‰</h1>' +
      '<div class="meta">version: stull_v2 Â· ' + new Date().toLocaleString() + '</div>' +
      '<div class="wrap">' +
        '<div class="leftcol">' +
          '<div class="vector" id="svgContainer">' + 
            svg + 
            '<div class="si-controls">' +
              '<button onclick="decreaseSi()">âˆ’</button>' +
              '<button onclick="increaseSi()">+</button>' +
            '</div>' +
          '</div>' +
          tableHtml +
          '<button class="calc-btn" onclick="startCalculation()">ğŸ§® è¨ˆç®—ç™¾åˆ†æ¯”</button>' +
        '</div>' +
        '<div class="side">' + rightHtml + extraHtml + '</div>' +
      '</div>' +
      '<div id="results"></div>'
  );
  
  w.recipeParams = { svg: svg, tableHtml: tableHtml, rightHtml: rightHtml, extraHtml: extraHtml };
  w.calculationStarted = false;
  w.adjustCounter = 0;
  
  // å°‡ SVG ç”Ÿæˆå‡½æ•¸ä¹Ÿå¯«å…¥å½ˆå‡ºè¦–çª—
  w.document.write('<script>');
  w.document.write('function generateSVGInWindow(x1Val,x4Val,y1Val,y4Val){');
  w.document.write('var W=640,H=360,ml=72,mr=20,mt=24,mb=64;');
  w.document.write('var plotW=W-ml-mr,plotH=H-mt-mb;');
  w.document.write('var xAxisLength=30,yAxisLength=10;');
  w.document.write('var xTicks=[5,12,19,26],yTicks=[2,4,6,8];');
  w.document.write('var x2px=function(x){return ml+(x/xAxisLength)*plotW;};');
  w.document.write('var y2px=function(y){return H-mb-(y/yAxisLength)*plotH;};');
  w.document.write('var y0=y2px(0),yTop=y2px(yAxisLength);');
  w.document.write('var svg=\'<svg width="\'+W+\'" height="\'+H+\'" viewBox="0 0 \'+W+\' \'+H+\'" xmlns="http://www.w3.org/2000/svg">\';');
  w.document.write('svg+=\'<defs><marker id="arr" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#333"/></marker></defs>\';');
  w.document.write('svg+=\'<line x1="\'+ml+\'" y1="\'+y0+\'" x2="\'+(ml+plotW)+\'" y2="\'+y0+\'" stroke="#333" stroke-width="1.6" marker-end="url(#arr)"/>\';');
  w.document.write('svg+=\'<line x1="\'+ml+\'" y1="\'+y0+\'" x2="\'+ml+\'" y2="\'+(yTop-2)+\'" stroke="#333" stroke-width="1.6" marker-end="url(#arr)"/>\';');
  w.document.write('for(var i=0;i<xTicks.length;i++){var xt=xTicks[i];');
  w.document.write('svg+=\'<line x1="\'+x2px(xt)+\'" y1="\'+y0+\'" x2="\'+x2px(xt)+\'" y2="\'+yTop+\'" stroke="#999" stroke-dasharray="4 4"/>\';');
  w.document.write('svg+=\'<line x1="\'+x2px(xt)+\'" y1="\'+y0+\'" x2="\'+x2px(xt)+\'" y2="\'+(y0+6)+\'" stroke="#333"/>\';');
  w.document.write('}');
  w.document.write('for(var i=0;i<yTicks.length;i++){var yt=yTicks[i];');
  w.document.write('svg+=\'<line x1="\'+ml+\'" y1="\'+y2px(yt)+\'" x2="\'+(ml+plotW)+\'" y2="\'+y2px(yt)+\'" stroke="#bbb" stroke-dasharray="4 4"/>\';');
  w.document.write('svg+=\'<line x1="\'+ml+\'" y1="\'+y2px(yt)+\'" x2="\'+(ml-6)+\'" y2="\'+y2px(yt)+\'" stroke="#333"/>\';');
  w.document.write('}');
  w.document.write('for(var i=0;i<yTicks.length;i++){for(var j=0;j<xTicks.length;j++){');
  w.document.write('svg+=\'<circle cx="\'+x2px(xTicks[j])+\'" cy="\'+y2px(yTicks[i])+\'" r="3" fill="#333"/>\';');
  w.document.write('}}');
  w.document.write('var si2abstract=function(si){return 5+(si-x1Val)/(x4Val-x1Val)*(26-5);};');
  w.document.write('var al2abstract=function(al){return 2+(al-y1Val)/(y4Val-y1Val)*(8-2);};');
  w.document.write('var test_si1=1.0,test_al1=test_si1/5;');
  w.document.write('var abs_x1=si2abstract(test_si1),abs_y1=al2abstract(test_al1);');
  w.document.write('var test_si2=8.0,test_al2=test_si2/5;');
  w.document.write('var abs_x2=si2abstract(test_si2),abs_y2=al2abstract(test_al2);');
  w.document.write('svg+=\'<line x1="\'+x2px(abs_x1)+\'" y1="\'+y2px(abs_y1)+\'" x2="\'+x2px(abs_x2)+\'" y2="\'+y2px(abs_y2)+\'" stroke="#87CEEB" stroke-width="2" stroke-dasharray="8 4"/>\';');
  w.document.write('svg+=\'<text x="\'+(x2px((abs_x1+abs_x2)/2))+\'" y="\'+(y2px((abs_y1+abs_y2)/2)-8)+\'" fill="#87CEEB" font-size="14" font-weight="bold">1:5</text>\';');
  w.document.write('var test_si3=1.0,test_al3=test_si3/10;');
  w.document.write('var abs_x3=si2abstract(test_si3),abs_y3=al2abstract(test_al3);');
  w.document.write('var test_si4=8.0,test_al4=test_si4/10;');
  w.document.write('var abs_x4=si2abstract(test_si4),abs_y4=al2abstract(test_al4);');
  w.document.write('svg+=\'<line x1="\'+x2px(abs_x3)+\'" y1="\'+y2px(abs_y3)+\'" x2="\'+x2px(abs_x4)+\'" y2="\'+y2px(abs_y4)+\'" stroke="#87CEEB" stroke-width="2" stroke-dasharray="8 4"/>\';');
  w.document.write('svg+=\'<text x="\'+(x2px((abs_x3+abs_x4)/2))+\'" y="\'+(y2px((abs_y3+abs_y4)/2)+15)+\'" fill="#87CEEB" font-size="14" font-weight="bold">1:10</text>\';');
  w.document.write('var test_si5=1.0,test_al5=test_si5/15;');
  w.document.write('var abs_x5=si2abstract(test_si5),abs_y5=al2abstract(test_al5);');
  w.document.write('var test_si6=8.0,test_al6=test_si6/15;');
  w.document.write('var abs_x6=si2abstract(test_si6),abs_y6=al2abstract(test_al6);');
  w.document.write('svg+=\'<line x1="\'+x2px(abs_x5)+\'" y1="\'+y2px(abs_y5)+\'" x2="\'+x2px(abs_x6)+\'" y2="\'+y2px(abs_y6)+\'" stroke="#87CEEB" stroke-width="2" stroke-dasharray="8 4"/>\';');
  w.document.write('svg+=\'<text x="\'+(x2px((abs_x5+abs_x6)/2))+\'" y="\'+(y2px((abs_y5+abs_y6)/2)+15)+\'" fill="#87CEEB" font-size="14" font-weight="bold">1:15</text>\';');
  w.document.write('var topCenterX=ml+plotW/2,topY=mt+15;');
  w.document.write('svg+=\'<text x="\'+topCenterX+\'" y="\'+topY+\'" text-anchor="middle" fill="#87CEEB" font-size="25" font-weight="bold">ä¸­é…¸æ¯”ç‚º 1:5  1:10  1:15</text>\';');
  w.document.write('svg+=\'<text x="\'+(x2px(xTicks[0])+8)+\'" y="\'+(y2px(2)+4)+\'" fill="#d00" font-weight="700">A</text>\';');
  w.document.write('svg+=\'<text x="\'+(x2px(xTicks[0])+8)+\'" y="\'+(y2px(8)+4)+\'" fill="#d00" font-weight="700">B</text>\';');
  w.document.write('svg+=\'<text x="\'+(x2px(xTicks[3])+8)+\'" y="\'+(y2px(8)+4)+\'" fill="#d00" font-weight="700">C</text>\';');
  w.document.write('svg+=\'<text x="\'+(x2px(xTicks[3])+8)+\'" y="\'+(y2px(2)+4)+\'" fill="#d00" font-weight="700">D</text>\';');
  w.document.write('svg+=\'<text x="\'+x2px(xTicks[0])+\'" y="\'+(y0+22)+\'" text-anchor="middle" fill="#333" id="si_x1">\'+x1Val.toFixed(4)+\'</text>\';');
  w.document.write('svg+=\'<text x="\'+x2px(xTicks[3])+\'" y="\'+(y0+22)+\'" text-anchor="middle" fill="#333" id="si_x4">\'+x4Val.toFixed(4)+\'</text>\';');
  w.document.write('svg+=\'<text x="\'+(ml+plotW/2)+\'" y="\'+(H-18)+\'" text-anchor="middle" fill="#333">Si</text>\';');
  w.document.write('svg+=\'<text x="\'+(ml-10)+\'" y="\'+(y2px(2)+4)+\'" text-anchor="end" fill="#333" id="al_y1">\'+y1Val.toFixed(4)+\'</text>\';');
  w.document.write('svg+=\'<text x="\'+(ml-10)+\'" y="\'+(y2px(8)+4)+\'" text-anchor="end" fill="#333" id="al_y4">\'+y4Val.toFixed(4)+\'</text>\';');
  w.document.write('svg+=\'<text x="\'+(ml-30)+\'" y="\'+(yTop-10)+\'" text-anchor="end" fill="#333">Al</text>\';');
  w.document.write('svg+=\'</svg>\';');
  w.document.write('return svg;');
  w.document.write('}');
  
  // +/- æŒ‰éˆ•å‡½æ•¸
  w.document.write('function increaseSi(){');
  w.document.write('var cells=document.querySelectorAll(\'.vals tbody .num\');');
  w.document.write('var newAl1=(parseFloat(cells[0].textContent)+0.05).toFixed(4);');
  w.document.write('var newSi1=(parseFloat(cells[1].textContent)+0.5).toFixed(4);');
  w.document.write('var newAl4=(parseFloat(cells[2].textContent)+0.05).toFixed(4);');
  w.document.write('var newSi4=(parseFloat(cells[5].textContent)+0.5).toFixed(4);');
  w.document.write('cells[0].textContent=newAl1;cells[1].textContent=newSi1;');
  w.document.write('cells[2].textContent=newAl4;cells[3].textContent=newSi1;');
  w.document.write('cells[4].textContent=newAl4;cells[5].textContent=newSi4;');
  w.document.write('cells[6].textContent=newAl1;cells[7].textContent=newSi4;');
  w.document.write('var newSvg=generateSVGInWindow(parseFloat(newSi1),parseFloat(newSi4),parseFloat(newAl1),parseFloat(newAl4));');
  w.document.write('var container=document.getElementById(\'svgContainer\');');
  w.document.write('var oldSvg=container.querySelector(\'svg\');');
  w.document.write('if(oldSvg)oldSvg.remove();');
  w.document.write('container.insertAdjacentHTML(\'afterbegin\',newSvg);');
  w.document.write('window.adjustCounter++;');
  w.document.write('}');
  
  w.document.write('function decreaseSi(){');
  w.document.write('if(window.adjustCounter<=0)return;');
  w.document.write('var cells=document.querySelectorAll(\'.vals tbody .num\');');
  w.document.write('var newAl1=(parseFloat(cells[0].textContent)-0.05).toFixed(4);');
  w.document.write('var newSi1=(parseFloat(cells[1].textContent)-0.5).toFixed(4);');
  w.document.write('var newAl4=(parseFloat(cells[2].textContent)-0.05).toFixed(4);');
  w.document.write('var newSi4=(parseFloat(cells[5].textContent)-0.5).toFixed(4);');
  w.document.write('cells[0].textContent=newAl1;cells[1].textContent=newSi1;');
  w.document.write('cells[2].textContent=newAl4;cells[3].textContent=newSi1;');
  w.document.write('cells[4].textContent=newAl4;cells[5].textContent=newSi4;');
  w.document.write('cells[6].textContent=newAl1;cells[7].textContent=newSi4;');
  w.document.write('var newSvg=generateSVGInWindow(parseFloat(newSi1),parseFloat(newSi4),parseFloat(newAl1),parseFloat(newAl4));');
  w.document.write('var container=document.getElementById(\'svgContainer\');');
  w.document.write('var oldSvg=container.querySelector(\'svg\');');
  w.document.write('if(oldSvg)oldSvg.remove();');
  w.document.write('container.insertAdjacentHTML(\'afterbegin\',newSvg);');
  w.document.write('window.adjustCounter--;');
  w.document.write('}');
  
  w.document.write('function startCalculation(){');
  w.document.write('if(window.calculationStarted){alert(\'è¨ˆç®—å·²åœ¨é€²è¡Œä¸­ï¼Œè«‹ç¨å€™...\');return;}');
  w.document.write('window.calculationStarted=true;');
  w.document.write('var btn=document.querySelector(\'.calc-btn\');');
  w.document.write('if(btn)btn.disabled=true;');
  w.document.write('document.write(\'<div id="loading" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;font-size:40px;font-weight:bold;color:#5d3fd3;background:rgba(255,255,255,0.9);padding:20px;border-radius:10px;z-index:9999;">â³ æ­£åœ¨è¨ˆç®—åŸæ–™ç™¾åˆ†æ¯”ï¼Œè«‹ç¨å€™...</div>\');');
  w.document.write('setTimeout(function(){window.calculationStarted=false;if(btn)btn.disabled=false;},2000);');
  w.document.write('var tableHtml=document.querySelector(\'.vals\').outerHTML;');
  w.document.write('var params=window.recipeParams;');
  w.document.write('if(window.opener&&typeof window.opener.recipe_ABCD===\'function\'){');
  w.document.write('window.opener.recipe_ABCD(params.svg,tableHtml,params.rightHtml,params.extraHtml,window,0);');
  w.document.write('}else{alert(\'æ‰¾ä¸åˆ°è¨ˆç®—å‡½æ•¸\');window.calculationStarted=false;if(btn)btn.disabled=false;}');
  w.document.write('}');
  w.document.write('<\/script>');
  
  w.document.write('</body></html>');
}



















//ã€€ã€€functionã€€recipe_ABCDï¼ˆï¼‰ã€€ã€€é€™æ®µç¨‹å¼ç¢¼ç¢ºå¯¦ä¸å¤ªå¥½è®€ï¼Œä¸»è¦åŸå› ï¼šç”±function stull_v2()å‘¼å«ã€€ã€€
//ã€€ã€€ç‚ºä½•é›£ä»¥è¾¨èªï¼Ÿã€€ã€€ã€€ï¼‘ï¼å·¢ç‹€å›èª¿åœ°ç„ï¼ˆCallback Hellï¼‰
//ã€€ã€€ï¼’ï¼æ··åˆäº†å¤šç¨®åŠŸèƒ½ï¼šã€€å»ºç«‹ HTMLè¡¨æ ¼ã€€ã€€å¿«ç…§é é¢è³‡æ–™ã€€ã€€ä¿®æ”¹è³‡æ–™ã€€ã€€å›å¡«è¡¨å–®ã€€ã€€è¨ˆç®—ã€€ã€€å»¶é²åŸ·è¡Œ
//ã€€ã€€ç‚ºä»€éº¼éœ€è¦å»¶é²ï¼Ÿ
//ã€€ã€€DOM æ›´æ–°éœ€è¦æ™‚é–“ï¼šå›å¡«è¡¨å–®å¾Œï¼Œéœ€è¦ç­‰ç€è¦½å™¨æ›´æ–°
//ã€€ã€€calculate_segar() å¯èƒ½æ˜¯ç•°æ­¥çš„ï¼šé›–ç„¶æ²’å¯« async/awaitï¼Œä½†å¯èƒ½æœ‰å…§éƒ¨å»¶é²
//ã€€ã€€ç¢ºä¿è¨ˆç®—å®Œæˆï¼šçµ¦è¶³å¤ æ™‚é–“è®“æ‰€æœ‰è¨ˆç®—å’Œ DOM æ›´æ–°å®Œæˆ
//ã€€ã€€é€™æ˜¯å…¸å‹çš„ã€Œä¸ä¿¡ä»»ç€è¦½å™¨æœƒç«‹å³å®Œæˆå·¥ä½œã€çš„é˜²ç¦¦æ€§ç·¨ç¨‹ã€‚



function recipe_ABCD(svg, tableHtml, rightHtml, extraHtml, w, slot = 0) {
  if (!w || w.closed) return;
  
  if (!Array.isArray(window.TempData))   window.TempData = [];
  if (!Array.isArray(window.savedData2)) window.savedData2 = [];
  if (!Array.isArray(window.ABCD))       window.ABCD = [];
  
  const names = [
    "é•·çŸ³","ç¢³é…¸éˆ£","ç¢³é…¸é‹‡","æ°§åŒ–é‹…","ç¢³é…¸é‚","ç¢³é…¸é¶",
    "ç™½é›²çŸ³","æ»‘çŸ³","é«˜å¶ºåœŸ","æ°§åŒ–é‹","äºŒæ°§åŒ–çŸ½<br>(çŸ³è‹±)",
    "äºŒæ°§åŒ–éˆ¦<br>(é‡‘ç´…çŸ³)","äºŒæ°§åŒ–é‹¯","çŸ½é…¸é‹¯","äºŒæ°§åŒ–éŒ«"
  ];
  
let html = '<h2 style="margin-top:40px;margin-bottom:10px;color:#333;font-size:24px;">Recipe Table</h2>';
html += '<table class="bigtable" border="1" cellspacing="0" cellpadding="10" style="border-collapse:collapse;font-family:monospace;text-align:center;font-size:18px;width:90%;line-height:1.6;">';
html += '<tr style="background:#ffe0e0;font-weight:bold;">';
html += '<th style="padding:10px;"></th>';
for (let i = 0; i < names.length; i++) {
  html += '<th style="padding:10px;">' + names[i] + '</th>';
}
html += '<th style="padding:10px;">å¤–åŠ </th>';
html += '</tr>';
for (let r = 1; r < 5; r++) {
  html += '<tr>';
  for (let c = 0; c < 17; c++) {
    html += '<td style="padding:10px;"></td>';
  }
  html += '</tr>';
}
html += '</table>';  w.document.write(html);
  
  function snapshotFromPage() {
    const lines = [];
    const texts = document.querySelectorAll('input[type="text"]');
    texts.forEach((el, idx) => {
      const id   = el.id   ? `id=${el.id}`     : "";
      const name = el.name ? `name=${el.name}` : "";
      lines.push(`[TEXT ${idx+1}] ${id} ${name} : "${el.value}"`);
    });
    const radios = document.querySelectorAll('input[type="radio"]');
    const radioGroups = {};
    radios.forEach(el => {
      if (el.name && !radioGroups[el.name]) {
        radioGroups[el.name] = document.querySelector(`input[name="${el.name}"]:checked`);
      }
    });
    Object.keys(radioGroups).forEach((groupName, idx) => {
      const chosen = radioGroups[groupName];
      const value = chosen ? chosen.value : "(æœªé¸)";
      lines.push(`[RADIO ${idx+1}] ç¾¤çµ„=${groupName}, é¸ä¸­="${value}"`);
    });
    return lines;
  }
  
  const lines = snapshotFromPage();
  TempData[slot] = lines.slice();
  savedData2[slot] = [
    JSON.parse(JSON.stringify(lines)),
    JSON.parse(JSON.stringify(lines)),
    JSON.parse(JSON.stringify(lines)),
    JSON.parse(JSON.stringify(lines))
  ];
  
  const matchGroup = (label) => {
    const regex = new RegExp(`<td class="lbl">${label}<\\/td><td class="num">([^<]+)<\\/td><td class="num">([^<]+)<\\/td>`);
    const m = tableHtml.match(regex);
    return m ? { al: m[1], si: m[2] } : { al: "", si: "" };
  };
  
  const groups = { A: matchGroup("A"), B: matchGroup("B"), C: matchGroup("C"), D: matchGroup("D") };
  const replaceQuotedValue = (line, newVal) => line.replace(/: ".*?"$/, `: "${newVal}"`);
  
  ["A", "B", "C", "D"].forEach((g, idx) => {
    const row = savedData2[slot][idx];
    for (let i = 0; i < row.length; i++) {
      if (row[i].includes('id=al')) {
        row[i] = replaceQuotedValue(row[i], groups[g].al);
      } else if (row[i].includes('id=si')) {
        row[i] = replaceQuotedValue(row[i], groups[g].si);
      }
    }
  });
  
  const esc = s => s.replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
  w.document.write(
    '<h2 style="margin-top:24px;color:#333">TempData[' + slot + ']</h2>' +
    '<pre>' + esc(JSON.stringify(TempData[slot], null, 2)) + '</pre>' +
    '<h2 style="margin-top:16px;color:#333">savedData2[' + slot + ']</h2>' +
    '<pre>' + esc(JSON.stringify(savedData2[slot], null, 2)) + '</pre>' +
    '<h2 style="margin-top:16px;color:#333">ABCD[0]ï¼ˆrecipe_A å›å¡«å¾Œå¿«ç…§ï¼‰</h2>' +
    '<pre id="ab0">(ç­‰å¾…å›å¡« A èˆ‡è¨ˆç®—å¾Œçš„å¿«ç…§)</pre>' +
    '<h2 style="margin-top:16px;color:#333">ABCD[1]ï¼ˆrecipe_B å›å¡«å¾Œå¿«ç…§ï¼‰</h2>' +
    '<pre id="ab1">(ç­‰å¾…å›å¡« B èˆ‡è¨ˆç®—å¾Œçš„å¿«ç…§)</pre>' +
    '<h2 style="margin-top:16px;color:#333">ABCD[2]ï¼ˆrecipe_C å›å¡«å¾Œå¿«ç…§ï¼‰</h2>' +
    '<pre id="ab2">(ç­‰å¾…å›å¡« C èˆ‡è¨ˆç®—å¾Œçš„å¿«ç…§)</pre>' +
    '<h2 style="margin-top:16px;color:#333">ABCD[3]ï¼ˆrecipe_D å›å¡«å¾Œå¿«ç…§ï¼‰</h2>' +
    '<pre id="ab3">(ç­‰å¾…å›å¡« D èˆ‡è¨ˆç®—å¾Œçš„å¿«ç…§)</pre>'
  );
  
  function applyRecipe(linesArr) {
    linesArr.forEach(line => {
      if (line.startsWith("[TEXT")) {
        const m = line.match(/\[TEXT\s+\d+\]\s*(?:id=([^\s]+))?\s*(?:name=([^\s]+))?\s*:\s*"(.*)"/);
        if (m) {
          const id = m[1] || "";
          const name = m[2] || "";
          const value = m[3] ?? "";
          let el = null;
          if (id)   el = document.getElementById(id);
          if (!el && name) el = document.querySelector(`[name="${name}"]`);
          if (el && 'value' in el) el.value = value;
        }
      } else if (line.startsWith("[RADIO")) {
        const m = line.match(/\[RADIO\s+\d+\]\s*ç¾¤çµ„=([^,]+),\s*é¸ä¸­="(.*)"/);
        if (m) {
          const groupName = m[1];
          const value = m[2];
          if (groupName && value && value !== "(æœªé¸)") {
            const el = document.querySelector(`input[type="radio"][name="${groupName}"][value="${CSS.escape(value)}"]`);
            if (el) el.checked = true;
          }
        }
      }
    });
  }
  
  function runRecipeAndSnapshot(recipeLines, abcdIndex, preId, delayMs = 30, done) {
    applyRecipe(recipeLines);
    
    const form = document.forms[0];
    if (form) {
      try {
        calculate_segar(form);
      } catch (e) {
        console.error('calculate_segar() éŒ¯èª¤ï¼š', e);
      }
    }
    
    setTimeout(() => {
      const lines2 = snapshotFromPage();
      ABCD[abcdIndex] = lines2;
      const pre = w.document.getElementById(preId);
      if (pre) pre.textContent = JSON.stringify(ABCD[abcdIndex], null, 2);
      if (typeof done === 'function') done();
    }, delayMs);
  }
  
  const recipe_A = savedData2[slot][0];
  runRecipeAndSnapshot(recipe_A, 0, 'ab0', ã€€ 150, () => {
    const recipe_B = savedData2[slot][1];
    runRecipeAndSnapshot(recipe_B, 1, 'ab1', ã€€ 150, () => {
      const recipe_C = savedData2[slot][2];
      runRecipeAndSnapshot(recipe_C, 2, 'ab2', ã€€ 150, () => {
        const recipe_D = savedData2[slot][3];
        runRecipeAndSnapshot(recipe_D, 3, 'ab3', ã€€ 150, () => {
          setTimeout(() => {
            fillRecipeTable(w);
          }, 100);
        });
      });
    });
  });
}





function fillRecipeTable(w) {
  if (!w || w.closed) return;
  if (!Array.isArray(window.ABCD) || ABCD.length < 4) return;
  
  const table = w.document.querySelector('.bigtable');
  if (!table) return;
  
  let feldsparType = "é•·çŸ³";
  if (ABCD[0] && Array.isArray(ABCD[0])) {
    for (const line of ABCD[0]) {
      if (line.includes('ç¾¤çµ„=f') && line.includes('é¸ä¸­=')) {
        const match = line.match(/é¸ä¸­="([^"]*)"/);
        if (match) {
          feldsparType = match[1];
          break;
        }
      }
    }
  }
  
  if (table.rows[0] && table.rows[0].cells[1]) {
    table.rows[0].cells[1].innerHTML = feldsparType;
  }
  
  const rowLabels = ['A', 'B', 'C', 'D'];
  
  for (let rowIndex = 0; rowIndex < 4; rowIndex++) {
    const dataLines = ABCD[rowIndex];
    if (!Array.isArray(dataLines)) continue;
    
    const percentages = new Array(15).fill('');
    
    for (let textNum = 8; textNum <= 22; textNum++) {
      const pIndex = textNum - 8;
      
      for (const line of dataLines) {
        if (line.includes(`[TEXT ${textNum}]`) && line.includes('name=p')) {
          const match = line.match(/:\s*"([^"]*)"/);
          if (match && match[1].trim() !== '') {
            const value = parseFloat(match[1]);
            if (!isNaN(value)) {
              percentages[pIndex] = Math.round(value);
            }
          }
          break;
        }
      }
    }
    
    const tr = table.rows[rowIndex + 1];
    if (!tr) continue;
    
    if (tr.cells[0]) {
  tr.cells[0].textContent = rowLabels[rowIndex];
  tr.cells[0].style.color = '#d00';
  tr.cells[0].style.fontWeight = 'bold';
  tr.cells[0].style.fontSize = '24px';
  tr.cells[0].style.background = '#f9f9f9';  // æ–°å¢èƒŒæ™¯è‰²
  tr.cells[0].style.padding = '10px';  // æ–°å¢å…§è·
}
    
    for (let col = 0; col < 15; col++) {
      const cellIndex = col + 1;
      if (tr.cells[cellIndex]) {
        const val = percentages[col];
        tr.cells[cellIndex].textContent = (val === 0 || val === '') ? '' : val;
        tr.cells[cellIndex].style.fontSize = '18px';




const loading = w.document.getElementById('loading');
  if (loading) loading.remove();
      }
    }
  }
}












// Stull Chart v22 - ä½¿ç”¨ calculate_segar_pure çš„çº¯å‡½æ•°ç‰ˆæœ¬
// Stull Chart v22 - ä½¿ç”¨ calculate_segar_pure çš„çº¯å‡½æ•°ç‰ˆæœ¬
// Stull Chart v22 - ä½¿ç”¨ calculate_segar_pure çš„çº¯å‡½æ•°ç‰ˆæœ¬
// Stull Chart v22 - ä½¿ç”¨ calculate_segar_pure çš„çº¯å‡½æ•°ç‰ˆæœ¬
// Stull Chart v22 - ä½¿ç”¨ calculate_segar_pure çš„çº¯å‡½æ•°ç‰ˆæœ¬
// ============================================
// Stull Chart v22 - è¼•åº¦é‡æ§‹ç‰ˆï¼ˆå¯ç›´æ¥åŸ·è¡Œï¼‰
// åŠŸèƒ½ï¼šç”Ÿæˆé‡‰è—¥é…æ–¹çš„ Stull Chart ä¸¦åœ¨æ–°çª—å£é¡¯ç¤º
// ============================================
// ============================================
// Stull Chart v22 - è¼•åº¦é‡æ§‹ç‰ˆï¼ˆå¯ç›´æ¥åŸ·è¡Œï¼‰
// åŠŸèƒ½ï¼šç”Ÿæˆé‡‰è—¥é…æ–¹çš„ Stull Chart ä¸¦åœ¨æ–°çª—å£é¡¯ç¤º
// ============================================

function stull_v22() {
  // -------------------- ç¬¬ä¸€æ­¥ï¼šè®€å–æœ€å°å€¼ä¸¦è¨ˆç®—åæ¨™ç¯„åœ --------------------
  const siMinInput = document.getElementById('si_min');
  const siMinRaw = siMinInput ? parseFloat(siMinInput.value) : NaN;
  const baseValNum = (siMinRaw > 1.5) ? siMinRaw : 1.5;
  
  const x1Str = baseValNum.toFixed(4);
  const x4Str = (baseValNum + 1.5).toFixed(4);
  
  const alMinInput = document.getElementById('al_min');
  const alMinRaw = alMinInput ? parseFloat(alMinInput.value) : NaN;
  
  // åæ¨™è»¸é•·åº¦å’Œåˆ»åº¦é…ç½®
  const yAxisLength = 10;
  const xAxisLength = 30;
  const xTicks = [5, 12, 19, 26];
  const yTicks = [2, 4, 6, 8];
  
  const y1Num = baseValNum / 10;
  const y1ShowNum = Number.isFinite(alMinRaw) ? Math.max(y1Num, alMinRaw) : y1Num;
  const y1Str = y1ShowNum.toFixed(4);
  const y4Str = (y1ShowNum + 0.15).toFixed(4);
  
  // SVG ç•«å¸ƒå°ºå¯¸
  const W = 640, H = 360;
  const ml = 72, mr = 20, mt = 24, mb = 64;
  const plotW = W - ml - mr;
  const plotH = H - mt - mb;
  
  // -------------------- ç¬¬äºŒæ­¥ï¼šå®šç¾© SVG ç”Ÿæˆå‡½æ•¸ --------------------
  function generateSVG(x1Val, x4Val, y1Val, y4Val) {
    const x2px = x => ml + (x / xAxisLength) * plotW;
    const y2px = y => H - mb - (y / yAxisLength) * plotH;
    const y0 = y2px(0);
    const yTop = y2px(yAxisLength);
    
    let svg = '<svg width="' + W + '" height="' + H + '" viewBox="0 0 ' + W + ' ' + H + '" xmlns="http://www.w3.org/2000/svg">';
    
    svg += '<defs><marker id="arr" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">';
    svg += '<path d="M0,0 L6,3 L0,6 Z" fill="#333"/></marker></defs>';
    
    svg += '<line x1="' + ml + '" y1="' + y0 + '" x2="' + (ml + plotW) + '" y2="' + y0 + '" stroke="#333" stroke-width="1.6" marker-end="url(#arr)"/>';
    svg += '<line x1="' + ml + '" y1="' + y0 + '" x2="' + ml + '" y2="' + (yTop - 2) + '" stroke="#333" stroke-width="1.6" marker-end="url(#arr)"/>';
    
    for (const xt of xTicks) {
      svg += '<line x1="' + x2px(xt) + '" y1="' + y0 + '" x2="' + x2px(xt) + '" y2="' + yTop + '" stroke="#999" stroke-dasharray="4 4"/>';
      svg += '<line x1="' + x2px(xt) + '" y1="' + y0 + '" x2="' + x2px(xt) + '" y2="' + (y0 + 6) + '" stroke="#333"/>';
    }
    
    for (const yt of yTicks) {
      svg += '<line x1="' + ml + '" y1="' + y2px(yt) + '" x2="' + (ml + plotW) + '" y2="' + y2px(yt) + '" stroke="#bbb" stroke-dasharray="4 4"/>';
      svg += '<line x1="' + ml + '" y1="' + y2px(yt) + '" x2="' + (ml - 6) + '" y2="' + y2px(yt) + '" stroke="#333"/>';
    }
    
    for (const yt of yTicks) {
      for (const xt of xTicks) {
        svg += '<circle cx="' + x2px(xt) + '" cy="' + y2px(yt) + '" r="3" fill="#333"/>';
      }
    }
    
    const si2abstract = (si) => {
      return 5 + (si - x1Val) / (x4Val - x1Val) * (26 - 5);
    };
    const al2abstract = (al) => {
      return 2 + (al - y1Val) / (y4Val - y1Val) * (8 - 2);
    };

    const test_si1 = 0, test_al1 = test_si1 / 5;
    const abs_x1 = si2abstract(test_si1), abs_y1 = al2abstract(test_al1);
    const test_si2 = 20, test_al2 = test_si2 / 5;
    const abs_x2 = si2abstract(test_si2), abs_y2 = al2abstract(test_al2);
    
    svg += '<line x1="' + x2px(abs_x1) + '" y1="' + y2px(abs_y1) + '" x2="' + x2px(abs_x2) + '" y2="' + y2px(abs_y2) + '" stroke="#87CEEB" stroke-width="2" stroke-dasharray="8 4"/>';
    
    for (let i = 0; i <= 24; i++) {
      const t = i / 24;
      const labelX = x2px(abs_x1 + (abs_x2 - abs_x1) * t);
      const labelY = y2px(abs_y1 + (abs_y2 - abs_y1) * t);
      svg += '<text x="' + labelX + '" y="' + (labelY - 5) + '" fill="#87CEEB" font-size="18" font-weight="bold">1:5</text>';
    }

    const test_si3 = 0, test_al3 = test_si3 / 10;
    const abs_x3 = si2abstract(test_si3), abs_y3 = al2abstract(test_al3);
    const test_si4 = 20, test_al4 = test_si4 / 10;
    const abs_x4 = si2abstract(test_si4), abs_y4 = al2abstract(test_al4);
    
    svg += '<line x1="' + x2px(abs_x3) + '" y1="' + y2px(abs_y3) + '" x2="' + x2px(abs_x4) + '" y2="' + y2px(abs_y4) + '" stroke="#87CEEB" stroke-width="2" stroke-dasharray="8 4"/>';
    
    for (let i = 0; i <= 24; i++) {
      const t = i / 24;
      const labelX = x2px(abs_x3 + (abs_x4 - abs_x3) * t);
      const labelY = y2px(abs_y3 + (abs_y4 - abs_y3) * t);
      svg += '<text x="' + labelX + '" y="' + (labelY + 15) + '" fill="#87CEEB" font-size="18" font-weight="bold">1:10</text>';
    }

    const test_si5 = 0, test_al5 = test_si5 / 15;
    const abs_x5 = si2abstract(test_si5), abs_y5 = al2abstract(test_al5);
    const test_si6 = 20, test_al6 = test_si6 / 15;
    const abs_x6 = si2abstract(test_si6), abs_y6 = al2abstract(test_al6);
    
    svg += '<line x1="' + x2px(abs_x5) + '" y1="' + y2px(abs_y5) + '" x2="' + x2px(abs_x6) + '" y2="' + y2px(abs_y6) + '" stroke="#87CEEB" stroke-width="2" stroke-dasharray="8 4"/>';
    
    for (let i = 0; i <= 24; i++) {
      const t = i / 24;
      const labelX = x2px(abs_x5 + (abs_x6 - abs_x5) * t);
      const labelY = y2px(abs_y5 + (abs_y6 - abs_y5) * t);
      svg += '<text x="' + labelX + '" y="' + (labelY + 15) + '" fill="#87CEEB" font-size="18" font-weight="bold">1:15</text>';
    }

    const topCenterX = ml + plotW / 2;
    const topY = mt + 15;
    svg += '<text x="' + topCenterX + '" y="' + topY + '" text-anchor="middle" fill="#87CEEB" font-size="25" font-weight="bold">ä¸­é…¸æ¯”ç‚º 1:5  1:10  1:15</text>';

    svg += '<text x="' + (x2px(xTicks[0]) + 8) + '" y="' + (y2px(2) + 4) + '" fill="#d00" font-weight="700" font-size="32">A</text>';
    svg += '<text x="' + (x2px(xTicks[0]) + 8) + '" y="' + (y2px(8) + 4) + '" fill="#d00" font-weight="700" font-size="32">B</text>';
    svg += '<text x="' + (x2px(xTicks[3]) + 8) + '" y="' + (y2px(8) + 4) + '" fill="#d00" font-weight="700" font-size="32">C</text>';
    svg += '<text x="' + (x2px(xTicks[3]) + 8) + '" y="' + (y2px(2) + 4) + '" fill="#d00" font-weight="700" font-size="32">D</text>';
    
    svg += '<text x="' + x2px(xTicks[0]) + '" y="' + (y0 + 22) + '" text-anchor="middle" fill="#333" id="si_x1">' + x1Val.toFixed(4) + '</text>';
    svg += '<text x="' + x2px(xTicks[3]) + '" y="' + (y0 + 22) + '" text-anchor="middle" fill="#333" id="si_x4">' + x4Val.toFixed(4) + '</text>';
    svg += '<text x="' + (ml + plotW / 2) + '" y="' + (H - 18) + '" text-anchor="middle" fill="#333" font-size="28" font-weight="bold">Si</text>';
    svg += '<text x="' + (ml - 10) + '" y="' + (y2px(2) + 4) + '" text-anchor="end" fill="#333" id="al_y1">' + y1Val.toFixed(4) + '</text>';
    svg += '<text x="' + (ml - 10) + '" y="' + (y2px(8) + 4) + '" text-anchor="end" fill="#333" id="al_y4">' + y4Val.toFixed(4) + '</text>';
    svg += '<text x="' + (ml - 30) + '" y="' + (yTop + 10) + '" text-anchor="end" fill="#333" font-size="28" font-weight="bold">Al</text>';
    svg += '</svg>';
    
    return svg;
  }
  
  const svg = generateSVG(parseFloat(x1Str), parseFloat(x4Str), parseFloat(y1Str), parseFloat(y4Str));
  
  // -------------------- ç¬¬ä¸‰æ­¥ï¼šè®€å–åŸºç¤æ•¸æ“š --------------------
  
  function readFirstNumeric(selectors) {
    for (const sel of selectors) {
      const el = document.querySelector(sel);
      if (!el) continue;
      
      const raw = ('value' in el) ? el.value : (el.textContent || el.innerText || '');
      const num = parseFloat(
        raw.replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFF10 + 0x30))
           .replace(/ï¼/g, '.')
      );
      
      if (Number.isFinite(num)) return num;
    }
    return 0;
  }
  
  const baseData = {
    kna: readFirstNumeric(['#KNa', '#kna']),
    ca: readFirstNumeric(['#Ca', '#ca']),
    ba: readFirstNumeric(['#Ba', '#ba']),
    zn: readFirstNumeric(['#Zn', '#zn']),
    mg: readFirstNumeric(['#Mg', '#mg']),
    sr: readFirstNumeric(['#Sr', '#sr']),
    ti: readFirstNumeric(['#Ti', '#ti']),
    zr: readFirstNumeric(['#Zr', '#zr']),
    sn: readFirstNumeric(['#Sn', '#sn'])
  };
  
  function getCurrentFType() {
    const radios = document.getElementsByName("f");
    for (let i = 0; i < radios.length; i++) {
      if (radios[i].checked) return i + 1;
    }
    return 1;
  }
  
  function getCurrentMgType() {
    const radios = document.getElementsByName("m");
    for (let i = 0; i < radios.length; i++) {
      if (radios[i].checked) return i + 1;
    }
    return 2;
  }
  
  baseData.f_type = getCurrentFType();
  baseData.mg_type = getCurrentMgType();
  
  // -------------------- ç¬¬å››æ­¥ï¼šç”Ÿæˆæ•¸æ“šè¡¨æ ¼ --------------------
  
  const formatVal = (val) => {
    if (val === 0) return '';
    return parseFloat(val.toFixed(4)).toString();
  };
  
  const tableHtml = 
    '<table class="vals"><thead><tr>' +
      '<th></th><th>KNa</th><th>Ca</th><th>Ba</th><th>Zn</th><th>Mg</th><th>Sr</th>' +
      '<th class="highlight">Al</th><th class="highlight">Si</th><th>Ti</th><th>Zr</th><th>Sn</th>' +
    '</tr></thead><tbody>' +
      '<tr><td class="lbl">A</td>' +
        '<td class="num">' + formatVal(baseData.kna) + '</td>' +
        '<td class="num">' + formatVal(baseData.ca) + '</td>' +
        '<td class="num">' + formatVal(baseData.ba) + '</td>' +
        '<td class="num">' + formatVal(baseData.zn) + '</td>' +
        '<td class="num">' + formatVal(baseData.mg) + '</td>' +
        '<td class="num">' + formatVal(baseData.sr) + '</td>' +
        '<td class="num highlight">' + parseFloat(y1Str) + '</td>' +
        '<td class="num highlight">' + parseFloat(x1Str) + '</td>' +
        '<td class="num">' + formatVal(baseData.ti) + '</td>' +
        '<td class="num">' + formatVal(baseData.zr) + '</td>' +
        '<td class="num">' + formatVal(baseData.sn) + '</td>' +
      '</tr>' +
      '<tr><td class="lbl">B</td>' +
        '<td class="num">' + formatVal(baseData.kna) + '</td>' +
        '<td class="num">' + formatVal(baseData.ca) + '</td>' +
        '<td class="num">' + formatVal(baseData.ba) + '</td>' +
        '<td class="num">' + formatVal(baseData.zn) + '</td>' +
        '<td class="num">' + formatVal(baseData.mg) + '</td>' +
        '<td class="num">' + formatVal(baseData.sr) + '</td>' +
        '<td class="num highlight">' + parseFloat(y4Str) + '</td>' +
        '<td class="num highlight">' + parseFloat(x1Str) + '</td>' +
        '<td class="num">' + formatVal(baseData.ti) + '</td>' +
        '<td class="num">' + formatVal(baseData.zr) + '</td>' +
        '<td class="num">' + formatVal(baseData.sn) + '</td>' +
      '</tr>' +
      '<tr><td class="lbl">C</td>' +
        '<td class="num">' + formatVal(baseData.kna) + '</td>' +
        '<td class="num">' + formatVal(baseData.ca) + '</td>' +
        '<td class="num">' + formatVal(baseData.ba) + '</td>' +
        '<td class="num">' + formatVal(baseData.zn) + '</td>' +
        '<td class="num">' + formatVal(baseData.mg) + '</td>' +
        '<td class="num">' + formatVal(baseData.sr) + '</td>' +
        '<td class="num highlight">' + parseFloat(y4Str) + '</td>' +
        '<td class="num highlight">' + parseFloat(x4Str) + '</td>' +
        '<td class="num">' + formatVal(baseData.ti) + '</td>' +
        '<td class="num">' + formatVal(baseData.zr) + '</td>' +
        '<td class="num">' + formatVal(baseData.sn) + '</td>' +
      '</tr>' +
      '<tr><td class="lbl">D</td>' +
        '<td class="num">' + formatVal(baseData.kna) + '</td>' +
        '<td class="num">' + formatVal(baseData.ca) + '</td>' +
        '<td class="num">' + formatVal(baseData.ba) + '</td>' +
        '<td class="num">' + formatVal(baseData.zn) + '</td>' +
        '<td class="num">' + formatVal(baseData.mg) + '</td>' +
        '<td class="num">' + formatVal(baseData.sr) + '</td>' +
        '<td class="num highlight">' + parseFloat(y1Str) + '</td>' +
        '<td class="num highlight">' + parseFloat(x4Str) + '</td>' +
        '<td class="num">' + formatVal(baseData.ti) + '</td>' +
        '<td class="num">' + formatVal(baseData.zr) + '</td>' +
        '<td class="num">' + formatVal(baseData.sn) + '</td>' +
      '</tr>' +
    '</tbody></table>';
  
  // -------------------- ç¬¬äº”æ­¥ï¼šæ‰“é–‹æ–°çª—å£ä¸¦å¯«å…¥å…§å®¹ --------------------
  
  const w = window.open('', 'stull_chart_v22');
  if (!w) {
    alert('å½ˆå‡ºè¦–çª—è¢«ç€è¦½å™¨é˜»æ“‹');
    return;
  }
  
  w.baseData = baseData;
  w.siAdjustCounter = 0;
  w.alAdjustCounter = 0;
  w.siMin = Number.isFinite(siMinRaw) ? siMinRaw : 1.5;
  w.alMin = Number.isFinite(alMinRaw) ? alMinRaw : 0.15;
  
  w.document.open();
  w.document.write('<!DOCTYPE html><html><head><meta charset="utf-8"><title>Stull Chart v22</title>');
  
w.document.write('<style>');
w.document.write('html,body{overscroll-behavior:none;overscroll-behavior-y:none}');
w.document.write('body{font-family:monospace;background:#f4f4f4;margin:0;padding:20px}');
  w.document.write('.leftcol{display:flex;flex-direction:column;gap:12px}');
  w.document.write('.vector{position:relative}.vector svg{background:#fff;border:1px solid #ddd;border-radius:6px}');
  w.document.write('.si-controls{position:absolute;bottom:5px;left:450px;transform:translateX(-50%);display:flex;gap:8px}');
  w.document.write('.si-controls button{width:54px;height:54px;font-size:30px;font-weight:bold;border:2px solid #333;cursor:pointer;border-radius:6px;user-select:none;-webkit-user-select:none}');
  w.document.write('.si-controls button:first-child{background:#ff6b6b;color:#fff}');
  w.document.write('.si-controls button:last-child{background:#51cf66;color:#fff}');
  w.document.write('.al-controls{position:absolute;left:6px;top:45%;transform:translateY(-50%);display:flex;flex-direction:column;gap:8px}');
  w.document.write('.al-controls button{width:54px;height:54px;font-size:30px;font-weight:bold;border:2px solid #333;cursor:pointer;border-radius:6px;user-select:none;-webkit-user-select:none}');
  w.document.write('.al-controls button:first-child{background:#51cf66;color:#fff}');
  w.document.write('.al-controls button:last-child{background:#ff6b6b;color:#fff}');
  w.document.write('.vals{border-collapse:collapse;background:#fff}');
  w.document.write('.vals th,.vals td{border:2px solid #333;padding:6px 12px;text-align:center}');
  w.document.write('.vals th{font-size:20px}');
  w.document.write('.lbl{color:#d00;font-weight:700;font-size:20px}');
  w.document.write('.num{color:#06c;font-weight:700;font-size:16px}');
  w.document.write('.highlight{color:#00f;font-weight:900;font-size:18px}');
  w.document.write('.bigtable{border-collapse:collapse;margin-top:0;width:100%;background:#fff}');
  w.document.write('.bigtable th{border:1px solid #333;padding:10px;text-align:center;font-size:20px!important;line-height:1.3;vertical-align:middle}');
  w.document.write('.bigtable td{border:1px solid #333;padding:10px;text-align:center;font-size:18px}');
  w.document.write('.bigtable td:first-child{color:#d00;font-weight:bold;font-size:24px!important}');
  w.document.write('.calc-btn{margin-top:16px;padding:12px 24px;font-size:18px;font-weight:bold;background:#4c6ef5;color:#fff;border:none;border-radius:8px;cursor:pointer}');
  w.document.write('</style></head><body>');
  
  w.document.write('<h1>Stull Chart v22</h1>');
  w.document.write('<div class="leftcol">');
  w.document.write('<div class="vector" id="svgContainer">' + svg);
  w.document.write('<div class="al-controls"><button id="alPlus">+</button><button id="alMinus">âˆ’</button></div>');
  w.document.write('<div class="si-controls"><button id="siMinus">âˆ’</button><button id="siPlus">+</button></div>');
  w.document.write('</div>');
  w.document.write(tableHtml);
  w.document.write('<button class="calc-btn" onclick="startCalculation()" style="display:none;">ğŸ§® è¨ˆç®—ç™¾åˆ†æ¯”</button>');
  w.document.write('</div>');
  w.document.write('<div id="results"></div>');
  w.document.write('</body></html>');
  w.document.close();
  
  // -------------------- ç¬¬å…­æ­¥ï¼šæ³¨å…¥ JavaScript åŠŸèƒ½ --------------------
  
  const baseDataStr = JSON.stringify(baseData);
  
  w.eval(`
    // ========== å…¨å±€è®Šæ•¸ ==========
    const baseData = ${baseDataStr};
    
    // ========== é•·æŒ‰é€£çºŒæŒ‰éˆ•åŠŸèƒ½ ==========
    let holdTimer = null;
    let repeatTimer = null;
    
    function startHold(fn) {
      holdTimer = setTimeout(() => {
        repeatTimer = setInterval(fn, 100);  // æ¯ç§’10æ¬¡
      }, 500);  // 0.5ç§’å¾Œé–‹å§‹é€£çºŒ
    }
    
    function stopHold() {
      clearTimeout(holdTimer);
      clearInterval(repeatTimer);
      holdTimer = null;
      repeatTimer = null;
    }



    
    // è®“æ‰‹æ©Ÿéœ‡å‹•ï¼Œæä¾›æŒ‰éˆ•é»æ“Šçš„è§¸è¦ºåé¥‹
       function buttonFeedback() {
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }
    

    // åœ¨ Stull Chart v22 ä¸­ï¼šç”¨æˆ¶èª¿æ•´ Al/Si å€¼   ç”Ÿæˆ Aã€Bã€Cã€D å››å€‹é…æ–¹é» â†“å°æ¯å€‹é»èª¿ç”¨ calc_pure()  â†“è¨ˆç®—å‡º 4 çµ„åŸæ–™ç™¾åˆ†æ¯”â†“é¡¯ç¤ºåœ¨è¡¨æ ¼ä¸­
    //  calculate_segar_pure()ä¸»ç¶²é ä¸­çš„ç‰ˆæœ¬ï¼ˆæ›´å®Œæ•´ï¼‰
    function calc_pure(d) {
      let r = {p: new Array(15).fill(0), ok: 1, err: null};
      let kf, mf, cf, af, sf, mw0;
      
      if (d.f_type == 1) {kf = 0.9325; mf = 0.0113; cf = 0.0563; af = 1.0288; sf = 4.5572; mw0 = 447;}
      else if (d.f_type == 2) {kf = 0.8809; mf = 0.0447; cf = 0.0745; af = 0.9806; sf = 9.4773; mw0 = 743;}
      else if (d.f_type == 3) {kf = 0.9814; mf = 0.0060; cf = 0.0127; af = 1.0789; sf = 6.7398; mw0 = 600;}
      else if (d.f_type == 4) {kf = 0.8761; mf = 0.0154; cf = 0.1085; af = 0.9992; sf = 9.8345; mw0 = 768;}
      else if (d.f_type == 5) {kf = 0.9581; mf = 0.0132; cf = 0.0286; af = 0.9702; sf = 6.4851; mw0 = 580;}
      else if (d.f_type == 6) {kf = 0.9668; mf = 0.0181; cf = 0.0151; af = 1.1668; sf = 6.4955; mw0 = 596;}
      else if (d.f_type == 7) {kf = 0.9465; mf = 0.0108; cf = 0.0427; af = 1.0660; sf = 6.0573; mw0 = 535;}
      else {kf = 1; mf = 0; cf = 0; af = 1; sf = 6; mw0 = 0;}
      
      let f2 = d.kna / kf, cam = cf * f2, mgm = mf * f2, alm = af * f2, sim = sf * f2;
      if (d.ca < cam - 0.0001 || d.mg < mgm - 0.0001 || d.al < alm - 0.0001 || d.si < sim - 0.0001) {
        r.ok = 0;
        return r;
      }
      
      let t = [0, 0, d.ca - cam, d.ba, d.zn, d.mg - mgm, d.sr, d.al - alm, d.si - sim, d.ti, d.zr, d.sn, 0];
      let m = [f2, 0, t[3], t[4], 0, t[6], 0, 0, 0, 0, 0, t[9], 0, 0, t[11]];
      t[3] = t[4] = t[6] = t[9] = t[11] = 0;
      
      if (t[10] > 0) {
        if (t[8] >= t[10]) {m[13] = t[10]; t[8] -= t[10]; t[10] = 0;}
        else {m[13] = t[8]; m[12] = t[10] - t[8]; t[8] = t[10] = 0;}
      }
      
      if (d.mg_type == 3) {m[4] = t[5]; m[1] = t[2]; t[5] = t[2] = 0;}
      else if (d.mg_type == 1) {
        if (t[2] >= t[5]) {m[6] = t[5]; m[1] = t[2] - t[5]; t[2] = t[5] = 0;}
        else {
          m[6] = t[2]; m[1] = 0; t[5] -= t[2]; t[2] = 0;
          if (t[8] >= t[5] / 3 * 4) {m[7] = t[5] / 3; t[8] -= m[7] * 4; t[5] = 0;}
          else {m[7] = t[8] / 4; t[5] -= m[7] * 3; t[8] = 0; m[4] = t[5]; t[5] = 0;}
        }
      }
      else if (d.mg_type == 2) {
        if (t[8] >= t[5] / 3 * 4) {m[7] = t[5] / 3; t[8] -= m[7] * 4; t[5] = 0; m[1] = t[2]; t[2] = 0;}
        else {
          m[7] = t[8] / 4; t[5] -= m[7] * 3; t[8] = 0;
          if (t[2] > t[5]) {m[6] = t[5]; m[1] = t[2] - t[5]; t[5] = 0;}
          else {m[6] = t[2]; m[4] = t[5] - t[2]; t[5] = 0;}
          t[2] = 0;
        }
      }
      
      if (t[7] > 0) {
        if (t[8] >= t[7] * 2) {m[8] = t[7]; t[8] -= m[8] * 2; t[7] = 0;}
        else {m[8] = t[8] / 2; t[7] -= m[8]; t[8] = 0; m[9] = t[7]; t[7] = 0;}
      }
      m[10] = t[8];
      
      let mw = [mw0, 100, 197, 81, 84, 148, 184, 379, 258, 102, 60, 80, 123, 183, 151], tot = 0, w = [];
      for (let i = 0; i < 15; i++) {w[i] = m[i] * mw[i]; tot += w[i];}
      for (let i = 0; i < 15; i++) r.p[i] = w[i] / tot * 100;
      return r;
    }
    


    // ========== SVG ç”Ÿæˆå‡½æ•¸ ==========x1 Si è»¸æœ€å°å€¼ï¼ˆå·¦å´ï¼‰x4 Si è»¸æœ€å¤§å€¼ï¼ˆå³å´ï¼‰y1 Al è»¸æœ€å°å€¼ï¼ˆä¸‹æ–¹ï¼‰y4 Al è»¸æœ€å¤§å€¼ï¼ˆä¸Šæ–¹ï¼‰ è¼¸å…¥åº§æ¨™ç¯„åœ â†’ genSVG() â†’ è¿”å› SVG å­—ä¸² â†’ é¡¯ç¤ºåæ¨™åœ–
    
    function genSVG(x1, x4, y1, y4) {
      let W = 640, H = 360, ml = 72, mr = 20, mt = 24, mb = 64, pw = W - ml - mr, ph = H - mt - mb;
      let x2p = x => ml + x / 30 * pw, y2p = y => H - mb - y / 10 * ph, y0 = y2p(0), yt = y2p(10);
      let s = '<svg width="' + W + '" height="' + H + '" viewBox="0 0 ' + W + ' ' + H + '" xmlns="http://www.w3.org/2000/svg">';
      s += '<defs><marker id="arr" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#333"/></marker></defs>';
      s += '<line x1="' + ml + '" y1="' + y0 + '" x2="' + (ml + pw) + '" y2="' + y0 + '" stroke="#333" stroke-width="1.6" marker-end="url(#arr)"/>';
      s += '<line x1="' + ml + '" y1="' + y0 + '" x2="' + ml + '" y2="' + (yt - 2) + '" stroke="#333" stroke-width="1.6" marker-end="url(#arr)"/>';
      [5, 12, 19, 26].forEach(x => {s += '<line x1="' + x2p(x) + '" y1="' + y0 + '" x2="' + x2p(x) + '" y2="' + yt + '" stroke="#999" stroke-dasharray="4 4"/>'; s += '<line x1="' + x2p(x) + '" y1="' + y0 + '" x2="' + x2p(x) + '" y2="' + (y0 + 6) + '" stroke="#333"/>';});
      [2, 4, 6, 8].forEach(y => {s += '<line x1="' + ml + '" y1="' + y2p(y) + '" x2="' + (ml + pw) + '" y2="' + y2p(y) + '" stroke="#bbb" stroke-dasharray="4 4"/>'; s += '<line x1="' + ml + '" y1="' + y2p(y) + '" x2="' + (ml - 6) + '" y2="' + y2p(y) + '" stroke="#333"/>';});
      [2, 4, 6, 8].forEach(y => {[5, 12, 19, 26].forEach(x => {s += '<circle cx="' + x2p(x) + '" cy="' + y2p(y) + '" r="3" fill="#333"/>';});});
      let sa = si => 5 + (si - x1) / (x4 - x1) * 21, aa = al => 2 + (al - y1) / (y4 - y1) * 6;
      
      let slopes = [5, 10, 15];
      for (let idx = 0; idx < slopes.length; idx++) {
        let sl = slopes[idx];
        let sx1 = sa(0), sy1 = aa(0 / sl), sx2 = sa(20), sy2 = aa(20 / sl);
        s += '<line x1="' + x2p(sx1) + '" y1="' + y2p(sy1) + '" x2="' + x2p(sx2) + '" y2="' + y2p(sy2) + '" stroke="#87CEEB" stroke-width="2" stroke-dasharray="8 4"/>';
        for (let i = 0; i <= 24; i++) {
          let t = i / 24;
          let lx = x2p(sx1 + (sx2 - sx1) * t);
          let ly = y2p(sy1 + (sy2 - sy1) * t);
          s += '<text x="' + lx + '" y="' + (ly + (idx === 0 ? -5 : 15)) + '" fill="#87CEEB" font-size="18" font-weight="bold">1:' + sl + '</text>';
        }
      }
      
      s += '<text x="' + (ml + pw / 2) + '" y="' + (mt + 15) + '" text-anchor="middle" fill="#87CEEB" font-size="25" font-weight="bold">ä¸­é…¸æ¯”ç‚º 1:5  1:10  1:15</text>';
      s += '<text x="' + (x2p(5) + 8) + '" y="' + (y2p(2) + 4) + '" fill="#d00" font-weight="700" font-size="32">A</text>';
      s += '<text x="' + (x2p(5) + 8) + '" y="' + (y2p(8) + 4) + '" fill="#d00" font-weight="700" font-size="32">B</text>';
      s += '<text x="' + (x2p(26) + 8) + '" y="' + (y2p(8) + 4) + '" fill="#d00" font-weight="700" font-size="32">C</text>';
      s += '<text x="' + (x2p(26) + 8) + '" y="' + (y2p(2) + 4) + '" fill="#d00" font-weight="700" font-size="32">D</text>';
      s += '<text x="' + x2p(5) + '" y="' + (y0 + 22) + '" text-anchor="middle" fill="#333">' + x1.toFixed(4) + '</text>';
      s += '<text x="' + x2p(26) + '" y="' + (y0 + 22) + '" text-anchor="middle" fill="#333">' + x4.toFixed(4) + '</text>';
      s += '<text x="' + (ml + pw / 2) + '" y="' + (H - 18) + '" text-anchor="middle" fill="#333" font-size="28" font-weight="bold">Si</text>';
      s += '<text x="' + (ml - 10) + '" y="' + (y2p(2) + 4) + '" text-anchor="end" fill="#333">' + y1.toFixed(4) + '</text>';
      s += '<text x="' + (ml - 10) + '" y="' + (y2p(8) + 4) + '" text-anchor="end" fill="#333">' + y4.toFixed(4) + '</text>';
      s += '<text x="' + (ml - 30) + '" y="' + (yt + 10) + '" text-anchor="end" fill="#333" font-size="28" font-weight="bold">Al</text>';
      s += '</svg>';
      return s;
    }
    





    // =è®€å– Aã€Bã€Cã€D çš„ Al/Si å€¼ â†’ èª¿ç”¨ calc_pure() â†’ ç”ŸæˆåŸæ–™ç™¾åˆ†æ¯”è¡¨æ ¼
    
    function doCalculation() {
      let c = document.querySelectorAll('.vals tbody .num');
      let pts = [
        {l: 'A', al: parseFloat(c[6].textContent), si: parseFloat(c[7].textContent)},
        {l: 'B', al: parseFloat(c[17].textContent), si: parseFloat(c[18].textContent)},
        {l: 'C', al: parseFloat(c[28].textContent), si: parseFloat(c[29].textContent)},
        {l: 'D', al: parseFloat(c[39].textContent), si: parseFloat(c[40].textContent)}
      ];
      let rs = pts.map(p => calc_pure({...baseData, al: p.al, si: p.si}));
      let feldsparNames = {1: 'éœæ­£', 2: 'æ—¥åŒ–', 3: 'å—é', 4: 'é‡œæˆ¶', 5: 'æ¾³æ´²', 6: 'å°åº¦', 7: 'å®‰é¤Š'};
      let feldsparLabel = feldsparNames[baseData.f_type] || 'é•·çŸ³';
      let nm = [feldsparLabel, 'ç¢³é…¸<br>éˆ£', 'ç¢³é…¸<br>é‹‡', 'æ°§åŒ–<br>é‹…', 'ç¢³é…¸<br>é‚', 'ç¢³é…¸<br>é¶', 'ç™½é›²<br>çŸ³', 'æ»‘çŸ³', 'é«˜å¶º<br>åœŸ', 'æ°§åŒ–<br>é‹', 'çŸ³è‹±', 'äºŒæ°§<br>åŒ–éˆ¦', 'äºŒæ°§<br>åŒ–é‹¯', 'çŸ½é…¸<br>é‹¯', 'äºŒæ°§<br>åŒ–éŒ«'];
      let h = '<div style="margin-top:40px;"><table class="bigtable"><tr style="background:#ffe0e0;font-weight:bold;"><th></th>';
      nm.forEach(n => h += '<th>' + n + '</th>');
      h += '<th>å¤–åŠ </th></tr>';
      rs.forEach((r, i) => {
        h += '<tr><td>' + pts[i].l + '</td>';
        r.p.forEach(v => h += '<td>' + (Math.round(v) || '') + '</td>');
        h += '<td></td></tr>';
      });
      h += '</table>';
      document.getElementById('results').innerHTML = h;
    }
    
    // ========== Si èª¿æ•´å‡½æ•¸ ==========
    
    function increaseSi() {
      buttonFeedback();
      let c = document.querySelectorAll('.vals tbody .num');
      let a1 = parseFloat(c[6].textContent);
      let s1 = (parseFloat(c[7].textContent) + 0.1).toFixed(4);
      let a4 = parseFloat(c[17].textContent);
      let s4 = (parseFloat(c[29].textContent) + 0.1).toFixed(4);
      c[7].textContent = c[18].textContent = s1;
      c[29].textContent = c[40].textContent = s4;
      let con = document.getElementById('svgContainer'), old = con.querySelector('svg');
      if (old) old.remove();
      con.insertAdjacentHTML('afterbegin', genSVG(parseFloat(s1), parseFloat(s4), a1, a4));
      siAdjustCounter++;
      setTimeout(() => doCalculation(), 50);
    }
    
    function decreaseSi() {
      buttonFeedback();
      let c = document.querySelectorAll('.vals tbody .num');
      let s1 = parseFloat(c[7].textContent);
      let s4 = parseFloat(c[29].textContent);
      
      let newS1 = s1 - 0.1;
      let newS4 = s4 - 0.1;
      
      if (newS1 < siMin || newS4 < siMin) {
        return;
      }
      
      let a1 = parseFloat(c[6].textContent);
      let a4 = parseFloat(c[17].textContent);
      
      c[7].textContent = c[18].textContent = newS1.toFixed(4);
      c[29].textContent = c[40].textContent = newS4.toFixed(4);
      let con = document.getElementById('svgContainer'), old = con.querySelector('svg');
      if (old) old.remove();
      con.insertAdjacentHTML('afterbegin', genSVG(newS1, newS4, a1, a4));
      siAdjustCounter--;
      setTimeout(() => doCalculation(), 50);
    }
    
    // ========== Al èª¿æ•´å‡½æ•¸ ==========
    
    function increaseAl() {
      buttonFeedback();
      let c = document.querySelectorAll('.vals tbody .num');
      let a1 = (parseFloat(c[6].textContent) + 0.01).toFixed(4);
      let s1 = parseFloat(c[7].textContent);
      let a4 = (parseFloat(c[17].textContent) + 0.01).toFixed(4);
      let s4 = parseFloat(c[29].textContent);
      c[6].textContent = c[39].textContent = a1;
      c[17].textContent = c[28].textContent = a4;
      let con = document.getElementById('svgContainer'), old = con.querySelector('svg');
      if (old) old.remove();
      con.insertAdjacentHTML('afterbegin', genSVG(s1, s4, parseFloat(a1), parseFloat(a4)));
      alAdjustCounter++;
      setTimeout(() => doCalculation(), 50);
    }
    
    function decreaseAl() {
      buttonFeedback();
      let c = document.querySelectorAll('.vals tbody .num');
      let a1 = parseFloat(c[6].textContent);
      let a4 = parseFloat(c[17].textContent);
      
      let newA1 = a1 - 0.01;
      let newA4 = a4 - 0.01;
      
      if (newA1 < alMin || newA4 < alMin) {
        return;
      }
      
      let s1 = parseFloat(c[7].textContent);
      let s4 = parseFloat(c[29].textContent);
      
      c[6].textContent = c[39].textContent = newA1.toFixed(4);
      c[17].textContent = c[28].textContent = newA4.toFixed(4);
      let con = document.getElementById('svgContainer'), old = con.querySelector('svg');
      if (old) old.remove();
      con.insertAdjacentHTML('afterbegin', genSVG(s1, s4, newA1, newA4));
      alAdjustCounter--;
      setTimeout(() => doCalculation(), 50);
    }
    

    
    // æ€ªç•°é•·ç›¸(():  setTimeout(function() { doCalculation();}, 300);
    
    setTimeout(() => {
      // Si +
      let siPlus = document.getElementById('siPlus');
      siPlus.onmousedown = siPlus.ontouchstart = (e) => {
        e.preventDefault();
        increaseSi();
        startHold(increaseSi);
      };
      siPlus.onmouseup = siPlus.onmouseleave = siPlus.ontouchend = siPlus.ontouchcancel = () => {
        stopHold();
      };
      
      // Si -
      let siMinus = document.getElementById('siMinus');
      siMinus.onmousedown = siMinus.ontouchstart = (e) => {
        e.preventDefault();
        decreaseSi();
        startHold(decreaseSi);
      };
      siMinus.onmouseup = siMinus.onmouseleave = siMinus.ontouchend = siMinus.ontouchcancel = () => {
        stopHold();
      };
      
      // Al +
      let alPlus = document.getElementById('alPlus');
      alPlus.onmousedown = alPlus.ontouchstart = (e) => {
        e.preventDefault();
        increaseAl();
        startHold(increaseAl);
      };
      alPlus.onmouseup = alPlus.onmouseleave = alPlus.ontouchend = alPlus.ontouchcancel = () => {
        stopHold();
      };
      
      // Al -
      let alMinus = document.getElementById('alMinus');
      alMinus.onmousedown = alMinus.ontouchstart = (e) => {
        e.preventDefault();
        decreaseAl();
        startHold(decreaseAl);
      };
      alMinus.onmouseup = alMinus.onmouseleave = alMinus.ontouchend = alMinus.ontouchcancel = () => {
        stopHold();
      };
      
      doCalculation();
    }, 300);
  `);
}

//  stull_v22()  çµæŸ  

















// æŒ‰éˆ•åé¥‹å‡½æ•¸ - åªéœ‡å‹•
function buttonFeedback() {
  // æ‰‹æ©Ÿéœ‡å‹•
  if (navigator.vibrate) {
    navigator.vibrate(50); // éœ‡å‹• 50ms
  }
}



// æ›´æ–°é•·çŸ³åç¨±é¡¯ç¤º
function updateFeldsparName(form) {
  const radios = document.getElementsByName("f");
  let selectedName = "éœæ­£"; // âœ… æ”¹æˆéœæ­£
  
  for (let i = 0; i < radios.length; i++) {
    if (radios[i].checked) {
      selectedName = radios[i].value;
      break;
    }
  }
  
  document.getElementById("feldsparName").textContent = selectedName;
}










































//è¨ˆç®—æ©Ÿ

    function updateDisplay() {
      let fullDisplay = expression + currentNumber;
      if (fullDisplay === '') {
        fullDisplay = '0';
      }
      display.textContent = fullDisplay;
    }

    function appendNumber(num) {
      if (justCalculated && num !== '.') {
        currentNumber = num;
        expression = '';
        justCalculated = false;
      } else if (currentNumber === '' || currentNumber === '0') {
        if (num === '.') {
          currentNumber = '0.';
        } else {
          currentNumber = num;
        }
      } else if (num === '.' && currentNumber.includes('.')) {
        return;
      } else {
        currentNumber += num;
      }
      
      if (currentNumber.includes('.')) {
        const parts = currentNumber.split('.');
        if (parts[1].length > 6) {
          currentNumber = parts[0] + '.' + parts[1].slice(0, 6);
        }
      }
      
      updateDisplay();
    }


function appendAlValue() {
  const form = document.forms[0];
  const alValue = form.al.value || "0";
  
  // âœ… æ€»æ˜¯æ¸…ç©ºå¹¶æ˜¾ç¤º Al å€¼
  currentNumber = alValue;
  expression = '';
  justCalculated = false;
  
  updateDisplay();
}

function appendSiValue() {
  const form = document.forms[0];
  const siValue = form.si.value || "0";
  
  // âœ… æ€»æ˜¯æ¸…ç©ºå¹¶æ˜¾ç¤º Si å€¼
  currentNumber = siValue;
  expression = '';
  justCalculated = false;
  
  updateDisplay();
}








    function appendOperator(op) {
      justCalculated = false;
      
      let opSymbol = op;
      if (op === '-') opSymbol = 'âˆ’';
      if (op === '*') opSymbol = 'Ã—';
      if (op === '/') opSymbol = 'Ã·';
      
      if (expression === '') {
        expression = (currentNumber || '0') + ' ' + opSymbol + ' ';
      } else {
        const lastChar = expression.slice(-1);
        if (['+', 'âˆ’', 'Ã—', 'Ã·'].includes(lastChar)) {
          expression = expression.slice(0, -2) + opSymbol + ' ';
        } else {
          expression += (currentNumber || '0') + ' ' + opSymbol + ' ';
        }
      }
      
      currentNumber = '';
      updateDisplay();
    }

    function parseExpression(expr) {
      if (!expr) return 0;
      
      expr = expr.replace(/Ã·/g, '/').replace(/Ã—/g, '*').replace(/âˆ’/g, '-');
      expr = expr.replace(/\s+/g, '');
      
      while (expr.includes('*') || expr.includes('/')) {
        const mulMatch = expr.match(/[\d.]+\*[\d.]+/);
        const divMatch = expr.match(/[\d.]+\/[\d.]+/);
        
        let match = null;
        if (mulMatch && divMatch) {
          match = mulMatch.index < divMatch.index ? mulMatch : divMatch;
        } else {
          match = mulMatch || divMatch;
        }
        
        if (!match) break;
        
        const parts = match[0].split(/[\*/]/);
        let result;
        if (match[0].includes('*')) {
          result = parseFloat(parts[0]) * parseFloat(parts[1]);
        } else {
          result = parseFloat(parts[0]) / parseFloat(parts[1]);
        }
        
        expr = expr.slice(0, match.index) + result + expr.slice(match.index + match[0].length);
      }
      
      while (expr.includes('+') || expr.includes('-')) {
        let idx = -1;
        
        for (let i = 1; i < expr.length; i++) {
          if (expr[i] === '+' || expr[i] === '-') {
            const prevChar = expr[i-1];
            if (/[\d.]/.test(prevChar)) {
              idx = i;
              break;
            }
          }
        }
        
        if (idx === -1) break;
        
        const op = expr[idx];
        let leftNum = '';
        let rightNum = '';
        
        for (let i = idx - 1; i >= 0; i--) {
          if (/[\d.]/.test(expr[i])) {
            leftNum = expr[i] + leftNum;
          } else {
            break;
          }
        }
        
        for (let i = idx + 1; i < expr.length; i++) {
          if (/[\d.]/.test(expr[i])) {
            rightNum += expr[i];
          } else {
            break;
          }
        }
        
        const left = parseFloat(leftNum);
        const right = parseFloat(rightNum);
        let result = op === '+' ? left + right : left - right;
        
        expr = expr.replace(leftNum + op + rightNum, result);
      }
      
      return parseFloat(expr);
    }

    function calculate() {
      if (expression === '') return;
      
      let fullExpr = expression + (currentNumber || '0');
      
      try {
        let result = parseExpression(fullExpr);
        result = parseFloat(result.toFixed(6));
        currentNumber = result.toString();
        expression = '';
        justCalculated = true;
      } catch(e) {
        currentNumber = 'ERROR';
        expression = '';
      }
      
      updateDisplay();
    }

    function clearDisplay() {
      currentNumber = '';
      expression = '';
      justCalculated = false;
      updateDisplay();
    }

    function deleteLastChar() {
      justCalculated = false;
      if (currentNumber.length > 1) {
        currentNumber = currentNumber.slice(0, -1);
      } else if (currentNumber.length === 1) {
        currentNumber = '';
      }
      updateDisplay();
    }
let display = null;

document.addEventListener('DOMContentLoaded', function() {
  display = document.getElementById('display');
  updateDisplay();
});



// å°‡è¨ˆç®—æ©Ÿ çµæœå¡«å…¥ Al è¼¸å…¥æ¡†
function fill_Al_value(form) {
  let display = document.getElementById('display');
  let result = display.textContent;
  
  if (result && result !== 'Error' && result !== '0') {
    document.getElementById('al').value = result;
    
    let alInput = document.getElementById('al');
    if (alInput.onblur) {
      alInput.onblur();
    }
  }
}

// å°‡è¨ˆç®—æ©Ÿ çµæœå¡«å…¥ Si è¼¸å…¥æ¡†
function fill_Si_value(form) {
  let display = document.getElementById('display');
  let result = display.textContent;
  
  if (result && result !== 'Error' && result !== '0') {
    document.getElementById('si').value = result;
    
    let siInput = document.getElementById('si');
    if (siInput.onblur) {
      siInput.onblur();
    }
  }
}














//   é›»è…¦éµç›¤ç›£è¦–


//   é›»è…¦éµç›¤ç›£è¦–
document.addEventListener('keydown', handleKeyPress);

function handleKeyPress(event) {
  // âœ… æª¢æŸ¥ç•¶å‰ç„¦é»æ˜¯å¦åœ¨è¼¸å…¥æ¡†ä¸Š
  const activeElement = document.activeElement;
  const isInputFocused = activeElement && (
    activeElement.tagName === 'INPUT' || 
    activeElement.tagName === 'TEXTAREA' || 
    activeElement.tagName === 'SELECT'
  );
  
  // âœ… å¦‚æœç„¦é»åœ¨è¼¸å…¥æ¡†ä¸Šï¼Œä¸è™•ç†è¨ˆç®—æ©ŸæŒ‰éµ
  if (isInputFocused) {
    return;
  }
  
  const key = event.key;

  // æ•¸å­—éµ 0â€“9
  if (!isNaN(key)) {
    buttonFeedback();
    appendNumber(key);
    return;
  }

  // å°æ•¸é»
  if (key === '.') {
    buttonFeedback();
    appendNumber('.');
    return;
  }

  // é‹ç®—ç¬¦è™Ÿ
  if (['+', '-', '*', '/'].includes(key)) {
    buttonFeedback();
    appendOperator(key);
    return;
  }

  // Enter æˆ– =
  if (key === 'Enter' || key === '=') {
    event.preventDefault(); // é¿å…æäº¤è¡¨å–®
    buttonFeedback();
    calculate();
    return;
  }

  // Backspace æˆ– Delete
  if (key === 'Backspace' || key === 'Delete') {
    buttonFeedback();
    deleteLastChar();
    return;
  }

  // Escape æ¸…é™¤
  if (key === 'Escape') {
    buttonFeedback();
    clearDisplay();
    return;
  }
}






//   ä¸å¸Œæœ›ã€Œé€£é»å…©ä¸‹è‡ªå‹•æ”¾å¤§ã€â€”â€”
//    é‚£å°±åŠ é€™æ®µ JavaScriptï¼š

let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
  const now = new Date().getTime();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault(); // é˜»æ­¢é›™æ“Šç¸®æ”¾
  }
  lastTouchEnd = now;
}, false);




// ========== è‡ªå‹•é›¢é–‹è¼¸å…¥æ¡†åŠŸèƒ½ ==========
// åœç•™6ç§’å¾Œè‡ªå‹•è®“æ¸¸æ¨™é›¢é–‹ï¼Œæ•¸å­—éµç›¤æ¶ˆå¤±

let autoBlurTimer = null;

document.addEventListener('DOMContentLoaded', function() {
  // é¸å–æ‰€æœ‰æ•¸å­—è¼¸å…¥æ¡†ï¼ˆæ’é™¤è¨ˆç®—æ©Ÿçš„ displayï¼‰
  const numberInputs = document.querySelectorAll('input[inputmode="decimal"], input[type="text"][inputmode="decimal"]');
  
  numberInputs.forEach(input => {
    // æ’é™¤è¨ˆç®—æ©Ÿé¡¯ç¤ºå™¨
    if (input.id === 'display') return;
    
    // ç›£è½è¼¸å…¥äº‹ä»¶
    input.addEventListener('input', function() {
      // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
      if (autoBlurTimer) {
        clearTimeout(autoBlurTimer);
      }
      
      // è¨­ç½®æ–°çš„6ç§’è¨ˆæ™‚å™¨
      autoBlurTimer = setTimeout(() => {
        input.blur();  // è®“è¼¸å…¥æ¡†å¤±å»ç„¦é»
        autoBlurTimer = null;
      }, 6000);  // âœ… æ”¹æˆ 6000ï¼ˆ6ç§’ï¼‰
    });
    
    // ç•¶æ‰‹å‹•é›¢é–‹è¼¸å…¥æ¡†æ™‚ï¼Œå–æ¶ˆè¨ˆæ™‚å™¨
    input.addEventListener('blur', function() {
      if (autoBlurTimer) {
        clearTimeout(autoBlurTimer);
        autoBlurTimer = null;
      }
    });
    
    // âœ… ç•¶ç²å¾—ç„¦é»æ™‚ï¼Œå•Ÿå‹•è¨ˆæ™‚å™¨
    input.addEventListener('focus', function() {
      // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
      if (autoBlurTimer) {
        clearTimeout(autoBlurTimer);
      }
      
      // è¨­ç½®æ–°çš„6ç§’è¨ˆæ™‚å™¨
      autoBlurTimer = setTimeout(() => {
        input.blur();  // è®“è¼¸å…¥æ¡†å¤±å»ç„¦é»
        autoBlurTimer = null;
      }, 6000);  // âœ… æ”¹æˆ 6000ï¼ˆ6ç§’ï¼‰
    });
  });
});

// ========== âœ… æ–°ä»£ç¢¼çµæŸ âœ… ==========




// ========== æª¢æŸ¥è³½æ ¼é‡‰å¼æ˜¯å¦å®Œæ•´ ==========
function checkSegarComplete(form) {
  // ç²å–ç•¶å‰å€¼
  const kna = parseFloat(form.kna.value) || 0;
  const ca = parseFloat(form.ca.value) || 0;
  const ba = parseFloat(form.ba.value) || 0;
  const zn = parseFloat(form.zn.value) || 0;
  const mg = parseFloat(form.mg.value) || 0;
  const sr = parseFloat(form.sr.value) || 0;
  const al = parseFloat(form.al.value) || 0;
  const si = parseFloat(form.si.value) || 0;
  
  // è¨ˆç®—é¹¼ç¸½å’Œ
  const alkalineTotal = kna + ca + ba + zn + mg + sr;
  
  // ç²å–æœ€å°å€¼
  const caMin = parseFloat(form.Ca_min_message.value) || 0;
  const mgMin = parseFloat(form.Mg_min_message.value) || 0;
  const alMin = parseFloat(form.Al_min_message.value) || 0;
  const siMin = parseFloat(form.Si_min_message.value) || 0;
  
  // æª¢æŸ¥æ˜¯å¦å®Œæ•´
  const isAlkalineComplete = Math.abs(alkalineTotal - 1.0) < 0.002; // å®¹è¨±èª¤å·®
  const isCaValid = ca >= caMin - 0.00001;
  const isMgValid = mg >= mgMin - 0.00001;
  const isAlValid = al >= alMin - 0.00001;
  const isSiValid = si >= siMin - 0.00001;
  
  const isComplete = isAlkalineComplete && isCaValid && isMgValid && isAlValid && isSiValid;
  
  // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
  const btn = document.getElementById('calculateBtn');
  if (btn) {
    if (isComplete) {
      btn.value = 'âœ“ è¨ˆç®— â•â•â•â¤';
      btn.style.color = '#fff';
    } else {
      btn.value = 'è¨ˆç®— â•â•â•â¤';
    }
  }
}


// ========== æª¢æŸ¥ç™¾åˆ†æ¯”é…æ–¹æ˜¯å¦å®Œæ•´ ==========
function checkPercentComplete(form) {
  // ç²å–æ‰€æœ‰åŸæ–™çš„ç™¾åˆ†æ¯”å€¼
  const percentages = [];
  for (let i = 0; i <= 14; i++) {
    const val = parseFloat(form.p[i].value) || 0;
    percentages[i] = val;
  }
  
  // æ¢ä»¶1: é¹¼æ€§æ°§åŒ–ç‰©è‡³å°‘ä¸€å€‹ (é•·çŸ³ã€ç¢³é…¸éˆ£ã€ç¢³é…¸é‹‡ã€æ°§åŒ–é‹…ã€ç¢³é…¸é‚ã€ç¢³é…¸é¶ã€ç™½é›²çŸ³ã€æ»‘çŸ³)
  const hasAlkaline = percentages[0] > 0 || // é•·çŸ³
                      percentages[1] > 0 || // ç¢³é…¸éˆ£
                      percentages[2] > 0 || // ç¢³é…¸é‹‡
                      percentages[3] > 0 || // æ°§åŒ–é‹…
                      percentages[4] > 0 || // ç¢³é…¸é‚
                      percentages[5] > 0 || // ç¢³é…¸é¶
                      percentages[6] > 0 || // ç™½é›²çŸ³
                      percentages[7] > 0;   // æ»‘çŸ³
  
  // æ¢ä»¶2: é‹æºè‡³å°‘ä¸€å€‹ (é•·çŸ³ã€é«˜å¶ºåœŸã€æ°§åŒ–é‹)
  const hasAluminum = percentages[0] > 0 || // é•·çŸ³
                      percentages[8] > 0 || // é«˜å¶ºåœŸ
                      percentages[9] > 0;   // æ°§åŒ–é‹
  
  // æ¢ä»¶3: çŸ½æºè‡³å°‘ä¸€å€‹ (é•·çŸ³ã€æ»‘çŸ³ã€é«˜å¶ºåœŸã€äºŒæ°§åŒ–çŸ½)
  const hasSilica = percentages[0] > 0 ||  // é•·çŸ³
                    percentages[7] > 0 ||  // æ»‘çŸ³
                    percentages[8] > 0 ||  // é«˜å¶ºåœŸ
                    percentages[10] > 0;   // äºŒæ°§åŒ–çŸ½(çŸ³è‹±)
  
  // åˆ¤æ–·æ˜¯å¦å®Œæ•´
  const isComplete = hasAlkaline && hasAluminum && hasSilica;
  
  // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
  const btn = document.getElementById('calculateBtn2');
  if (btn) {
    if (isComplete) {
      btn.value = 'âœ“ è¨ˆç®— â—€â•â•â•';
    } else {
      btn.value = 'è¨ˆç®— â—€â•â•â•';
    }
  }
}







// ========== æ ¹æ“š Si å€¼ åˆ¤æ–·é‡‰è—¥æµå‹•  ==========
function updateGlazeType1(form) {
    const siValue = parseFloat(form.si.value) || 0;
    const selectElement = document.getElementById('glazeType1');
    
    if (!selectElement || siValue === 0) return;
    
    // âœ… æ–°å¢ï¼šSi < 1.0 æ™‚è¨­ç‚ºéš¨æ©Ÿ
    if (siValue < 1.0) {
        selectElement.value = 'general';
        return;
    }
    
    // æ ¹æ“š Si å€¼ç¯„åœåˆ¤æ–·é¡å‹
    if (siValue >= 2.3 && siValue <= 5.0) {
        selectElement.value = 'highTemp';  // ä¸æ˜“æµé‡‰
    } else if (siValue >= 1.8 && siValue < 2.3) {
        selectElement.value = 'medTemp';   // è¼•å¾®æµé‡‰
    } else if (siValue >= 1.2 && siValue < 1.8) {
        selectElement.value = 'lowTemp';   // æ˜“æµé‡‰
    } else {
        selectElement.value = 'general';   // éš¨æ©Ÿï¼ˆä¸ç¬¦åˆä»»ä½•æ¢ä»¶ï¼‰
    }
}



// ========== æ ¹æ“š Mg å’Œä¸­é…¸æ¯”  åˆ¤æ–·è¡¨é¢äº®é¢ ç„¡å…‰==========
function updateGlazeType2(form) {
    const siValue = parseFloat(form.si.value) || 0;
    const alValue = parseFloat(form.al.value) || 0;
    const mgValue = parseFloat(form.mg.value) || 0;
    const caValue = parseFloat(form.ca.value) || 0;
    const baValue = parseFloat(form.ba.value) || 0;
    const znValue = parseFloat(form.zn.value) || 0;
    const srValue = parseFloat(form.sr.value) || 0;
    const selectElement = document.getElementById('glazeType2');
    
    if (!selectElement || siValue === 0 || alValue === 0) {
        if (selectElement) selectElement.value = 'general';
        return;
    }
    
    // Si < 1.0 æ™‚è¨­ç‚ºéš¨æ©Ÿ
    if (siValue < 1.0) {
        selectElement.value = 'general';
        return;
    }
    
    // è¨ˆç®—ä¸­é…¸æ¯” (multiplier)
    const multiplier = siValue / alValue;
    
    // æª¢æŸ¥æ˜¯å¦æœ‰é«˜æ¿ƒåº¦é¹¼æ€§æ°§åŒ–ç‰©
    const hasHighAlkaline = caValue > 0.7 || baValue > 0.4 || znValue > 0.8 || srValue > 0.5;
    
    // åˆ¤æ–·é‡‰è—¥è¡¨é¢é¡å‹
    if (mgValue >= 0.2 && multiplier >= 7.0 && multiplier <= 12.0) {
        selectElement.value = 'matte_Mg';  // é‚ç„¡å…‰
    } else if (hasHighAlkaline) {
        selectElement.value = 'matte';      // ä¸€èˆ¬ç„¡å…‰ï¼ˆé«˜æ¿ƒåº¦é¹¼ï¼‰
    } else if (mgValue <= 0.1 && multiplier >= 6.0 && multiplier <= 15.0) {
        selectElement.value = 'glossy';     // äº®å…‰
    } else if (multiplier >= 3.99 && multiplier <= 5.5) {  // âœ… æ”¹ç‚º 3.99~5.79
        selectElement.value = 'matte';      // ä¸€èˆ¬ç„¡å…‰ï¼ˆä¸­é…¸æ¯”ï¼‰
    } else {
        selectElement.value = 'general';    // éš¨æ©Ÿ
    }
}











</script>












<style>
/* ğŸ”¥ ç¦ç”¨ä¸‹æ‹‰é‡æ–°æ•´ç† */
html {
  overscroll-behavior-y: none;
}
body {
  overscroll-behavior: none;
  background-color: #f5e0ff;
  background-image: 
    repeating-linear-gradient(90deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 2px, transparent 2px, transparent 6px),
    repeating-linear-gradient(90deg, rgba(255,255,255,0.08) 0px, rgba(255,255,255,0.08) 12px, transparent 12px, transparent 24px),
    radial-gradient(rgba(0,0,0,0.04) 1px, transparent 1px);
  background-size: 8px 100%, 48px 100%, 3px 3px;
  background-blend-mode: overlay;
}
.save-btn, .load-btn {
  padding: 4px 8px;
  margin: 2px;
  cursor: pointer;
}
.save-btn.has-data {
  background-color: #90EE90;
  font-weight: bold;
}
.load-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.button-row {
  display: flex;
  gap: 4px;
  justify-content: center;
}
#urlLengthBox {
  background-color: #f5e0ff;
  color: #e6e0ff;
  border: none;
  outline: none;
  width: 40px;
  text-align: center;
}
#urlLengthBox::selection {
  background: black;
  color: white;
}

/* ========== âœ… å…è¨±åœ¨è¼¸å…¥æ¡†ä¸Šæ»‘å‹• ========== */
input[type="text"],
input[type="number"],
textarea,
select {
  touch-action: auto !important;
  -webkit-overflow-scrolling: touch;
  pointer-events: auto;
}
/* ========== âœ… ä¿®æ”¹çµæŸ ========== */
/* ========== è¨ˆç®—æ©Ÿçš„CSSæ¨£å¼ - 14px å­—é«”ç‰ˆ ========== */
.calculator {
  background: #f5e0ff;
  padding: 4px;
  border-radius: 5px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  width: 165px;
  margin: 0 auto;
}
.calculator-title {
  background: linear-gradient(135deg, #8a2be2 0%, #9a3bf2 100%);
  color: #ffffff;
  font-size: 14px;
  font-weight: bold;
  text-align: center;
  padding: 4px;
  border-radius: 3px 3px 0 0;
  margin: -4px -4px 3px -4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  letter-spacing: 2px;
}
.display {
  background: #ffffff;
  color: #5d3fd3;
  font-size: 14px;
  padding: 5px;
  text-align: right;
  border-radius: 3px;
  margin-bottom: 3px;
  min-height: 20px;
  word-wrap: break-word;
  word-break: break-all;
  line-height: 1.1;
  border: 2px solid #8a2be2;
  font-weight: bold;
}
.buttons {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 2px;
}
button {
  padding: 3px 2px;
  font-size: 14px;
  border: none;
  border-radius: 2px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.15s;
  min-height: 28px;
  line-height: 1;
}
/* æ•¸å­—æŒ‰éˆ• */
.num {
  background: #f5e0ff;
  color: #5d3fd3;
  border: 1px solid #c45cff;
}
.num:hover {
  background: #e0c5ff;
  border-color: #9a6adf;
}
.num:active {
  transform: scale(0.93);
}
/* é‹ç®—æŒ‰éˆ• */
.op {
  background: #f5e0ff;
  color: #5d3fd3;
  border: 1px solid #c45cff;
}
.op:hover {
  background: #e0c5ff;
  border-color: #9a6adf;
}
.op:active {
  transform: scale(0.93);
}
/* ç­‰æ–¼æŒ‰éˆ• */
.equal {
  background: #f5e0ff;
  color: #5d3fd3;
  border: 1px solid #c45cff;
}
.equal:hover {
  background: #e0c5ff;
  border-color: #9a6adf;
}
.equal:active {
  transform: scale(0.93);
}
/* æ¸…é™¤æŒ‰éˆ• */
.clear {
  background: #f5e0ff;
  color: #5d3fd3;
  border: 1px solid #c45cff;
}
.clear:hover {
  background: #e0c5ff;
  border-color: #9a6adf;
}
.clear:active {
  transform: scale(0.93);
}
/* åˆªé™¤æŒ‰éˆ• */
.delete {
  background: #f5e0ff;
  color: #5d3fd3;
  border: 1px solid #c45cff;
}
.delete:hover {
  background: #e0c5ff;
  border-color: #9a6adf;
}
.delete:active {
  transform: scale(0.93);
}
/* Al å’Œ Si é›™åŠŸèƒ½æŒ‰éˆ• */
.dual-btn-al, .dual-btn-si {
  background: #f5e0ff;
  color: #5d3fd3;
  border: 1px solid #c45cff;
  font-size: 13px;
}
.dual-btn-al:hover, .dual-btn-si:hover {
  background: #e0c5ff;
  border-color: #9a6adf;
}
.dual-btn-al:active, .dual-btn-si:active {
  transform: scale(0.93);
}
/* ç®­é ­æŒ‰éˆ• */
.arrow-btn {
  background: #f5e0ff;
  color: #5d3fd3;
  border: 1px solid #c45cff;
  font-size: 11px;
  padding: 2px;
}
.arrow-btn:hover {
  background: #e0c5ff;
  border-color: #9a6adf;
}
.arrow-btn:active {
  transform: scale(0.93);
}
</style>




  <form>
    <center>
      <font size="6" color="#5d3fd3">é»ƒç‰è‹±èˆ‡é‚±è‚²æ°‘çš„â”€é‡‰è—¥è¨­è¨ˆç¨‹å¼</font>
      <font size="3"><font color="#5d3fd3" size="2">2025.11.30ä¿®è¨‚</font><br>
      <font color="#a52a2a" size="2"><a href="https://www.facebook.com/%E9%BB%83%E7%8E%89%E8%8B%B1-%E9%99%B6%E8%97%9D%E7%90%89%E7%92%83-261133624087947/">è«‹æŒ‰æˆ‘ï¼Œé€²å…¥é»ƒç‰è‹± é™¶è—/ç‰ç’ƒ ç²‰çµ²å°ˆé ï¼</a></font><br>
      <font color="#a62a2a" size="2"><a href="https://www.yuyinghuang.com/">è«‹æŒ‰æˆ‘ï¼Œé€²å…¥ Yu-Ying Huang Ceramics é»ƒç‰è‹±é™¶è— å®˜æ–¹ç¶²é !</a></font><br>
      <font color="#000000" size="2"><a href="https://www.threads.com/@yumin1221_">è«‹æŒ‰æˆ‘ï¼Œé€²å…¥ é‚±è‚²æ°‘threadså°ˆé !</a></font><br><br>
      
      <table border="5" cellspace="2" bordercolor="#5d3fd3">
        <tbody>
          <tr align="center">
            <td><font color="#a52a2a" size="">é•·çŸ³ç¨®é¡</font></td>
<td>
<input name="f" type="radio" checked="true" value="éœæ­£" onchange="updateFeldsparName(this.form); check_CaMgAlSi_MinimumValues(this.form)">éœæ­£
<input name="f" type="radio" value="æ—¥åŒ–" onchange="updateFeldsparName(this.form);check_CaMgAlSi_MinimumValues(this.form)">æ—¥åŒ–<input name="f" type="radio" value="å°åº¦" onchange="updateFeldsparName(this.form);check_CaMgAlSi_MinimumValues(this.form)">å°åº¦
<input name="f" type="radio" value="æ¾³æ´²" onchange="updateFeldsparName(this.form);check_CaMgAlSi_MinimumValues(this.form)">æ¾³æ´²
<input name="f" type="radio" value="é‡œæˆ¶" onchange="updateFeldsparName(this.form);check_CaMgAlSi_MinimumValues(this.form)">é‡œæˆ¶
<input name="f" type="radio" value="SH-1" onchange="updateFeldsparName(this.form);check_CaMgAlSi_MinimumValues(this.form)">æ—¥æœ¬SH-1
<input name="f" type="radio" value="ç¦å³¶" onchange="updateFeldsparName(this.form);check_CaMgAlSi_MinimumValues(this.form)">ç¦å³¶
<input name="f" type="radio" value="æ–°å¹³æ´¥" onchange="updateFeldsparName(this.form);check_CaMgAlSi_MinimumValues(this.form)">æ–°å¹³æ´¥
<input name="f" type="radio" value="å¡æ–¯ç‰¹" onchange="updateFeldsparName(this.form);check_CaMgAlSi_MinimumValues(this.form)">å¡æ–¯ç‰¹
</td>

       </tr>
          <tr align="center">
            <td><font color="#a52a2a" size="3">é‚ç¨®é¡</font></td>
            <td>
              <input name="m" type="radio" value="ç™½é›²çŸ³">ç™½é›²çŸ³
              <input name="m" type="radio" checked="true" value="æ»‘çŸ³">æ»‘çŸ³
              <input name="m" type="radio" value="ç¢³é…¸é‚">ç¢³é…¸é‚
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      
      <table border="5" cellspace="2" bordercolor="#5d3fd3">
        <tbody>
          <tr align="center">
            <th colspan="2"><font color="#a52a2a" size="4">è³½æ ¼é‡‰å¼(è«è€³æ•¸)</font></th>
            <th rowspan="4">
              <table border="2" bordercolor="#5d3fd3" width="100%" cellspacing="0" cellpadding="6" style="border-collapse:collapse;">
                <tbody>
                  <tr>
                    <td align="center"><font color="#a52a2a" size="4">åŠŸèƒ½éµ</font></td>
                  </tr>


<tr>
  <td align="center">
    <div style="background: linear-gradient(to bottom, #f8e5ff, #f5e0ff); padding: 10px; border-radius: 10px; box-shadow: 0 10px 30px rgba(138, 43, 226, 0.35), 0 5px 15px rgba(0,0,0,0.2); width: 220px; margin: 0 auto; display: flex; flex-direction: column; gap: 6px; border: 1px solid rgba(196, 92, 255, 0.3);">
      <div style="display: flex; gap: 4px;">
        <select id="glazeType1" style="flex: 1; padding: 6px 4px; font-size: 14px; border: 1px solid #c45cff; border-radius: 4px; background: #f5e0ff; color: #5d3fd3; font-weight: bold; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.15); -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: linear-gradient(45deg, transparent 50%, #5d3fd3 50%), linear-gradient(135deg, #5d3fd3 50%, transparent 50%); background-position: calc(100% - 8px) calc(50% - 2px), calc(100% - 4px) calc(50% - 2px); background-size: 4px 4px, 4px 4px; background-repeat: no-repeat;">
          <option value="general">éš¨æ©Ÿ</option>
          <option value="highTemp">ä¸æ˜“æµé‡‰</option>
          <option value="medTemp">è¼•å¾®æµé‡‰</option> 
          <option value="lowTemp">æ˜“æµé‡‰ </option>
        </select>
        <select id="glazeType2" style="flex: 1; padding: 6px 4px; font-size: 14px; border: 1px solid #c45cff; border-radius: 4px; background: #f5e0ff; color: #5d3fd3; font-weight: bold; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.15); -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: linear-gradient(45deg, transparent 50%, #5d3fd3 50%), linear-gradient(135deg, #5d3fd3 50%, transparent 50%); background-position: calc(100% - 8px) calc(50% - 2px), calc(100% - 4px) calc(50% - 2px); background-size: 4px 4px, 4px 4px; background-repeat: no-repeat;">
          <option value="general">éš¨æ©Ÿ</option>
          <option value="matte">ä¸€èˆ¬ç„¡å…‰</option>
          <option value="matte_Mg">é‚ç„¡å…‰</option>
          <option value="glossy">äº®å…‰</option>
        </select>
      </div>
      <input id="loopButton" type="button" value="ğŸ§ª  ç¯„ä¾‹" style="padding: 9px 4px; font-size: 14px; border: 2px solid #c45cff; border-radius: 5px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; width: 100%; box-sizing: border-box; box-shadow: 0 5px 12px rgba(138, 43, 226, 0.3); transform: translateY(-1px);" onmouseover="if(!isLooping) this.style.background='#e0c5ff'" onmouseout="if(!isLooping) this.style.background='#f5e0ff'" onclick="buttonFeedback(); set_default_values(this.form)">
    </div>
  </td>
</tr>


<tr>
  <td align="center">
    <div style="background: #f5e0ff; padding: 6px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); width: 240px; margin: 0 auto; display: flex; flex-direction: column; gap: 4px;">
      
      <!-- ç¬¬ä¸€åˆ—ï¼šè¨ˆç®—â¡ï¸â¡ï¸ å’Œ è¨ˆç®—â¬…ï¸â¬…ï¸ -->
      <div style="display: flex; gap: 4px;">
        <input type="button" id="calculateBtn" value="è¨ˆç®— â•â•â•â¤" 
          style="padding: 8px 4px; font-size: 15px; border: 1px solid #b060ff; border-radius: 3px; cursor: pointer; font-weight: bold; min-height: 38px; flex: 1; background: #8a2be2; color: #fff;" 
          onmouseover="this.style.background='#9a3bf2'" 
          onmouseout="this.style.background='#8a2be2'" 
          onclick="buttonFeedback(); calculate_segar(this.form)">
        
        <input type="button" id="calculateBtn2" value="è¨ˆç®— â—€â•â•â•" 
          style="padding: 8px 4px; font-size: 15px; border: 1px solid #b060ff; border-radius: 3px; cursor: pointer; font-weight: bold; min-height: 38px; flex: 1; background: #8a2be2; color: #fff;" 
          onmouseover="this.style.background='#9a3bf2'" 
          onmouseout="this.style.background='#8a2be2'" 
          onclick="buttonFeedback(); calculate_100(this.form)">
      </div>
      
<!-- ç¬¬äºŒåˆ—ï¼šä¸Šä¸€æ­¥ã€æ¸…ç©ºã€ä¸‹ä¸€æ­¥ -->
<div style="display: flex; gap: 4px;">
  <input type="button" value="ä¸Šä¸€æ­¥" 
    style="padding: 2px 4px; font-size: 12px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; min-height: 36px; width: auto; flex-shrink: 0; background: #f5e0ff; color: #5d3fd3;" 
    onmouseover="this.style.background='#e0c5ff'" 
    onmouseout="this.style.background='#f5e0ff'" 
    onclick="buttonFeedback(); undo(this.form)">
  
  <input type="button" value="ğŸ—‘ï¸ æ¸…ç©º" 
    style="padding: 6px 4px; font-size: 14px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; min-height: 36px; flex: 1; background: #f5e0ff; color: #5d3fd3;" 
    onmouseover="this.style.background='#e0c5ff'" 
    onmouseout="this.style.background='#f5e0ff'" 
    onclick="buttonFeedback(); reset_data(this.form)">
  
  <input type="button" value="ä¸‹ä¸€æ­¥" 
    style="padding: 2px 4px; font-size: 12px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; min-height: 36px; width: auto; flex-shrink: 0; background: #f5e0ff; color: #5d3fd3;" 
    onmouseover="this.style.background='#e0c5ff'" 
    onmouseout="this.style.background='#f5e0ff'" 
    onclick="buttonFeedback(); redo(this.form)">
</div>
      
    </div>
    <input id="loadFile" type="file" accept="application/json" style="display:none" onchange="handleFile(this, this.form)">
  </td>
</tr>


<tr>
  <td align="center" style="padding: 0px;">
    <div class="calculator">
      <!-- âœ“ æ–°å¢: è¨ˆç®—æ©Ÿæ¨™é¡Œ -->
      <div class="calculator-title">è¨ˆç®—æ©Ÿ</div>
      
      <div class="display" id="display">0</div>
      <div class="buttons">
        <!-- ç¬¬1è¡Œ: 7, 8, 9, Ã·, C, â† -->
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('7')">7</button>
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('8')">8</button>
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('9')">9</button>
        <button type="button" class="op" onclick="buttonFeedback(); appendOperator('/')">Ã·</button>
        <button type="button" class="clear" onclick="buttonFeedback(); clearDisplay()">C</button>
        <button type="button" class="delete" onclick="buttonFeedback(); deleteLastChar()">â†</button>
        
        <!-- ç¬¬2è¡Œ: 4, 5, 6, Ã—, Al, â†– -->
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('4')">4</button>
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('5')">5</button>
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('6')">6</button>
        <button type="button" class="op" onclick="buttonFeedback(); appendOperator('*')">Ã—</button>
        <button type="button" class="dual-btn-al" onclick="buttonFeedback(); appendAlValue()">Al</button>
        <button type="button" class="arrow-btn" onclick="buttonFeedback(); fill_Al_value(this.form)">â†–</button>
        
        <!-- ç¬¬3è¡Œ: 1, 2, 3, âˆ’, Si, â†– -->
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('1')">1</button>
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('2')">2</button>
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('3')">3</button>
        <button type="button" class="op" onclick="buttonFeedback(); appendOperator('-')">âˆ’</button>
        <button type="button" class="dual-btn-si" onclick="buttonFeedback(); appendSiValue()">Si</button>
        <button type="button" class="arrow-btn" onclick="buttonFeedback(); fill_Si_value(this.form)">â†–</button>
        
        <!-- ç¬¬4è¡Œ: 0, ., =, +, (ç©º), (ç©º) -->
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('0')">0</button>
        <button type="button" class="num" onclick="buttonFeedback(); appendNumber('.')">.</button>
        <button type="button" class="equal" onclick="buttonFeedback(); calculate()">=</button>
        <button type="button" class="op" onclick="buttonFeedback(); appendOperator('+')">+</button>
        <!-- æœ€å¾Œå…©å€‹ä½ç½®ç•™ç©º -->
      </div>
    </div>
  </td>
</tr>
                    </tbody>
                  </table>
                </th>
                <th colspan="2">
                  <font color="#a52a2a" size="4">ç™¾åˆ†æ¯”ï¼…&nbsp;&nbsp;
                    <font color="#a52a2a" size="2">
                      <input name="toint" size="2" type="checkbox" value="å–æ•´æ•¸" checked="">æ•´æ•¸&nbsp;&nbsp;&nbsp;&nbsp;
                    </font>
                    <input type="button" size="2" value="X" onclick=" buttonFeedback() ; bay(this.form)">
                    <input type="text" size="3" id="mult" name="multiple_value" value="1" inputmode="decimal">
                  </font>
                </th>
              </tr>
              <tr align="center">
                <td><font color="#a52a2a">é¹¼</font></td>
                <td>
                  <nobr>é‰€éˆ‰(KNa)<input type="text" id="kna" name="kna" value="" size="6" inputmode="decimal" onblur="compare_kna(this.form, this.form.kna.value)"></nobr><br><br>
                  <nobr>
                  éˆ£(Ca)<input type="text" id="ca" name="ca" value="" size="6" inputmode="decimal" onblur="compare_ca(this.form, this.form.ca.value)" style="color: black;"></nobr><br><br>
                  <nobr>é‹‡(Ba)<input type="text" id="ba" name="ba" value="" size="6" inputmode="decimal" onblur="check_jen(this.form)">
                  é‹…(Zn)<input type="text" id="zn" name="zn" value="" size="6" inputmode="decimal" onblur="check_jen(this.form)"></nobr><br><br>
                  <nobr>é‚(Mg)<input type="text" id="mg" name="mg" value="" size="6" inputmode="decimal" onblur="compare_mg(this.form, this.form.mg.value)" style="color: black;">
                  é¶(Sr)<input type="text" id="sr" name="sr" value="" size="6" inputmode="decimal" onblur="check_jen(this.form)"></nobr><br><br>



<table border="2" bordercolor="#5d3fd3" width="100%" cellspacing="0" cellpadding="6" style="border-collapse:collapse;">
    <tbody>
      <tr align="center">
        <td align="center" style="position: relative;">
          <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
          <div id="alkalineMessageArea" style="position: relative; min-height: 20px;">
            <span id="alkalineMessage" style="display: none; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 3px; font-size: 14px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 1000; white-space: nowrap;"></span>
          </div>
          
          <div style="font-size: 15px; color: #a52a2a; margin-top: 10px; margin-bottom: 10px;">
            é¹¼è«è€³æ•¸ï¼š<span id="alkalineTotal" style="color:#a52a2a; font-size: 15px;">0</span>
            &nbsp;&nbsp;ä¸è¶³é¡ï¼š<span id="alkalineShortage" style="color:#a52a2a; font-size: 15px;">1.0000</span>
          </div>
          ä¸è¶³é¡é€çµ¦
          <input type="button" value="éˆ£" onclick="buttonFeedback(); ADD_Ca(this.form)" style="padding: 5px 10px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); transition: 0.15s; font-size: 16px;" onmouseover="this.style.background='#e0c5ff'" onmouseout="this.style.background='#f5e0ff'">
          <input type="button" value="é‹‡" onclick="buttonFeedback(); ADD_Ba(this.form)" style="padding: 3px 6px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); transition: 0.15s; font-size: 11px;" onmouseover="this.style.background='#e0c5ff'" onmouseout="this.style.background='#f5e0ff'">
          <input type="button" value="é‹…" onclick="buttonFeedback(); ADD_Zn(this.form)" style="padding: 3px 6px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); transition: 0.15s; font-size: 11px;" onmouseover="this.style.background='#e0c5ff'" onmouseout="this.style.background='#f5e0ff'">
          <input type="button" value="é‚" onclick="buttonFeedback(); ADD_Mg(this.form)" style="padding: 3px 6px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); transition: 0.15s; font-size: 11px;" onmouseover="this.style.background='#e0c5ff'" onmouseout="this.style.background='#f5e0ff'">
          <input type="button" value="é¶" onclick="buttonFeedback(); ADD_Sr(this.form)" style="padding: 3px 6px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); transition: 0.15s; font-size: 11px;" onmouseover="this.style.background='#e0c5ff'" onmouseout="this.style.background='#f5e0ff'">
        </td>
      </tr>
    </tbody>
</table>
   
                </td>
                <td colspan="2" rowspan="4" align="left">
                  <font size="3">
                    <center>
                      <nobr><span id="feldsparName" style="color:#a52a2a; font-weight:bold;">éœæ­£</span>é•·çŸ³
                        <input type="text" id="p1" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)">
                      
                      ç¢³é…¸éˆ£<input type="text" id="p2" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)"></nobr><br><br>
                      <nobr>ç¢³é…¸é‹‡<input type="text" id="p3" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)">
                      æ°§åŒ–é‹…<input type="text" id="p4" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)"></nobr><br><br>
                      <nobr>ç¢³é…¸é‚<input type="text" id="p5" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)">
                      ç¢³é…¸é¶<input type="text" id="p6" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)"></nobr><br><br>
                      <nobr>ç™½é›²çŸ³<input type="text" id="p7" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)">
                      æ»‘çŸ³<input type="text" id="p8" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)"></nobr><br><br>
                      <nobr>é«˜å¶ºåœŸ<input type="text" id="p9" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)">
                      æ°§åŒ–é‹<input type="text" id="p10" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)"></nobr><br><br>
                      <nobr>äºŒæ°§åŒ–çŸ½(çŸ³è‹±)<input type="text" id="p11" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)"></nobr><br><br>
                      <nobr>äºŒæ°§åŒ–éˆ¦(é‡‘ç´…çŸ³)<input type="text" id="p12" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)"></nobr><br><br>
                      <nobr>äºŒæ°§åŒ–é‹¯<input type="text" id="p13" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)">
                      çŸ½é…¸é‹¯<input type="text" id="p14" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)"></nobr><br><br>
                      <nobr>äºŒæ°§åŒ–éŒ«<input type="text" id="p15" name="p" value="" size="4" inputmode="decimal" onblur="check_percent(this.form)"></nobr><br><br>


<table border="2" bordercolor="#5d3fd3" width="100%" cellspacing="0" cellpadding="2" style="border-collapse:collapse;">
    <tbody>
      <tr align="center">
        <td align="center">
          <div style="font-size: 16px; color: #a52a2a; margin-top: 3px; margin-bottom: 3px; line-height: 1.3;">
            ç›®å‰ç™¾åˆ†æ¯”ç¸½å’Œï¼š<span id="percentTotal" style="color:#a52a2a; font-size: 18px;">0</span>
          </div>
        </td>
      </tr>
    </tbody>
</table>


                       

                    </center>
                  </font>
                </td>
              </tr>
              <tr align="center">
                <td><font color="#a52a2a">ä¸­</font></td>
                <td><nobr>é‹(Al)<input type="text" id="al" name="al" value="" size="6" inputmode="decimal" onblur="compare_al(this.form, this.form.al.value)" style="color: black;"></nobr></td>
              </tr>
              <tr align="center">
                <td><font color="#a52a2a">é…¸</font></td>
                <td>
                  <nobr>çŸ½(Si)<input type="text" id="si" name="si" value="" size="6" inputmode="decimal" onblur="compare_si(this.form, this.form.si.value)" style="color: black;">
                  éˆ¦(Ti)<input type="text" id="ti" name="ti" value="" size="6" inputmode="decimal" onblur="check_jen(this.form)"></nobr><br><br>
                  <nobr>é‹¯(Zr)<input type="text" name="zr" id="zr" value="" size="6" inputmode="decimal" onblur="check_jen(this.form)">
                  éŒ«(Sn)<input type="text" name="sn" id="sn" value="" size="6" inputmode="decimal" onblur="check_jen(this.form)"></nobr><br><br><br>
                  <table border="2" bordercolor="#5d3fd3" width="100%" cellspacing="0" cellpadding="6" style="border-collapse:collapse;">
                    <tbody>
                      <tr align="center">
                        <td align="center">
                          <font color="#a52a2a">ä¸­é…¸æ¯” <input type="text" id="ratio" name="r" value="" readonly="" size="5"></font>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </td>
              </tr>
            </tbody>
          </table>
      
          <hr>
      
          <table border="4" cellspace="10" bordercolor="#5d3fd3">
            <tbody>
              <tr align="center">
                <th><font color="#a52a2a" size="3">æç¤ºæ¬„</font></th>
                <th>
  <div style="background: linear-gradient(to bottom, #f8e5ff, #f5e0ff); padding: 10px; border-radius: 10px; box-shadow: 0 10px 30px rgba(138, 43, 226, 0.35), 0 5px 15px rgba(0,0,0,0.2); border: 1px solid rgba(196, 92, 255, 0.3); display: inline-block;">
    <div style="color: #5d3fd3; font-size: 16px; font-weight: bold;">
      <div style="white-space: nowrap; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
        <span>éˆ£è‡³å°‘ï¼š</span>
        <input type="text" id="ca_min" name="Ca_min_message" value="" readonly="" size="6" style="padding: 4px; border: 1px solid #c45cff; border-radius: 3px; background: #ffffff; color: #5d3fd3; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <input type="button" value="â†–" onclick="buttonFeedback(); fill_Ca_min(this.form)" style="padding: 4px 8px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); transition: 0.15s;" onmouseover="this.style.background='#e0c5ff'" onmouseout="this.style.background='#f5e0ff'">
        <span>é‹è‡³å°‘ï¼š</span>
        <input type="text" id="al_min" name="Al_min_message" value="" readonly="" size="6" style="padding: 4px; border: 1px solid #c45cff; border-radius: 3px; background: #ffffff; color: #5d3fd3; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <input type="button" value="â†–" onclick="buttonFeedback(); fill_Al_min(this.form)" style="padding: 4px 8px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); transition: 0.15s;" onmouseover="this.style.background='#e0c5ff'" onmouseout="this.style.background='#f5e0ff'">
      </div>
      <div style="white-space: nowrap; display: flex; align-items: center; gap: 6px;">
        <span>é‚è‡³å°‘ï¼š</span>
        <input type="text" id="mg_min" name="Mg_min_message" value="" readonly="" size="6" style="padding: 4px; border: 1px solid #c45cff; border-radius: 3px; background: #ffffff; color: #5d3fd3; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <input type="button" value="â†–" onclick="buttonFeedback(); fill_Mg_min(this.form)" style="padding: 4px 8px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); transition: 0.15s;" onmouseover="this.style.background='#e0c5ff'" onmouseout="this.style.background='#f5e0ff'">
        <span>çŸ½è‡³å°‘ï¼š</span>
        <input type="text" id="si_min" name="Si_min_message" value="" readonly="" size="6" style="padding: 4px; border: 1px solid #c45cff; border-radius: 3px; background: #ffffff; color: #5d3fd3; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <input type="button" value="â†–" onclick="buttonFeedback(); fill_Si_min(this.form)" style="padding: 4px 8px; border: 1px solid #c45cff; border-radius: 3px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); transition: 0.15s;" onmouseover="this.style.background='#e0c5ff'" onmouseout="this.style.background='#f5e0ff'">
      </div>
    </div>
  </div>
</th>





              </tr>
            </tbody>
          </table>

          <hr>





<div style="text-align: center;">
  <div style="background: linear-gradient(to bottom, #f8e5ff, #f5e0ff); padding: 12px; border-radius: 10px; box-shadow: 0 10px 30px rgba(138, 43, 226, 0.35), 0 5px 15px rgba(0,0,0,0.2); border: 1px solid rgba(196, 92, 255, 0.3); display: inline-block;">
    <div style="color: #5d3fd3; font-size: 18px; font-weight: bold; margin-bottom: 10px; white-space: nowrap;">
      è¡¨ æ ¼ æš« å­˜ å€
    </div>
    
    <div style="white-space: nowrap;">
      <div style="display: flex; gap: 4px; justify-content: center;">
        <input type="button" id="saveBtn1" class="save-btn" value="å­˜1" onclick="buttonFeedback(); showAllValues(0)" style="padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #c45cff; border-radius: 3px; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 14px;">
        <input type="button" id="saveBtn2" class="save-btn" value="å­˜2" onclick="buttonFeedback(); showAllValues(1)" style="padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #c45cff; border-radius: 3px; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 14px;">
        <input type="button" id="saveBtn3" class="save-btn" value="å­˜3" onclick="buttonFeedback(); showAllValues(2)" style="padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #c45cff; border-radius: 3px; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 14px;">
        <input type="button" id="saveBtn4" class="save-btn" value="å­˜4" onclick="buttonFeedback(); showAllValues(3)" style="padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #c45cff; border-radius: 3px; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 14px;">
        <input type="button" id="saveBtn5" class="save-btn" value="å­˜5" onclick="buttonFeedback(); showAllValues(4)" style="padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #c45cff; border-radius: 3px; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 14px;">
      </div>
    </div>
    
    <div style="white-space: nowrap;">
      <div style="display: flex; gap: 4px; justify-content: center; margin-top: 6px;">
        <input type="button" id="loadBtn1" class="load-btn" value="å–1" onclick="buttonFeedback(); loadValues(0)" disabled="" style="padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #c45cff; border-radius: 3px; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 14px; opacity: 0.5;">
        <input type="button" id="loadBtn2" class="load-btn" value="å–2" onclick="buttonFeedback(); loadValues(1)" disabled="" style="padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #c45cff; border-radius: 3px; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 14px; opacity: 0.5;">
        <input type="button" id="loadBtn3" class="load-btn" value="å–3" onclick="buttonFeedback(); loadValues(2)" disabled="" style="padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #c45cff; border-radius: 3px; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 14px; opacity: 0.5;">
        <input type="button" id="loadBtn4" class="load-btn" value="å–4" onclick="buttonFeedback(); loadValues(3)" disabled="" style="padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #c45cff; border-radius: 3px; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 14px; opacity: 0.5;">
        <input type="button" id="loadBtn5" class="load-btn" value="å–5" onclick="buttonFeedback(); loadValues(4)" disabled="" style="padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #c45cff; border-radius: 3px; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 14px; opacity: 0.5;">
      </div>
    </div>
  </div>
</div>


          <hr><br><br>
          
<input type="button" value="æ¨™æº–åŒ– é¹¼ç³»åˆ—" onclick="buttonFeedback(); jen_standardize()" style="font-size: 18px; padding: 10px 20px; border: 2px solid #c45cff; border-radius: 5px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 5px 12px rgba(138, 43, 226, 0.3); transition: 0.15s; margin: 4px;" onmouseover="this.style.background='#e0c5ff'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 7px 16px rgba(138, 43, 226, 0.4)'" onmouseout="this.style.background='#f5e0ff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 12px rgba(138, 43, 226, 0.3)'">

<button type="button" id="stull" class="stull" onclick="buttonFeedback(); stull_v22()" style="font-size: 18px; padding: 10px 20px; border: 2px solid #c45cff; border-radius: 5px; cursor: pointer; font-weight: bold; background: #f5e0ff; color: #5d3fd3; box-shadow: 0 5px 12px rgba(138, 43, 226, 0.3); transition: 0.15s; line-height: 1.4; margin: 4px;" onmouseover="this.style.background='#e0c5ff'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 7px 16px rgba(138, 43, 226, 0.4)'" onmouseout="this.style.background='#f5e0ff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 12px rgba(138, 43, 226, 0.3)'">ç›´è§’åæ¨™<br>Stull Chart</button>




            <table id="alkaliTable" style="display:none;" border="5" cellspace="2" bordercolor="#5d3fd3">
              <tbody>
                <tr>
                  <th>KNa</th><th>Ca</th><th>Ba</th><th>Zn</th><th>Mg</th><th>Sr</th>
                  <th>Al</th><th>Si</th><th>Ti</th><th>Zr</th><th>Sn</th>
                </tr>
                <tr>
                  <td><input type="text" id="out1" size="5" readonly=""></td>
                  <td><input type="text" id="out2" size="5" readonly=""></td>
                  <td><input type="text" id="out3" size="5" readonly=""></td>
                  <td><input type="text" id="out4" size="5" readonly=""></td>
                  <td><input type="text" id="out5" size="5" readonly=""></td>
                  <td><input type="text" id="out6" size="5" readonly=""></td>
                  <td><input type="text" id="out7" size="5" readonly=""></td>
                  <td><input type="text" id="out8" size="5" readonly=""></td>
                  <td><input type="text" id="out9" size="5" readonly=""></td>
                  <td><input type="text" id="out10" size="5" readonly=""></td>
                  <td><input type="text" id="out11" size="5" readonly=""></td>
                </tr>
                <tr>
                  <td><input type="text" id="row3col1" size="5" readonly=""></td>
                  <td><input type="text" id="row3col2" size="5" readonly=""></td>
                  <td><input type="text" id="row3col3" size="5" readonly=""></td>
                  <td><input type="text" id="row3col4" size="5" readonly=""></td>
                  <td><input type="text" id="row3col5" size="5" readonly=""></td>
                  <td><input type="text" id="row3col6" size="5" readonly=""></td>
                  <td><input type="text" id="row3col7" size="5" readonly=""></td>
                  <td><input type="text" id="row3col8" size="5" readonly=""></td>
                  <td><input type="text" id="row3col9" size="5" readonly=""></td>
                  <td><input type="text" id="row3col10" size="5" readonly=""></td>
                  <td><input type="text" id="row3col11" size="5" readonly=""></td>
                </tr>
                <tr>
                  <td><input type="text" id="row4col1" size="5" readonly=""></td>
                  <td><input type="text" id="row4col2" size="5" readonly=""></td>
                  <td><input type="text" id="row4col3" size="5" readonly=""></td>
                  <td><input type="text" id="row4col4" size="5" readonly=""></td>
                  <td><input type="text" id="row4col5" size="5" readonly=""></td>
                  <td><input type="text" id="row4col6" size="5" readonly=""></td>
                  <td><input type="text" id="row4col7" size="5" readonly=""></td>
                  <td><input type="text" id="row4col8" size="5" readonly=""></td>
                  <td><input type="text" id="row4col9" size="5" readonly=""></td>
                  <td><input type="text" id="row4col10" size="5" readonly=""></td>
                  <td><input type="text" id="row4col11" size="5" readonly=""></td>
                </tr>
                <tr>
                  <td><input type="text" id="row5col1" size="5" readonly=""></td>
                  <td><input type="text" id="row5col2" size="5" readonly=""></td>
                  <td><input type="text" id="row5col3" size="5" readonly=""></td>
                  <td><input type="text" id="row5col4" size="5" readonly=""></td>
                  <td><input type="text" id="row5col5" size="5" readonly=""></td>
                  <td><input type="text" id="row5col6" size="5" readonly=""></td>
                  <td><input type="text" id="row5col7" size="5" readonly=""></td>
                  <td><input type="text" id="row5col8" size="5" readonly=""></td>
                  <td><input type="text" id="row5col9" size="5" readonly=""></td>
                  <td><input type="text" id="row5col10" size="5" readonly=""></td>
                  <td><input type="text" id="row5col11" size="5" readonly=""></td>
                </tr>
                <tr>
                  <td><input type="text" id="row6col1" size="5" readonly=""></td>
                  <td><input type="text" id="row6col2" size="5" readonly=""></td>
                  <td><input type="text" id="row6col3" size="5" readonly=""></td>
                  <td><input type="text" id="row6col4" size="5" readonly=""></td>
                  <td><input type="text" id="row6col5" size="5" readonly=""></td>
                  <td><input type="text" id="row6col6" size="5" readonly=""></td>
                  <td><input type="text" id="row6col7" size="5" readonly=""></td>
                  <td><input type="text" id="row6col8" size="5" readonly=""></td>
                  <td><input type="text" id="row6col9" size="5" readonly=""></td>
                  <td><input type="text" id="row6col10" size="5" readonly=""></td>
                  <td><input type="text" id="row6col11" size="5" readonly=""></td>
                </tr>    
              </tbody>
            </table>








          <br><br><hr><br>

          <font size="3"><font color="#008044" size="3">å¸¸è¦‹Q&amp;Aï¼š</font><br><br>
            1ã€è¼¸å…¥è³½æ ¼é‡‰å¼æ™‚ï¼Œç‚ºä½•æœ‰æ™‚è·³å‡ºè¦–çª—ï¼Œè¦æ±‚æŸäº›æ°§åŒ–ç‰©æ•¸å€¼ä¸å¾—å°æ–¼æŸå€¼ï¼Ÿ<br>
            <font color="#008044" size="3">ç­”ï¼šKNaç”±é•·çŸ³æ‰€æä¾›ï¼Œä½†é•·çŸ³æä¾›KNaçš„åŒæ™‚ï¼Œä¹Ÿä¸€ä½µæä¾›Caã€Mgã€Alã€Siç­‰æˆåˆ†ï¼Œ<br>
            æ‰€ä»¥æ­¤æ™‚Caã€Mgã€Alã€Siçš„æ•¸é‡ä¸å¯å¤ªå°ã€‚<br>
            é€™å¦‚åŒç‰›è‚‰å¯æä¾›è›‹ç™½è³ªï¼Œå¯æ˜¯ç‰›è‚‰ä¹ŸåŒæ™‚å¦æä¾›é†£é¡ã€è„‚è‚ªç­‰æˆåˆ†ã€‚<br>
            åƒä¸€å£ç‰›è‚‰ç²å¾—è›‹ç™½è³ªçš„åŒæ™‚ï¼Œä¸å¾—è¦æ±‚é†£é¡ã€è„‚è‚ªç‚º0ã€‚<br>
            é‡æ­¤æƒ…æ³ï¼Œè«‹é©ç•¶æé«˜Caã€Mgã€Alã€Siç­‰æ•¸å€¼ï¼Œæˆ–é™ä½KNaæ•¸å€¼ã€‚<br>
            </font>
            <br>
            2ã€è¼¸å…¥ç™¾åˆ†æ¯”å¾Œï¼ŒæŒ‰"â†â†"éµï¼Œå†æŒ‰"â†’â†’"éµï¼Œå»å¾—ä¸åŒåˆ°ç™¾åˆ†æ¯”æ•¸å€¼ï¼Ÿ<br>
            <font color="#008044" size="3">ç­”ï¼šåŸå› æœ‰å…©å€‹ï¼š<br>
            a.æ‚¨è¼¸å…¥çš„ç™¾åˆ†æ¯”ç¸½å’Œä¸æ˜¯100ã€‚æœ¬ç¨‹å¼æœƒè‡ªå‹•å°‡ç¸½å’Œèª¿ç‚º100ï¼Œ
            <br>å› æ­¤ï¼Œæ¯ä¸€ç¨®åŸæ–™é‡é‡å·²è¢«"ç­‰æ¯”ä¾‹"èª¿æ•´ï¼Œä½¿å®ƒå€‘é‡é‡åŠ èµ·ä¾†ç‚º100å…‹ã€‚<br>
            b.æä¾›é‚çš„åŸæ–™æœ‰ä¸‰ç¨®ï¼šç™½é›²çŸ³ã€æ»‘çŸ³ã€ç¢³é…¸é‚ã€‚é¸ç”¨ä¸åŒåŸæ–™ï¼Œç®—å‡ºä¾†çš„ç™¾åˆ†æ¯”ç•¶ç„¶ä¸åŒã€‚
            <br>ä¸éï¼Œé›–ç„¶å®ƒå€‘ç™¾åˆ†æ¯”é‡‰å¼ä¸åŒï¼Œä½†ä»–å€‘æœ‰ç›¸åŒçš„è³½æ ¼é‡‰å¼ã€‚
            <br>(ç†è«–ä¸Šï¼Œä¸€å€‹è³½æ ¼é‡‰å¼ï¼Œå¯ä»¥ç®—å¾—ç„¡æ•¸ç¨®çš„ç™¾åˆ†æ¯”é‡‰å¼ã€‚)<br></font>
            <br>
            3ã€ç‚ºä½•ç„¡éµã€éŠ….....ç­‰è‘—è‰²åŠ‘ï¼Ÿä¹Ÿæ²’æœ‰åœŸç°ã€ç†”å¡Šã€ç¡¬ç¡¼é…¸éˆ£ã€çš‚åœŸã€çƒåœŸã€è˜‡æ‰“ã€.....ï¼Ÿ<br>
            <font color="#008044" size="3">ç­”ï¼šè‘—è‰²åŠ‘ç‚ºå¤–åŠ æˆåˆ†ï¼Œä¸åŒ…å«åœ¨é‡‰å¼ä¸­ã€‚åŒæ¨£çš„ï¼Œè¡¨æ ¼ä¸­æ²’æœ‰çš„æˆåˆ†ä¸€å¾‹ç•¶æˆå¤–åŠ ã€‚<br>
            é›–ç„¶è³½æ ¼é‡‰å¼ä¸é¡¯ç¤ºé€™äº›æ°§åŒ–ç‰©ï¼Œä½†ä¸¦ä¸å½±éŸ¿å°æ–¼é‡‰è—¥çš„åˆ¤è®€ã€‚<br></font>
            <br>
            4ã€ç¯„ä¾‹å…±æœ‰å¹¾å€‹é…æ–¹ï¼Ÿç‡’å¹¾åº¦ï¼Ÿå¯æ­£å¸¸ä½¿ç”¨ï¼Ÿ<br>
            <font color="#008044" size="3">ç­”ï¼šä¾ç…§æ’åˆ—çµ„åˆè¨ˆç®—ï¼Œç¯„ä¾‹è‡³å°‘æœ‰æ•¸å„„å€‹ä»¥ä¸Šï¼Œé€™äº›éƒ½æ˜¯ç‡’1230åº¦çš„é…æ–¹ã€‚<br>
            å¿«é€Ÿé¡¯ç¤ºçš„é…æ–¹ï¼Œç‚ºéš¨æ©Ÿå‡ºç¾ï¼Œéš¨æ™‚æŒ‰ä¸‹æš«åœå³å¯ä½¿ç”¨ï¼Œé…æ–¹ä¸æœƒé‡è¤‡ã€‚<br>
            95%ä»¥ä¸Šç‡’å‡ºä¾†éƒ½æ˜¯æ­£å¸¸çš„é‡‰é¢ï¼Œé™¤éçª¯æº«å·®å¤ªå¤šã€‚<br></font>
            <br><br>

            ç›£è£½ï¼š<a href="mailto:vesta_huang@yahoo.com.tw">é»ƒç‰è‹±</a> vesta_huang@yahoo.com.tw<br>
            è¨­è¨ˆäººï¼š<a href="mailto:yuhyin.tw@yahoo.com.tw">é‚±è‚²æ°‘</a> yuhyin.tw@yahoo.com.tw<br>
            å°Šé‡æ™ºæ…§è²¡ç”¢ï¼Œè«‹å‹¿éš¨æ„è¤‡è£½ï¼Œæˆ–ä¿®æ”¹ã€‚<br><br>

            <hr>
            <center>
              <br>
              <font color="#a52a2a" size="5"><a href="https://www.facebook.com/%E9%BB%83%E7%8E%89%E8%8B%B1-%E9%99%B6%E8%97%9D%E7%90%89%E7%92%83-261133624087947/">ç²‰çµ²å°ˆé æœ‰æ›´å¤šåœ–ç‰‡å–”ï¼</a></font>
              <br>
              <input type="text" id="urlLengthBox" value="" readonly="">
              <br><br><br><br><br><br>
            </center>
          </font>
        </font></center><font size="3">
      
  


</font></form>

</body>

</html>